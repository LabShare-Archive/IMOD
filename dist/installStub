#!/bin/tcsh -f
#
# Stub for self-extracting IMOD installer
# Options are -extract to extract archive and installer without installing
#             -test to go through whole script without installing
#

set installer = installIMOD
set this = "$0"
set rootname = "$this:t"
set packname = $rootname:r.tar.gz
set tempdir = IMODtempDir
set installdir = ""
set custom = 0

# Find the end of this script
#
set stubline = `awk '/END OF STUB/ {if (gotit > 0) {print NR ; exit} else { gotit = 1}}' "$this"`
if ($stubline == "" || $#stubline > 1) then
    echo "Could not find package in this file!"
    exit 1
endif

@ skip = $stubline
@ skip++

set extract = 0
set test = 0
while ($#argv > 0)
    switch ($argv[1])
        case -ex*:
            set extract = 1
            shift
            breaksw

        case -test:
            set test = 1
            shift
            breaksw

        case -d*:
            set installdir = $argv[2]
            shift ; shift
            breaksw

        default:
            echo "Illegal option $argv[1]"
            exit 1
    endsw
end


set sysfiles = ()

# DUPLICATION ALERT: THE FOLLOWING IS COPIED FROM installIMOD
#
set system = `uname -s`
set defaultdir = /usr/local

switch ($system)
    case *IRIX*:
        set os = irix
        # leave out /etc/profile because it is more likely used by sh than
        # bash users
        set scripts = (sgi.cshrc)
        set sysfiles = (/etc/cshrc)
        breaksw
    case *Linux*:
        set os = linux
        set scripts = (IMOD-linux.csh IMOD-linux.sh)
        breaksw
    case *CYGWIN*:
        set os = windows
        set scripts = (IMOD-cygwin.csh IMOD-cygwin.sh)
        breaksw
    case *Darwin*:
        set os = osx
        set defaultdir = /Applications
        set scripts = (mac.cshrc mac.bashrc)
        set sysfiles = (/etc/csh.login /etc/profile)
        breaksw

    default:
        if ($extract == 1) breaksw
        echo "IMOD will not run on this system ($system)"
        echo "You can add the option -extract to just extract the tar file"
        exit 1

endsw

if ("$installdir" == "") set installdir = $defaultdir
if ("$installdir" != "$defaultdir") set custom = 1
if ($os == windows && $custom == 1) then
    echo "You can not set the install directory on Windows"
    exit 1
endif

if ($extract == 0) then
    echo ""
    echo "This script will install IMOD in $installdir and rename"
    echo "any previous version, or remove another copy of this version."
    echo ""
    if ($#sysfiles == 0) then
        echo "It will copy $scripts[1] and $scripts[2] to /etc/profile.d"
    else
        echo -n "It will edit $sysfiles[1]"
        if ($#sysfiles == 2) then
            echo -n " and $sysfiles[2]"
        endif
        echo " to source a startup script"
        echo " in $installdir/IMOD unless they already appear to do so"
    endif
    
    if ($os != windows && $custom == 0) then 
        echo ""
        echo "Your can add the option -dir install_dir to install to install_dir"
        echo "instead of to $installdir (enter a full, absolute path for install_dir)"
    endif
    echo ""
    echo "You can add the option -extract to just extract the tar file and not install"
    echo ""
    echo -n "Enter Y if you want to proceed: "
    set yesno = $<
    if ("$yesno" != "Y" && "$yesno" != "y") exit 0
endif

mkdir -p $tempdir    

echo "Extracting $packname ..."
tail -n +$skip "$this" >! $tempdir/$packname

set version = `echo $rootname | sed '/\(imod_[0-9.]*\).*/s//\1/' | sed '/\.$/s///'`

cd $tempdir

echo "Extracting $installer"

if ($os != irix) then
    tar xzf $packname $version/$installer
else
    gzcat $packname | tar xf - $version/$installer
endif

if (! -e $version/$installer) then
    echo "Could not extract $installer"
    exit 1
endif

\mv $version/$installer .
rmdir $version

if ($extract == 1) then
    echo "Left $packname and $installer in $tempdir"
    exit 0
endif

# It has to be run by tcsh for Irix; there is some bug in csh

if ($test == 0) tcsh $installer -d $installdir $packname

echo " "
echo "Cleaning up $packname and $installer"
\rm $installer $packname
cd ..
rmdir $tempdir

exit 0

#  $Author$
#
#  $Date$
#
#  $Revision$
#
#  $Log$
#  Revision 3.9  2005/01/10 16:30:47  mast
#  Added option to install elsewhere
#
#  Revision 3.8  2004/08/24 18:46:42  mast
#  Switched from 'tail +#' to 'tail -n +#' due to problem on some Linux
#
#  Revision 3.7  2004/07/04 14:27:11  mast
#  Fixed a problem on Mac
#
#  Revision 3.6  2004/07/04 13:47:31  mast
#  Added details for user and made it work with spaces in directory path
#
#  Revision 3.5  2004/04/24 18:07:21  mast
#  Even better awk command stops when it finds end
#
#  Revision 3.4  2004/04/24 17:41:12  mast
#  Used awk instead of repeated head - tails to find end of script
#
#  Revision 3.3  2004/04/24 04:32:27  mast
#  Fixes for SGI
#
#  Revision 3.2  2004/04/24 03:04:50  mast
#  Add a blank line and use \mv
#
#  Revision 3.1  2004/04/24 01:03:32  mast
#  Initial creation
#

END OF STUB
