Version = 1.2

[function = main]
[[if = run_sirt]]
  run.function.sirt=
[[]]
run.function.tilt=
if.var.build.bn.done=
if.var.build.return=
bn.done=


[function = assert-variable-tilt-values]
[[if = patch-tracking]]
  assert.tf.tomogram-thickness-in-z=%{tomogram-thickness-in-z-patch-tracking}
    assert.tf.x-axis-tilt=%{x-axis-tilt-patch-tracking}
[[]]
[[ifnot = patch-tracking]]
  assert.tf.tomogram-thickness-in-z=%{tomogram-thickness-in-z}
    assert.tf.x-axis-tilt=%{x-axis-tilt}
[[]]


[function = tilt]
# Different name output file with single axis:  dataset_full.rec
set.var.tomo-ext=
if.var.single.set.var.tomo-ext=_full
mb.tilt=+
[[if = test-gui]]
	# check values
	assert.rb.back-projection=on
	assert.rb.sirt=off
	assert.cb.parallel-processing=on
	assert.cb.take-logarithm-of-densities-with-offset=on
	assert.tf.take-logarithm-of-densities-with-offset=0.0
	run.function.assert-variable-tilt-values=
	assert.tf.radial-filter-cutoff=0.35
	assert.tf.falloff=0.05
	assert.cb.use-local-alignments=on
	assert.cb.use-z-factors=on
	assert.bn.generate-tomogram=off
	mb.tilt.1=A
	assert.tf.logarithm-density-scaling-factor=%{output-density-scaling-factor}
	assert.tf.offset=0.0
	assert.tf.linear-density-scaling-factor=1.0
	assert.tf.offset.1=0.0
	assert.tf.tomogram-width-in-x=
	assert.tf.first-slice=
	assert.tf.last-slice=
	assert.tf.slice-step-in-y=
	assert.tf.x-shift=0.0
	assert.tf.z-shift=0.0
	assert.tf.tilt-angle-offset=0.0
	assert.tf.extra-views-to-exclude=
	mb.tilt.1=B
	# check enabled/disabled
	assert.enabled.cb.parallel-processing=
	assert.enabled.cb.take-logarithm-of-densities-with-offset=
	assert.enabled.tf.take-logarithm-of-densities-with-offset=
	assert.enabled.tf.tomogram-thickness-in-z=
	assert.enabled.tf.x-axis-tilt=
	assert.enabled.tf.radial-filter-cutoff=
	assert.enabled.tf.falloff=
	assert.enabled.cb.use-local-alignments=
	assert.enabled.cb.use-z-factors=
	assert.enabled.bn.generate-tomogram=
	assert.enabled.bn.view-tomogram-in-3dmod=
	assert.enabled.bn.delete-intermediate-image-stacks=
	mb.tilt.1=A
	assert.enabled.tf.logarithm-density-scaling-factor=
	assert.enabled.tf.offset=
	assert.disabled.tf.linear-density-scaling-factor=
	assert.disabled.tf.offset.1=
	assert.enabled.tf.tomogram-width-in-x=
	assert.enabled.tf.first-slice=
	assert.enabled.tf.last-slice=
	assert.enabled.tf.slice-step-in-y=
	assert.enabled.tf.x-shift=
	assert.enabled.tf.z-shift=
	assert.enabled.tf.tilt-angle-offset=
	assert.enabled.tf.extra-views-to-exclude=
	mb.tilt.1=B
	#check behavior
	cb.take-logarithm-of-densities-with-offset=off
	assert.disabled.tf.take-logarithm-of-densities-with-offset=
	mb.tilt.1=A
	assert.disabled.tf.logarithm-density-scaling-factor=
	assert.disabled.tf.offset=
	assert.enabled.tf.linear-density-scaling-factor=
	assert.enabled.tf.offset.1=
	mb.tilt.1=B
	cb.take-logarithm-of-densities-with-offset=on
	assert.enabled.tf.take-logarithm-of-densities-with-offset=
	mb.tilt.1=A
	assert.enabled.tf.logarithm-density-scaling-factor=
	assert.enabled.tf.offset=
	assert.disabled.tf.linear-density-scaling-factor=
	assert.disabled.tf.offset.1=
	mb.tilt.1=B
[[]]
# test trial tilt
run.function.trial-tilt=
run.function.setup-patch-tracking=
# run with parallel processing
cb.parallel-processing=on
bn.generate-tomogram=
wait.process.processchunks-tilt%{axis}=done
if.var.build.return=
# check files
assert.exists.file=tilt%{axis}.com
assert.exists.file=tilt%{axis}-start.com
assert.exists.file=tilt%{axis}-finish.com
assert.exists.file=tilt%{axis}.log
assert.exists.file=tilt%{axis}-start.log
assert.exists.file=tilt%{axis}-finish.log
assert.exists.file=processchunks%{axis}.csh
assert.exists.file=processchunks%{axis}.out
assert.exists.file=%{dataset}%{tomo-ext}%{axis}.rec
# check comscript
[[ifnot = fidless]]
	run.function.same-file=
[[]]
# run again without parallel processing
cb.parallel-processing=off
bn.generate-tomogram=
wait.process.calculating-tomogram=done
# check files
assert.exists.file=tilt%{axis}.log~
assert.exists.file=%{dataset}%{tomo-ext}%{axis}.rec~
assert.exists.file=tilt%{axis}.com
assert.exists.file=tilt%{axis}.log
assert.exists.file=%{dataset}%{tomo-ext}%{axis}.rec
# run again without parallel processing
bn.generate-tomogram=
wait.process.calculating-tomogram=done
# check files
assert.exists.file=tilt%{axis}.log~
assert.exists.file=%{dataset}%{tomo-ext}%{axis}.rec~
assert.exists.file=tilt%{axis}.com
assert.exists.file=tilt%{axis}.log
assert.exists.file=%{dataset}%{tomo-ext}%{axis}.rec
# run agains with parallel processing
cb.parallel-processing=on
bn.generate-tomogram=
wait.process.processchunks-tilt%{axis}=done
# check files
assert.exists.file=tilt%{axis}.log~
assert.exists.file=processchunks%{axis}.out~
assert.exists.file=%{dataset}%{tomo-ext}%{axis}.rec~
assert.exists.file=tilt%{axis}.com
assert.exists.file=tilt%{axis}-start.com
assert.exists.file=tilt%{axis}-finish.com
assert.exists.file=tilt%{axis}.log
assert.exists.file=tilt%{axis}-start.log
assert.exists.file=tilt%{axis}-finish.log
assert.exists.file=processchunks%{axis}.csh
assert.exists.file=processchunks%{axis}.out
assert.exists.file=%{dataset}%{tomo-ext}%{axis}.rec
# run 3dmod
bn.view-tomogram-in-3dmod=
# check values
assert.bn.generate-tomogram=on
# clean up
bn.delete-intermediate-image-stacks=


[function = setup-patch-tracking]
if.not.var.patch-tracking.return=
if.equals.var.dataset.return=BB
tf.tomogram-thickness-in-z=%{tomogram-thickness-in-z-patch-tracking}

[function = same-file]
[[ifnot = simple-align]]
	if.not.var.patch-tracking.assert.same.file=tilt%{axis}.com
[[]]


[function = trial-tilt]
if.var.build.return=
mb.tilt.1=A
mb.trial-tilt=+
[[if = test-gui]]
	# check values
	assert.cbb.trial-tomogram-filename=
	# check enabled/disabled
	assert.enabled.cbb.trial-tomogram-filename=
	assert.enabled.bn.generate-trial-tomogram=
	assert.enabled.bn.view-trial-in-3dmod=
	assert.enabled.bn.use-current-trial-tomogram=
[[]]
# run with parallel processing
cb.parallel-processing=on
mb.parallel-processing=-
cbb.trial-tomogram-filename=trial%{axis}
bn.generate-trial-tomogram=
wait.process.processchunks-tilt%{axis}=done
# check files
assert.exists.file=tilt%{axis}.com
assert.exists.file=tilt%{axis}-start.com
assert.exists.file=tilt%{axis}-finish.com
assert.exists.file=tilt%{axis}.log
assert.exists.file=tilt%{axis}-start.log
assert.exists.file=tilt%{axis}-finish.log
assert.exists.file=processchunks%{axis}.csh
assert.exists.file=processchunks%{axis}.out
assert.exists.file=trial%{axis}
# run again without parallel processing
cb.parallel-processing=off
bn.generate-trial-tomogram=
wait.process.calculating-tomogram=done
# check files
assert.exists.file=tilt%{axis}.log~
assert.exists.file=trial%{axis}~
assert.exists.file=tilt%{axis}.com
assert.exists.file=tilt%{axis}.log
assert.exists.file=trial%{axis}
# run again without parallel processing
bn.generate-trial-tomogram=
wait.process.calculating-tomogram=done
# check files
assert.exists.file=tilt%{axis}.log~
assert.exists.file=trial%{axis}~
assert.exists.file=tilt%{axis}.com
assert.exists.file=tilt%{axis}.log
assert.exists.file=trial%{axis}
# run again with parallel processing
cb.parallel-processing=on
bn.generate-trial-tomogram=
wait.process.processchunks-tilt%{axis}=done
# check files
assert.exists.file=tilt%{axis}.log~
assert.exists.file=processchunks%{axis}.out~
assert.exists.file=trial%{axis}~
assert.exists.file=tilt%{axis}.com
assert.exists.file=tilt%{axis}-start.com
assert.exists.file=tilt%{axis}-finish.com
assert.exists.file=tilt%{axis}.log
assert.exists.file=tilt%{axis}-start.log
assert.exists.file=tilt%{axis}-finish.log
assert.exists.file=processchunks%{axis}.csh
assert.exists.file=processchunks%{axis}.out
assert.exists.file=trial%{axis}
# run 3dmod
bn.view-trial-in-3dmod=
# use
bn.use-current-trial-tomogram=
# check files
assert.not-exists.file=trial%{axis}
assert.exists.file=%{dataset}%{tomo-ext}%{axis}.rec
# check values
assert.bn.use-current-trial-tomogram=on
#
mb.trial-tilt=-
mb.tilt.1=B
mb.parallel-processing=+


[function = sirt]
rb.sirt=
mb.tilt=-
[[if = test-gui]]
  # check values
  assert.cb.reconstruct-subarea=off
  assert.tf.size-in-x-and-y=
  assert.tf.offset-in-y=
  assert.tf.radial-filter-cutoff=0.4
  assert.tf.falloff=0.05
  assert.tf.iteration-#'s-to-retain=
  assert.cb.scale-retained-volumes-to-integers=off
  assert.cb.delete-existing-reconstructions-after-starting-point=off
  assert.rb.start-from-beginning=on
  assert.rb.resume-from-last-iteration=off
  assert.rb.go-back,-resume-from-iteration=off
  assert.cbb.go-back,-resume-from-iteration=
  assert.bn.run-sirt=off
  assert.bn.use-sirt-output-file=off
  mb.sirt.1=A
  assert.tf.flat-filter-fraction=
  mb.sirt.1=B
  # check enabled/disabled
  assert.enabled.cb.reconstruct-subarea=
  assert.disabled.tf.size-in-x-and-y=
  assert.disabled.tf.offset-in-y=
  assert.enabled.tf.radial-filter-cutoff=
  assert.enabled.tf.falloff=
  assert.enabled.tf.iteration-#'s-to-retain=
  assert.enabled.cb.scale-retained-volumes-to-integers=
  assert.enabled.cb.delete-existing-reconstructions-after-starting-point=
  assert.enabled.rb.start-from-beginning=
  assert.disabled.rb.resume-from-last-iteration=
  assert.disabled.rb.go-back,-resume-from-iteration=
  assert.disabled.cbb.go-back,-resume-from-iteration=
  assert.enabled.bn.run-sirt=
  assert.enabled.bn.view-tomogram-in-3dmod=
  assert.enabled.bn.use-sirt-output-file=
  mb.sirt.1=A
  assert.enabled.tf.flat-filter-fraction=
  mb.sirt.1=B
  #
  cb.reconstruct-subarea=on
  assert.enabled.tf.size-in-x-and-y=
  assert.enabled.tf.offset-in-y=
  assert.disabled.rb.resume-from-last-iteration=
  assert.disabled.rb.go-back,-resume-from-iteration=
  cb.reconstruct-subarea=off
[[]]
mb.tilt=+
if.enabled.cb.use-the-gpu.run.function.turn-on-use-the-gpu=
mb.tilt=-
# tilt
[[if = montage]]
  mb.tilt=+
  # assuming they are on - turning them off
  if.enabled.cb.use-local-alignments.run.function.change-use-local-alignments=
  if.enabled.cb.use-z-factors.run.function.change-use-z-factors=
  mb.tilt=-
[[]]
# subarea
[[if = montage]]
  cb.reconstruct-subarea=on
  tf.size-in-x-and-y=256,256
[[]]
[[if = simple-align]]
  cb.reconstruct-subarea=on
  tf.size-in-x-and-y=256,256
[[]]
# SIRT
tf.iteration-#'s-to-retain=2,4
cb.scale-retained-volumes-to-integers=on
bn.run-sirt=
wait.process.processchunks-tilt%{axis}_sirt=done
cb.scale-retained-volumes-to-integers=off
tf.iteration-#'s-to-retain=6,8
rb.resume-from-last-iteration=
bn.run-sirt=
wait.process.processchunks-tilt%{axis}_sirt=done
tf.iteration-#'s-to-retain=7
rb.go-back,-resume-from-iteration=
[[if = test-gui]]
  assert.enabled.cbb.go-back,-resume-from-iteration=
  mb.tilt=+
  mb.tilt.1=A  
  assert.disabled.cb.take-logarithm-of-densities-with-offset=
  assert.disabled.tf.logarithm-density-scaling-factor=
  assert.disabled.tf.offset=
  assert.disabled.tf.linear-density-scaling-factor=
  assert.disabled.tf.offset.1=
  assert.disabled.tf.tomogram-thickness-in-z=
  assert.disabled.tf.z-shift=
  assert.disabled.tf.x-axis-tilt=
  assert.disabled.tf.tilt-angle-offset=
  assert.disabled.tf.extra-views-to-exclude=
  assert.disabled.cb.use-local-alignments=
  assert.disabled.cb.use-z-factors=
  mb.tilt.1=B
  mb.tilt=-
[[]]
bn.run-sirt=
wait.process.processchunks-tilt%{axis}_sirt=done
rb.start-from-beginning=
cb.delete-existing-reconstructions-after-starting-point=on
tf.iteration-#'s-to-retain=1
bn.run-sirt=
wait.process.processchunks-tilt%{axis}_sirt=done
[[if = test-gui]]
  assert.cbb.go-back,-resume-from-iteration=1
[[]]
bn.view-tomogram-in-3dmod=
bn.use-sirt-output-file=
wait.popup.etomo-question=Yes
# put things back the way they where for tilt
mb.tilt=+
cb.use-the-gpu=off
[[if = montage]]
  if.enabled.cb.use-local-alignments.run.function.change-use-local-alignments=
  if.enabled.cb.use-z-factors.run.function.change-use-z-factors=
[[]]
mb.tilt=-
rb.back-projection=


[function = turn-on-use-the-gpu]
cb.use-the-gpu=on


[function = change-use-local-alignments]
cb.use-local-alignments=


[function = change-use-z-factors]
cb.use-z-factors=