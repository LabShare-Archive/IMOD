Version = 1.2

[function = main]
if.var.quick.run.function.quick=
if.var.quick.return=
run.function.fiducial-model-generation=
bn.done=


[function = quick]
[[ifnot = patch-tracking]]
  run.function.transfer-fiducials-quick=
[[]]
if.equals.var.axis.return=b
[[ifnot = patch-tracking]]
  copy.file=%{dataset}%{axis}.seed
  bn.track-seed-model=
  wait.process.tracking-fiducials=done
  copy.file=%{dataset}%{axis}.fid
[[]]
[[if = patch-tracking]]
  tf.size-of-patches=200,200
  cb.use-boundary-model=
  copy.file=%{dataset}%{axis}_ptbound.mod
  bn.track-patches=
  wait.process.cross-correlating-stack=done
[[]]
bn.done=


[function = transfer-fiducials-quick]
if.not-equals.var.axis.return = b
bn.transfer-fiducials-from-other-axis =
wait.process.transferring-fiducials = done
bn.done=


[function = fiducial-model-generation]
rb.use-patch-tracking-to-make-fiducial-model=
run.function.patch-tracking=
if.var.patch-tracking.return=
set.var.seed-button=view-seed-model
[[if = axis]]
	if.equals.var.axis.return=b
	if.exists.rb.run-raptor-and-fix.run.function.run-raptor=
	set.var.seed-button=seed-fiducial-model
	return.var.seed-button=
[[]]
rb.make-seed-and-track=
run.function.transfer-fiducials=
[[if = test-gui]]
	#test values
	assert.bn.%{seed-button}=off
	#test enabled/disabled
	assert.enabled.bn.%{seed-button}=
[[]]
bn.%{seed-button}=
[[if = axis]]
  if.equals.var.axis.return=b
  copy.file=%{dataset}%{axis}.seed
[[]]
[[if = test-gui]]
	#test values
	assert.bn.%{seed-button}=on
[[]]
run.function.beadtracker=


[function = transfer-fiducials]
if.not-equals.var.axis.return = b
rb.make-seed-and-track=
mb.transfer-fiducials=+
[[if = test-gui]]
	#Test values
	assert.cb.run-midas=off
	assert.bn.transfer-fiducials-from-other-axis=off
	#advanced
	mb.transfer-fiducials.1=A
	assert.tf.center-view-a=
	assert.tf.center-view-b=
	assert.tf.number-of-views-in-the-search=5
	assert.rb.both-directions=on
	assert.rb.+90-only=off
	assert.rb.-90-only=off
	assert.cb.mirror-one-image-around-the-x-axis=off
	#basic
	mb.transfer-fiducials.1=B
	#Test enabled/disabled
	assert.enabled.cb.run-midas=
	assert.enabled.bn.transfer-fiducials-from-other-axis=
	#advanced
	mb.transfer-fiducials.1=A
	assert.enabled.tf.center-view-a=
	assert.enabled.tf.center-view-b=
	assert.enabled.tf.number-of-views-in-the-search=
	assert.enabled.rb.both-directions=
	assert.enabled.rb.+90-only=
	assert.enabled.rb.-90-only=
	assert.enabled.cb.mirror-one-image-around-the-x-axis=
	#basic
	mb.transfer-fiducials.1=B
[[]]
bn.transfer-fiducials-from-other-axis =
wait.process.transferring-fiducials = done
assert.exists.file=transferfid.log
assert.exists.file=transferfid.coord
assert.exists.file=%{dataset}%{axis}.seed


[function = beadtracker]
mb.beadtracker=+
[[if = test-gui]]
	#Test values
	assert.tf.view-skip-list=
	assert.tf.separate-view-groups=
	assert.cb.fill-seed-model-gaps=on
	assert.cb.local-tracking=off
	assert.tf.local-area-size=1000
	assert.tf.max-#-views-to-include-in-align=
	assert.bn.track-seed-model=off
	assert.bn.fix-fiducial-model=off
	#advanced
	mb.beadtracker.1=A
	assert.tf.tilt-angle-group-size=7
	assert.tf.non-default-tilt-angle-groups=
	assert.tf.magnification-group-size=5
	assert.tf.non-default-magnification-groups=
	assert.tf.minimum-#-of-views-for-tilt-alignment=4
	assert.tf.unbinned-bead-diameter=%{unbinned-bead-diameter}
	assert.cb.light-fiducial-markers=off
	assert.tf.maximum-gap-size=5
	assert.tf.minimum-beads-in-area=8
	assert.tf.minimum-beads-overlapping=5
	assert.tf.rounds-of-tracking=2
	assert.tf.minimum-tilt-range-for-finding-axis=10.0
	assert.tf.minimum-tilt-range-for-finding-angles=20.0
	assert.tf.search-box-size=%{search-box-size}
	#basic
	mb.beadtracker.1=B
	#Test enabled/disabled
	assert.enabled.tf.view-skip-list=
	assert.enabled.tf.separate-view-groups=
	assert.enabled.cb.fill-seed-model-gaps=
	assert.enabled.cb.local-tracking=
	assert.disabled.tf.local-area-size=
	assert.enabled.tf.max-#-views-to-include-in-align=
	assert.enabled.bn.track-seed-model=
	assert.enabled.bn.fix-fiducial-model=
	#advanced
	mb.beadtracker.1=A
	assert.enabled.tf.tilt-angle-group-size=
	assert.enabled.tf.non-default-tilt-angle-groups=
	assert.enabled.tf.magnification-group-size=
	assert.enabled.tf.non-default-magnification-groups=
	assert.enabled.tf.minimum-#-of-views-for-tilt-alignment=
	assert.enabled.tf.unbinned-bead-diameter=
	assert.enabled.cb.light-fiducial-markers=
	assert.enabled.tf.maximum-gap-size=
	assert.disabled.tf.minimum-beads-in-area=
	assert.disabled.tf.minimum-beads-overlapping=
	assert.enabled.tf.rounds-of-tracking=
	assert.enabled.tf.minimum-tilt-range-for-finding-axis=
	assert.enabled.tf.minimum-tilt-range-for-finding-angles=
	assert.enabled.tf.search-box-size=
	#basic
	mb.beadtracker.1=B
	#Test behavior
	cb.local-tracking=on
	mb.beadtracker.1=A
	assert.enabled.tf.local-area-size=
	assert.enabled.tf.minimum-beads-in-area=
	assert.enabled.tf.minimum-beads-overlapping=
	cb.local-tracking=off
	assert.disabled.tf.local-area-size=
	assert.disabled.tf.minimum-beads-in-area=
	assert.disabled.tf.minimum-beads-overlapping=
	mb.beadtracker.1=B
[[]]
run.function.expert-parameters=
bn.track-seed-model=
wait.process.tracking-fiducials=done
assert.exists.file=track%{axis}.com
assert.exists.file=track%{axis}.log
assert.exists.file=%{dataset}%{axis}.fid
bn.track-seed-model=
wait.process.tracking-fiducials=done
assert.exists.file=track%{axis}.log~
assert.exists.file=%{dataset}%{axis}.fid~
bn.track-with-fiducial-model-as-seed=
wait.process.tracking-fiducials=done
assert.exists.file=track%{axis}.com
assert.exists.file=track%{axis}.log
assert.exists.file=%{dataset}%{axis}.fid
bn.track-with-fiducial-model-as-seed=
wait.process.tracking-fiducials=done
assert.exists.file=track%{axis}.log~
bn.fix-fiducial-model=
sleep=
copy.file=%{dataset}%{axis}.fid
[[if = test-gui]]
	#Test after run
	assert.bn.track-seed-model=on
	assert.bn.track-with-fiducial-model-as-seed=on
[[]]


[function = expert-parameters]
[[if = dual]]
	mb.transfer-fiducials=-
[[]]
mb.beadtracker.1=A
mb.expert-parameters=+
[[if = test-gui]]
	#Test values
	assert.tf.maximum-#-of-views-for-fiducial-avg=4
	assert.tf.fiducial-extrapolation-limits=7,3
	assert.tf.rescue-attempt-criteria=0.6,1.0
	assert.tf.distance-criterion-for-rescue=10.0
	assert.tf.rescue-relaxation-factors=0.7,0.9
	assert.tf.first-pass-residual-limit-for-deletion=2.5
	assert.tf.second-pass-density-relaxation=0.9
	assert.tf.second-pass-maximum-rescue-distance=2.5
	assert.tf.residual-change-limits=9,5
	assert.tf.deletion-residual-parameters=0.04,2.0
	#Test enabled/disabled
	assert.enabled.tf.maximum-#-of-views-for-fiducial-avg=
	assert.enabled.tf.fiducial-extrapolation-limits=
	assert.enabled.tf.rescue-attempt-criteria=
	assert.enabled.tf.distance-criterion-for-rescue=
	assert.enabled.tf.rescue-relaxation-factors=
	assert.enabled.tf.first-pass-residual-limit-for-deletion=
	assert.enabled.tf.second-pass-density-relaxation=
	assert.enabled.tf.second-pass-maximum-rescue-distance=
	assert.enabled.tf.residual-change-limits=
	assert.enabled.tf.deletion-residual-parameters=
[[]]
mb.expert-parameters=-
mb.beadtracker.1=B
[[if = dual]]
	mb.transfer-fiducials=+
[[]]


[function = patch-tracking]
[[if = test-gui]]
	#Test values
	assert.tf.size-of-patches=
	assert.cb.use-boundary-model=off
	assert.sp.iterations-to-increase-subpixel-accuracy=1
	assert.cb.break-contours-into-pieces=off
	assert.tf.break-contours-into-pieces=16,4
	assert.tf.pixels-to-trim=%{pixels-to-trim}
	assert.tf.x-axis-min=
	assert.tf.max=
	assert.tf.y-axis-min=
	assert.tf.max.1=
	assert.bn.track-patches=off
	bn.advanced=
	assert.tf.limits-on-shifts-from-correlation=
	assert.tf.tilt-angle-offset=
	assert.tf.low-frequency-rolloff-sigma=0.03
	assert.tf.high-frequency-cutoff-radius=0.25
	assert.tf.high-frequency-rolloff-sigma=0.05
	assert.tf.pixels-to-pad=
	assert.tf.pixels-to-taper=
	assert.tf.test-output=
	assert.tf.view-range=
	assert.tf.views-to-skip=
	bn.basic=
	#Test enabled/disabled
	assert.enabled.tf.size-of-patches=
	assert.enabled.cb.use-boundary-model=
	assert.disabled.bn.create-boundary-model=
	assert.enabled.sp.iterations-to-increase-subpixel-accuracy=
	assert.enabled.cb.break-contours-into-pieces=
	assert.disabled.tf.break-contours-into-pieces=
	assert.enabled.tf.pixels-to-trim=
	assert.enabled.tf.x-axis-min=
	assert.enabled.tf.max=
	assert.enabled.tf.y-axis-min=
	assert.enabled.tf.max.1=
	assert.enabled.bn.track-patches=
	assert.enabled.bn.open-tracked-patches=
	bn.advanced=
	assert.enabled.tf.limits-on-shifts-from-correlation=
	assert.enabled.tf.tilt-angle-offset=
	assert.enabled.tf.low-frequency-rolloff-sigma=
	assert.enabled.tf.high-frequency-cutoff-radius=
	assert.enabled.tf.high-frequency-rolloff-sigma=
	assert.enabled.tf.pixels-to-pad=
	assert.enabled.tf.pixels-to-taper=
	assert.enabled.tf.test-output=
	assert.enabled.tf.view-range=
	assert.enabled.tf.views-to-skip=
	bn.basic=
	#Test gui behavior
	#Boundary model
	cb.use-boundary-model=on
	assert.enabled.bn.create-boundary-model=
	cb.use-boundary-model=off
	assert.disabled.bn.create-boundary-model=
	#Break contour into pieces
	cb.break-contours-into-pieces=on
	assert.enabled.tf.break-contours-into-pieces=
	cb.break-contours-into-pieces=off
	assert.disabled.tf.break-contours-into-pieces=
[[]]
run.function.patch-layout=
#patch tracking is slow so avoid running if patch-tracking isn't set
if.not.var.patch-tracking.return=
#assuming that this is midzone2
tf.size-of-patches=200,200
cb.use-boundary-model=
copy.file=%{dataset}%{axis}_ptbound.mod
bn.create-boundary-model=
bn.track-patches=
wait.process.cross-correlating-stack=done
assert.exists.file=xcorr_pt%{axis}.com
assert.exists.file=xcorr%{axis}.com
assert.exists.file=xcorr_pt%{axis}.log
assert.exists.file=%{dataset}%{axis}.fid
sp.iterations-to-increase-subpixel-accuracy=2
bn.track-patches=
wait.process.cross-correlating-stack=done
assert.exists.file=xcorr_pt%{axis}.log~
assert.exists.file=%{dataset}%{axis}.fid~
#don't break contours for midzone2b (doesn't need it)
if.equals.var.axis.return=b
cb.break-contours-into-pieces=on
bn.track-patches=
wait.process.cross-correlating-stack=done
[[if = test-gui]]
  assert.contains.file=xcorr_pt.com|TiltFile*%{dataset}%{axis}.rawtlt
[[]]


[function = patch-layout]
[[if = test-gui]]
	#test values
	assert.rb.fractional-overlap-of-patches=on
	assert.tf.fractional-overlap-of-patches=.33,.33
	assert.rb.number-of-patches=off
	assert.tf.number-of-patches=
	#enabled/disabled
	assert.enabled.rb.fractional-overlap-of-patches=
	assert.enabled.tf.fractional-overlap-of-patches=
	assert.enabled.rb.number-of-patches=
	assert.disabled.tf.number-of-patches=
	#Test gui behavior
	rb.number-of-patches=
	assert.enabled.rb.fractional-overlap-of-patches=
	assert.disabled.tf.fractional-overlap-of-patches=
	assert.enabled.rb.number-of-patches=
	assert.enabled.tf.number-of-patches=
	rb.fractional-overlap-of-patches=
	assert.enabled.rb.fractional-overlap-of-patches=
	assert.enabled.tf.fractional-overlap-of-patches=
	assert.enabled.rb.number-of-patches=
	assert.disabled.tf.number-of-patches=
[[]]


[function = test-raptor-input]
[[if = test-gui]]
  #test values
  assert.rb.run-against-the-coarse-aligned-stack=on
  assert.rb.run-against-the-raw-stack=off
  #test enabled/disabled
  assert.enabled.rb.run-against-the-coarse-aligned-stack=
[[]]
[[ifnot = montage]]
  assert.enabled.rb.run-against-the-raw-stack=
[[]]
[[if = montage]]
  assert.disabled.rb.run-against-the-raw-stack=
[[]]


[function = run-raptor]
rb.run-raptor-and-fix=
run.function.test-raptor-input=
[[if = test-gui]]
	#test values
	assert.tf.#-of-beads-to-choose=
	assert.tf.unbinned-bead-diameter=%{int-unbinned-bead-diameter}
	assert.bn.run-raptor=off
	assert.bn.use-raptor-result-as-fiducial-model=off
	#test enabled/disabled
	assert.enabled.bn.open-stack-in-3dmod=
	assert.enabled.tf.#-of-beads-to-choose=
	assert.enabled.tf.unbinned-bead-diameter=
	assert.enabled.bn.run-raptor=
	assert.enabled.bn.open-raptor-model-in-3dmod=
	assert.enabled.bn.use-raptor-result-as-fiducial-model=
[[]]
if.not.var.run-raptor.return=
tf.#-of-beads-to-choose=%{#-of-beads-to-choose}
#run raptor against the raw stack
[[ifnot = montage]]
  # Montage raw stack cannot be used with RAPTOR
  # Run RAPTOR against raw stack
  rb.run-against-the-raw-stack=
[[]]
bn.run-raptor=
wait.process.running-runraptor=done
assert.exists.file=%{dataset}%{axis}_raptor.fid
assert.exists.file=raptor1
assert.exists.file=raptor1/align
assert.exists.file=raptor1/IMOD
assert.exists.file=raptor1/align/%{dataset}%{axis}_IMOD.log
assert.exists.file=raptor1/align/%{dataset}%{axis}_RAPTOR.log
assert.exists.file=raptor1/IMOD/%{dataset}%{axis}.fid.txt
assert.exists.file=raptor1/IMOD/%{dataset}%{axis}.rawtlt
#run raptor against the coarse aligned stack
bn.run-raptor=
wait.process.running-runraptor=done
assert.exists.file=%{dataset}%{axis}_raptor.fid~
assert.exists.file=raptor2
assert.exists.file=raptor2/align
assert.exists.file=raptor2/IMOD
assert.exists.file=raptor2/align/%{dataset}%{axis}_IMOD.log
assert.exists.file=raptor2/align/%{dataset}%{axis}_RAPTOR.log
assert.exists.file=raptor2/IMOD/%{dataset}%{axis}.fid.txt
assert.exists.file=raptor2/IMOD/%{dataset}%{axis}.rawtlt
bn.open-raptor-model-in-3dmod=
bn.use-raptor-result-as-fiducial-model=
assert.not-exists.file=%{dataset}%{axis}_raptor.fid
assert.exists.file=%{dataset}%{axis}.fid
bn.use-raptor-result-as-fiducial-model=
wait.popup.entry-error=OK

