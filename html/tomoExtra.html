<html><head> <title>IMOD Tomography Guide - Advanced Topics</title> </head>
<body>
<H2 ALIGN=center>Tomography Guide Advanced Topics for IMOD 3.11<BR>
</H2>
<H3 ALIGN=center>Boulder Laboratory for 3-D Electron Microscopy of Cells</H3>
<HR>
<H3>Table of Contents</H3>
<UL>
</UL>
<BR><A HREF = "#Command Files">1.0. Command Files</A>
<BR><A HREF = "#Entries to Programs">2.0. Entries to Programs</A>
<BR><A HREF = "#Running Copytomocoms">3.0. Running Copytomocoms Manually</A>
<BR><A HREF = "#Bidirectional X Tilt">4.0. Correcting for X-axis Tilt in Bidirectional Tilt Series</A>
<BR><A HREF = "#Fiducialless Tomogram">5.0. Making a Tomogram with Correlation Alignment.</A>
<BR><A HREF = "#Fiducialless Combine">6.0. Combining Tomograms with Few or No Fiducials</A>
<HR>

<H4><A NAME = "Command Files"></A>
1.0. Command Files
</H4>
Nearly all of the processing for tomography is done by running command
files.  The format of these files was originally based on the batch files used
in VMS.  In our command files, every line that runs a command or program must
start with "$"; comments can be inserted anywhere in the file on lines
that start with "#".  To skip over part of a command file, you can
insert the lines:
<PRE>
  $goto label             ("label" can be any label you choose)
  ...
  $label:                 (This must be on a line by itself)
</PRE>
You can run a command file with the "subm" alias, which is defined in the
IMOD startup files:
<BR><CODE>     alias subm 'submbg \!* &'
<BR></CODE>
(An equivalent function is provided for bash users.)  Submbg is a shell script
that will run one or more command
files in sequence, creating a log file for each and reporting on their
success or failure.  It uses the program Vmstocsh to
convert a command file to a script that can be run
by the C shell, csh.
With this alias, you can enter, e.g., "subm track", and a file named
track.com will be executed in the background, a log file will be created
called track.log.  The bell will ring and a message will be printed 
when the command file is completed.
You can also enter "subm track." or "subm xcorr.com prenewst".
<P>
     If you need to interrupt a command file after you have started it,
one way is to use the "kill" command with the process ID (PID) that was
printed out
when you entered the "subm" command.  For example, if the PID was 1234, enter
"kill 1234".  Another way is to bring the process to
the foreground with "fg", then used CTRL-C to interrupt it.  If there is
more than one process in the background, give the command "jobs" first to
determine which one is the process in question, then use, for example, "fg %2"
to bring job 2 to the foreground.

<H4><A NAME = "Entries to Programs"></A>
2.0. Entries to Programs
</H4>
The programs that you will run have many parameters or options to control
their behavior.  There are three basic ways that options and
parameters
can be entered: as arguments
on the command line after the program name, interactively in response to
queries from the program after it starts, or as a set of lines
containing keyword and values.  The first way follows the
conventions that are common for Unix commands, the most typical form being
<BR><CODE>    command [options] input_file output_file
<BR></CODE>
 The [ ] around "options" signifies that this is an optional entry; this is a
common convention when summarizing how to invoke a program.  Optional
arguments are usually single letters or abbreviations starting with a dash
(-).  Some options must be followed by another entry, which could be a
filename, a single number, or a list of numbers.  Other options stand on their
own, without an additional entry.  Command line entries are finicky in that
they require spaces separating all of the elements, including a space between
an option and its value, and no embedded spaces in the entries.  For example:
<BR><CODE>     newstack -sec 0-7,13-21 -xf images.xg images.st images.ali
<BR></CODE>
 Here the -sec option is followed by a list of section numbers (with no
embedded spaces), the -xf option is followed by the name of file with
transformations in it, and the last two arguments are the names of the input
and output files.
<P>
A program that takes command line arguments will almost always print a
summary of its usage when you type in the program name with no
arguments, or with the argument -h.
<P>
Programs that take entries interactively print out a query for an entry,
accept a line of input, then go on to the next entry.  In the command files
used to run the tomography software, the answer to each query will appear on a
separate line after the line on which such a program is invoked.  When you
look at the log file produced by running a command file, you will see all of
the queries but none of the entries, because the entries are not echoed into
the log file.
<P>
Because there are several disadvantages to the latter approach, a new
input method was devised called <A HREF = "man/pip.html">PIP</A>,
which stands for "parse input
parameters".  A program that uses <A HREF = "man/pip.html">PIP</A>
can take parameters either as
command line arguments or as a set of lines of input, with each line
containing the keyword for an option and its value.  Typically each option
has a short name and a long name defined for it.  The short names are meant
to be used on the command line, while the long names are more explanatory
and are suitable for command files.  Option names can be abbreviated to
a unique set of characters, which makes command line use even more
convenient, although it is better not to abbreviate options in command files.
All text starting with a '#' is treated as a comment and ignored.

<P>
It may help to be aware of the underlying structure of the programs in
the IMOD package.  They are written in three languages: C, Fortran, and shell
script language.  The C programs take command line arguments; none have yet
been converted to use <A HREF = "man/pip.html">PIP</A> for input.  Most of the
shell scripts also take command line arguments, the exceptions being
Copytomocoms, Setupcombine, and Makejoincom, which originally took inputs
interactively and have been converted to take command line arguments as well.
The Fortran programs, which are the predominant programs used for tomography,
originally all took inputs interactively.  Some of them also took input and
output filenames on the command line, particularly ones which needed no other
entries (e.g., Header and Fftrans).  Fortran programs used for tomography
have almost all been converted to use <A HREF = "man/pip.html">PIP</A> for
input.
<P>
Fortran programs have several conventions for numeric interactive input,
and <A HREF = "man/pip.html">PIP</A> follows essentially the same conventions:
<OL>
<LI>When several numbers are expected in response to a query, they can be
separated by commas or spaces.  In addition, they can be entered on more than
one line.  However, in command files processed by eTomo, numbers should be
separated only by commas and should not continue on more than one line.
<LI>A slash (/) at the beginning of an entry will accept the default values
for all of the entries expected on that line.
<LI>When several numbers are being entered, specific values can be entered
for some of the numbers, followed by a slash to accept the defaults for the
rest of the entries (e.g., if 6 numbers are expected, 128,384/ will enter two
and accept the defaults for the other four).
<LI>Entering a comma without a number will accept the default for the
number expected before that comma (e.g., ,,,,128,384 will accept the defaults
for the first four numbers and enter values for the last two).
<LI>Once the program has received all the numbers that it is expecting, it
ignores the text on the rest of the line, as long as it is appropriately
separated from the last numeric entry (by a tab or space).  Command files
can take
advantage of this feature by having comments after numeric entries.
However, when eTomo processes command files, it places such comments on
a separate line before the entry.
</OL>
<P>
Filename or other text entries do not follow these conventions for
numeric input, and cannot be followed by comments on the same line in the
command file.
<P>
Some programs accept lists of numbers for specific entries.
Lists are comma-separated ranges of numbers, such as 1,3,6-9,12-10, which
would enter the numbers 1,3,6,7,8,9,12,11,10.  Lists follow slightly different
conventions:
<OL>
<LI>A list must be confined to a single line (which can be 10240 characters
long).
<LI>A slash (/) at the beginning of the entry will accept the default
values for the list (or leave a previous entry unmodified), but there is no
way to enter defaults for only some of the numbers in the list.
<LI>A character other than space, minus, comma, or a digit will terminate
the list; text after that character will be ignored, thus allowing comments
after lists.
</OL>

<H4><A NAME = "Running Copytomocoms"></A>
3.0. Running Copytomocoms Manually
</H4>
     If you need to get command files for a situation that Etomo cannot handle,
go to the directory where you will be working and enter
<CODE><BR>     copytomocoms</CODE><BR>
With no command-line arguments like this; the program will ask you a series of
questions about whether you have a tilt series about one axis or two, whether
the data are from CCD camera or film, etc.  The program works best if your
data files are already present in the current directory.
<P>
     Copytomocoms fetches the command files from $IMOD_DIR/com.  If 
something goes wrong, you can copy files from there manually.

<H4><A NAME = "Bidirectional X Tilt"></A>
4.0. Correcting for X-axis Tilt in Bidirectional Tilt Series
</H4>
Some tilt series taken by tilting in two directions from zero tilt appear to
have a change in X-axis tilt between the two halves of the series.  Although
Tiltalign cannot reliably solve for a progressive change in X-axis tilt during
the series along with the in-plane rotation variable that is usually solved
for, it can solve for a single change in X-axis tilt between the two halves of
a tilt series.  Be sure that you have identified one half of the tilt series
as a <B>Separate view group</B>, and then use the following procedure:

<OL>
<LI> If eTomo is running, press <B>Postpone</B> to close the current panel
and save any command files.
<LI> Edit align.com and add the following two lines:
<PRE>
     XTiltOption     4
     XTiltDefaultGrouping    150
</PRE>
The 4 in the first entry ensures that all views in one half of the tilt series
have the same value of X-axis tilt; the 150 is arbitrary and needs to be
bigger than either half of the tilt series.
<LI> Open the <B>Fine Alignment</B> panel in eTomo and compute alignment.
Examine the solution in the log.  You will see that on half of the tilt
series has nonzero entries in the Xtilt column.
<LI> You can probably solve for linear distortion as well if the usual
preconditions are satisfied; i.e., if fiducials are distributed in Z over a
significant portion of the area.  If you plan to do this, run the alignment
before adding the X tilt option, look at the Skew column in the solution and
note the range of skew values.  Then look at the skew after adding the X tilt
variable.  If its range has become much larger, the solution may be unstable
and you should probably choose between solving for distortion and X tilt,
depending on which gives the smaller residual.
</OL>

<H4><A NAME = "Fiducialless Tomogram"></A>
5.0. Making a Tomogram with Correlation Alignment.
</H4>
This section describes in detail the steps involved if you need to make as
good a tomogram as possible with the cross-correlation alignment.  
<UL>
<LI><B>Options in the cross-correlation.</B>  In Advanced mode you will see
several options that may help to optimize the alignment.  The only way to
assess the affect of these options may be to build a series of trial
tomograms, which you could do on a subset of slices.  The <B>Cumulative
correlation</B> option makes the reference for alignment at each step be a
sum of the lower-tilt views that have already been aligned.  This may give
a more globally correct alignment.  If you experiment with this, try it
with <B>Absolute Cosine Stretch</B> both checked and unchecked, because we
have not seen one consistently give a better result.
If features of interest are located in a
subset of the area, you might also experiment with defining the area of
correlation.  The area can be made smaller, but still symmetric around the
center, with the <B>Pixels to trim (x,y)</B> entry.  It can be offset from
the center by specifying X or Y axis min and max values.

<LI><B>Positioning.</B>  When you think that you have the best 
alignment for the final tomogram, 
go to the <B>Tomogram Positioning</B> page.
You have the same two choices as when
there are fiducials: generating 3 small samples or generating a whole
tomogram (presumably binned down) to draw boundary lines in.  After you run
<B>Compute Z Shift & Pitch Angles</B>, your positioning parameters will appear
on the screen just as they do with a fiducial alignment.  However, the 
<B>Tilt angle offset</B> and <B>Z-shift</B> shown here will be input to the
tomogram generation program, not the alignment program.  They are the same
parameters visible in Advanced mode on the <B>Tomogram Generation</B>.
These entries have the same effect as, and are additive to, the
entries that appear on the <B>Tomogram Positioning</B> page when
<A HREF = "man/tiltalign.html">Tiltalign</A> is being run.
As of IMOD 3.8.26, both sets of parameters can be present and will be properly
taken into account when <A HREF = "man/solvematch.html">Solvematch</A>
uses the fiducial coordinates to obtain the initial
transformation between dual-axis tomograms.

<LI><B>Tomogram Generation.</B> There is one parameter that can be adjusted to
affect the results at this stage, the angle of the tilt axis.  A possible
strategy is to examine the aligned stack and see what rotation angle is needed
to keep features as close as possible to the same horizontal line through the
whole series.  Once you have a reconstruction, the X/Z slices of the tomogram
will probably give the best indications of deficiencies in the alignment.

<LI><B>Suggested Sequence.</B>  A possible sequence of iterative operations
would be:
<OL>
<LI>Compute the cross-correlation.  Check <B>Fiducialless alignment</B> and
press <B>Done</B> (remember, there is no need to generate the coarse aligned
stack).
<LI>Go to <B>Tomogram Positioning</B> and determine the positioning
parameters.
<LI>Go to <B>Tomogram Generation</B> and generate and view an aligned stack. 
If features are not staying in one horizontal line,
adjust the <B>Tilt axis rotation</B> and make a new aligned stack to try to
improve this. 
<LI> Specify a subset of slices and
possibly a reduced width.  Specify a trial tomogram name and compute the trial
tomogram.
<LI>Go back to <B>Coarse Alignment</B> and try different parameters (e.g.,
cumulative correlation or a subset area).
<LI>Go to <B>Tomogram Generation</B> and make a new aligned stack and 
trial tomogram.
<LI>Repeat the last two steps until optimal parameters are determined then
compute the correlation again, if necessary.
<LI>Go to <B>Tomogram Generation</B>, generate
the aligned stack.  Apply 2D filtering if needed.  Reset the slice limits and 
width, and make the final tomogram.
</OL>
</UL>
<H4><A NAME = "Fiducialless Combine"></A>
6.0. Combining Tomograms with Few or No Fiducials
</H4>
This section describes how to use models of corresponding points to get
the initial match between two tomograms when there are too few, or no,
fiducials.
To get an adequate solution for the initial transformation, there should be at
least 6 well-distributed corresponding points, preferably 8-10.  You will need
to make matching models if you have
made tomograms without fiducials, or if you have too few fiducials for
an accurate fit.  To do this:
<OL>
<LI> Select the <B>Use matching models and fiducials</B> radio button on the
<B>Tomogram Combination Setup</B> page if
you have some fiducials, or <B>Use matching models only</B> button if you have
none.
<LI>If your tomograms are too large for both to fit into memory, select
<B>Load binned by 2</B>, which will reduce memory requirements 8-fold.
<LI>Press 
<B>Create Matching Models in 3dmod</B> to load both tomograms with
appropriate filenames set up.  Change the object type to "Scattered points"
and set a useful symbol or sphere size so that you can see the points.
Model enough well-distributed corresponding points to bring your total up to
8-10 (if there are no fiducial points at all, you might need more points for
an equivalently accurate solution).  Be sure to have points distributed in Z
as well as in X and Y.  See the man page for
<A HREF = "man/solvematch.html">Solvematch</A> for more details on choosing
points.  If you are
marking gold particles, put the model point on the section with the strongest
white side bands around the black bead.  Save the models.
<LI>Make sure that you have corresponding fiducial point numbers entered if
you do have some fiducials.
<LI>Start the combine operation. 

<H4><A NAME = "ErasingGold"></A>
7.0. Erasing All Gold from a Tomogram
</H4>
If you want to erase gold that was not modeled as fiducials, then you need to
make a more complete model than the fiducial model.  If this model is made on
the coarse aligned stack and named "setname.fid", then you will be able to use
the gold-erasing interface in eTomo to transform the model and apply it to the
aligned stack.  Thus, before you start, you should copy your existing fiducial
model to another filename in case you need to reuse it for aligning at some
point.
<BR><CODE>    cp setname.fid setname_real.fid
<BR></CODE>
<P>
There are two different methods that you can use to get a more complete model:
adding seeds to the fiducial model and tracking it, or getting a model of the
positions of the beads in a tomogram and projecting that to match the final
aligned stack.

<H4><A NAME = "ErasingTracking"></A>
7.1. Tracking Additional Gold
</H4>
Before starting this operation, save the original seed model if it has not
been saved previously; i.e., if "setname_orig.seed" does not exist, then
<BR><CODE>    cp setname.seed setname_orig.seed
<BR></CODE>
One option is to add seed points by hand.  The easiest way to do this is to
rename the fiducial file as a seed file:
<BR><CODE>    mv setname.fid setname.seed
<BR></CODE>
then use <B>View Seed Model</B> to open the model with the Bead Fixer in
seeding mode.  Add seed points and proceed to track and refine as needed.
<P>
A second option, particularly useful if you many unmarked beads, is to use 
<A HREF = "man/imodfindbeads.html">Imodfindbeads</A> to find the gold.  The
command for doing that is:
<BR><CODE>    imodfindbeads -size diameter -sp 0.9 -add setname.fid \
                -sec section setname.preali setname.seed
<BR></CODE>
Here "diameter" is the diameter of the beads in pixels, "section" is the
section number, numbered from 0, to analyze, and the "-sp 0.9" allows beads
to be spaced apart by at least 0.9 times their diameter.  A spacing down to
0.8 may be useful for getting more overlapping beads.
<P>
Run this way, the program will analyze the correlation strengths of beads
(referred to as relative peak strengths) and
try to determine a threshold between true beads and spurious correlations.
It will store the positions of what it thinks are the true beads and up to the
same number of points with peak strengths below the threshold.  It is
important that you remove the points below threshold before proceeding.
To do this, use <B>View Seed Model</B> to reopen the model
examine the points, adjust the threshold to the best value
  There are more
options to try if 
