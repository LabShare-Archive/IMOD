<html><head><title>Tomogram Joining</title></head><body>
<H2 ALIGN=center>Joining Tomograms from Serial Sections for IMOD 3.4.13<BR>
</H2>
<H3 ALIGN=center>Boulder Laboratory for 3-D Electron Microscopy of Cells</H3>
<HR>
<H3>Table of Contents</H3>
<UL>
<BR><A HREF = "#Background">1. Background</A>
<BR><A HREF = "#TopBottom">1.1. Top and Bottom</A>
<BR><A HREF = "#Flipping">1.2. Flipping Tomograms</A>
<BR><A HREF = "#Setup">2. The Setup Panel</A>
<BR><A HREF = "#InitialEntries">2.1. Initial Entries</A>
<BR><A HREF = "#AddingSections">2.2. Adding and Manipulating Sections</A>
<BR><A HREF = "#Rotating">2.3. Rotating a Section</A>
<BR><A HREF = "#DecidingSlices">2.4. Deciding on Slices to Extract</A>
<BR><A HREF = "#MakingSamples">2.5. Density Matching and Making Samples</A>
<BR><A HREF = "#ModifyingSetup">2.6. Modifying the Setup to Make New Samples</A>
<BR><A HREF = "#Align">3. Aligning the Sample Slices</A>
<BR><A HREF = "#ManualAlignment">3.1. Manual Alignment with Midas</A>
<BR><A HREF = "#AutoAlignment">3.2. Automatic Alignment with Xfalign</A>
<BR><A HREF = "#AutoParameters">3.3. Parameters for Automatic Alignment</A>
<BR><A HREF = "#Joining">4. Making the Final Joined Volume</A>
</UL>
<HR>
<P>
<A NAME = "Background"><H3>
1. Background
</H3></A>
This document describes how to join tomograms from serial sections into one
volume, using the interface in eTomo.  If you need to do this operation from
the command line instead, see the older <a href="preEtomoJoin.html">
instructions</a>.

<P>
The interface is organized into 
three panels or tabs
that will enable you to perform the following sequence of
steps:
<OL>
<LI>Determining which surfaces match with which between adjacent sections.
<LI>If necessary, flipping or rotating the volume so that slices in Z are
parallel to the plane of section;
<LI>Extracting sample slices from the section boundaries so that these
boundaries can be visualized and aligned;
<LI>Getting transformations to align the top of each section to the bottom
of the next;
<LI>4) Assembling the joined volume.
</OL>

The <B>Setup</B> panel manages steps 1 to 3.  It allows you to identify the
different sections and record information about the surfaces.  eTomo uses this
information to run the
program Makejoincom, which produces a command file, "startjoin.com", that
eTomo then runs to accomplish steps 2 and 3.
Step 4 in done with the <B>Align</B> panel, where you use 
<A href="man/midas.man">Midas</A> for manual alignment and you can also try
<A href="man/xfalign.man">Xfalign</A>
for automated alignment.  Step 5 is done with the <B>Join</B> panel, which 
runs the program <A href="man/finishjoin.man">Finishjoin</A>.

<P>
<A NAME = "TopBottom"><H4>
1.1. Top and Bottom
</H4></A>
     If you have N tomograms, then there are N-1 boundaries between sections.
The words "top" and "bottom" are used here with a particular meaning: the
"top" of a section is the part of the tomogram that matches up with the
"bottom" of the next section.  These words do not refer to the high Z and low
Z portions of a tomogram, so the top of a section may be at either the high or
the low Z end.  The programs will take care of any inversions in Z, both in
extracting sample slices and in assembling the final volume, so you do not
need to worry about entering slice numbers in a particular order.
<P>
     If you have numbered your sections in the same order as they came off of 
the block during cutting, then the surface of a section against the formvar
should be the top, and the other surface should be the bottom.  You should be
able to distinguish these surfaces by which one has gold particles closest to
the sectioned material.

<P>
<A NAME = "Flipping"><H4>
1.2. Flipping Tomograms
</H4></A>
The interface in eTomo was designed to work only with tomograms that
have been flipped after generation so that the Z sections in the image
file correspond to actual slices in Z, parallel to the plane of
section.  If you identify a tomogram for joining that appears not to
have been flipped
in the post-processing step, eTomo will offer to flip it for you and
produce a file with extension ".flip"  in the working directory.
<P>
<A NAME = "Setup"><H3>
2. The Setup Panel
</H3></A>
To begin joining tomograms, start eTomo and select <B>New Join</B> from the
<B>File</B> menu.  This will bring up the <B>Setup</B> panel.

<P>
<A NAME = "InitialEntries"><H4>
2.1. Initial Entries
</H4></A>
After opening the <B>Setup</B> panel, you must first
make an entry for <B>Working directory</B>.
You should create a new directory for your joining operation so that it is
easy to clean up afterwards.  You do not need to copy the tomograms into this
directory.  You can use the file chooser to browse for the directory,
as well as to make a new folder and rename it to the desired name.
<P>
You must also enter a <B>Root name for output file</B>.  The
final tomogram will be named with this root name plus the extension ".join".
An addition, a host of intermediate files will be created with this root name
and other extensions.  Files will be referred to below as, for example,
"rootname.join".  In addition, eTomo will automatically save a file,
"rootname.ejf", to the working directory with all of its information about the
joining operation.  You can exit eTomo and restart where you left off by
loading this file.
<P>
<A NAME = "AddingSections"><H4>
2.2. Adding and Manipulating Sections
</H4></A>
Press <B>Add Section</B> to add a section to the table, then use the
file chooser to find the tomogram.  The program
will record the full path to the file but show only the file name.
You can press the <B>></B> button in the title line of the table to
switch back and forth between seeing the full path and just the file
name.
<P>
Once you have added a section, you need to select the section to
perform any operations on it.  This is done with the <B>=></B> button
to the left of the file name.
<P>
You can change the order of the sections in the table by selecting a
section and using <B>Move Section Up</B> or
<B>Move Section Down</B>.  You can also delete a
section if necessary.
<P>Once you have selected a section, you can view it in 3dmod by
pressing <B>Open in/Raise 3dmod</B>.  Note that you can bin the
images in X and Y to reduce the amount of memory that they will
require; this option should allow you to view several sections at once
regardless of how big they are.  Binning is only in X and Y, not in Z, so
that slice numbers will not vary with binning.

<P>
<A NAME = "Rotating"><H4>
2.3. Rotating a Section
</H4></A>
It is possible to rotate a tomogram
before joining, using <A href="man/rotatevol.man">Rotatevol</A>.
There are two reasons to use rotations.  1) If
the surface of one section is pitched and can be made flat by a small
rotation, then the boundary between sections can be made smaller by correcting
this pitch.  2) If a tomogram is rotated by a large angle (e.g., 90 degrees)
relative to an adjacent section, and if all the sections are aligned to an
average orientation, then the final aligned result will come out at a strange
angle.  To prevent this, you would have to set one tomogram as the reference
for alignment in Finishjoin.  If for some reason it will not work to have one
tomogram be the reference, then use Rotatevol to avoid this problem.
<P>
If you want to use <A href="man/rotatevol.man">Rotatevol</A> to adjust
the orientation of a section, then load the tomogram into 3dmod.  Open a
Slicer window and adjust the angles to achieve the desired rotation.  It may
take only a few tenths of a degree to correct significant pitch in the
section.  Use the numeric keypad arrow keys to adjust an angle by small
increments (4 and 6 for 0.1 degree increments, 2 and 8 for 0.5 degree
increments).  Once you have obtained the desired rotation, be sure the
section in question is selected in the section table, and press
<B>Get angles from slicer</B> in eTomo to get the angles entered into
the table.

<P>
<A NAME = "DecidingSlices"><H4>
2.4. Deciding on Slices to Extract
</H4></A>
You need to decide which slices to extract from the top and
bottom of each section in order to construct a file that contains a sample of
each boundary.  You should include the last slice that contains usable image
data, and 5 to 10 slices into the section from there.  This will allow you to
see if there are trends in position within the section that need to be taken
into account when aligning across the boundary.  In some cases, this may not
be needed, and you could choose to extract just one slice that is adequate for
alignment.  In general, it is safer to be generous in this initial sample.
These sample slices will also be averaged to produce images that can be used
for automatic alignment.  Enter the first and last section of each
range in the appropriate text box under <B>Start</B> and <B>End</B>,
respectively, in the <B>Sample Slices</B> area of the table.
<P>
Note that the bottom of the first section and the top of the last section
will not be extracted because they do not connect to another section.
<P>
At the same time that you are making these choices, you may also be able
to decide what range of slices from each tomogram to include in the final
volume.  Enter these choices in the text boxes in the <B>Final</B>
area of the table.  These entries will appear in italics to signify
that they are not relevant to the operation performed on this panel.

<P>
<A NAME = "MakingSamples"><H4>
2.5. Density Matching and Making Samples
</H4></A>
The combining procedures will scale the densities of the different
sections to match their means and standard deviations.  The same scaling
will be applied in producing both the sample slices and the final
volume.  By default, the first section will be used as the reference
for this scaling.  If this section has poor dynamic range
(i.e., black and white sliders need to be set close to each other in
3dmod to get good contrast), then all of the other sections will be
scaled to a similarly poor dynamc range.  To avoid this, select a different
section as the reference using the 
<B>Reference section for density matching</B> entry.
<P>
When all entries have been made, press <B>Make Samples</B>.  The
program will first determine the density scaling.  It will then run
<A href="man/rotatevol.man">Rotatevol</A> on any
sections that have rotation angles, producing a file with extension
".rot" in the workign directory. Finally, it will
extract the sample slices into "rootname.sample" and average them
into "rootname.sampavg".  At this point, you can go on
to the <B>Align</B> panel.

<P>
<A NAME = "ModifyingSetup"><H4>
2.6. Modifying the Setup to Make New Samples
</H4></A>
After you have made samples, most fields on the <B>Setup</B> panel
will be disabled, to prevent disagreements between the informationon
this panel and the information used in later phases of the process.
If you want to make new samples with different entries, just press
<B>Change Setup</B>.  After doing this, you are free to rearrange
sections and modify entries, but you will not be able to go on to the
other panels until you have made samples again.  If you change your
mind and just want to go on, press <B>Revert to Last Setup</B> to
restore the entries that were used to make the existing samples.  This
will unlock the other tabs.

<P>
<A NAME = "Align"><H3>
3. Aligning the Sample Slices
</H3></A>
The <B>Align</B> panel has three components.  There is a modified
version of the section table with information relevant to aligning the
sections; an area for setting parameters for automatic alignment, and
buttons to perform the different kinds of alignment.

<P>
<A NAME = "ManualAlignment"><H4>
3.1. Manual Alignment with Midas 
</H4></A>
<A href="midas.man">Midas</A> can be used exclusively to align the
sections manually, or it can be used to check and refine the results
from automatic alignment.
The sample slices are aligned in <A href="midas.man">Midas</A> using a
special "chunk" alignment
mode, in which you can adjust the alignment between chunks of slices while
viewing any pair of slices from the chunks.
For each section boundary, it will
initially show the slice from the top of the lower section as the <B>Reference
sec.</B> and the slice from the bottom of the upper section as the <B>Current
sec.</B>.  However, you are free to select another pair of slices for
aligning, to scroll through either set of slices to assess trends in the
structures, and to switch the pair of slices after you have started aligning.
Use the up and down arrows on the spin boxes, or the "a", "b", "c", and "d"
hot keys to move forward and back through the slices in the two sections.
Use the "Current chunk" spin box or the "A" and "B" hot keys 
to switch to a different section boundary.  If you get confused after
stepping between slices, consult the right side
of the section table, which shows the range
of slices that can validly be used as reference and current sections
for a given current chunk.

<P>
<A NAME = "AutoAlignment"><H4>
3.2. Automatic Alignment with Xfalign
</H4></A>
In some cases, automatic alignment of the sample averages with 
<A href="xfalign.man">Xfalign</A> may produce
an adequate alignment.  The interface provides for using 
<A href="xfalign.man">Xfalign</A> in two different scenarios:
getting an initial alignment that might need refinement by hand, or
refining an approximate alignment that you have made with Midas.
<OL>
<LI>Use <B>Initial Auto Alignment</B> to do an automatic alignment
from scratch, ignoring any previous alignment.
<A href="xfalign.man">Xfalign</A> will do a
cross-correlation before starting a local search for the best
alignment, in order to handle large displacements between sections.  
When you run <A href="midas.man">Midas</A> to check the alignment
after this operation, 
you may find that some or all of the transformations are
useless.  If so, use the entry "Reset to unit transform" in the
"Edit" menu to get rid
of a bad transformation, and realign manually.  Alternatively, you can
press <B>Revert to No Transforms</B> then either restart <A
href="midas.man">Midas</A> or load "rootname.xf" using "Load transforms"
in the "File" menu.
<LI>Use <B>Refine Auto Alignment</B> to do an automatic alignment that
starts from the existing alignment.  (This button label is a bit
misleading since the operation is meant to be used to refine an alignment
done with Midas; refining an automatic alignment should have no effect.)
For example, if you 
find it difficult to correct for stretching in Midas, you can try
using Xfalign to refine the transformation after you have gotten it
approximately
correct.  After running this function, you should always check the
alignment in <A href="midas.man">Midas</A> again.  If the refinement is not
successful, you can get back to the last transforms written from 
<A href="midas.man">Midas</A> by pressing <B>Revert to Midas Alignment</B>.
Again, you would have to restart <A href="midas.man">Midas</A> or reload
"rootname.xf" to work with these transforms.  There is no easy way to take
some of the refined transformations but not others; to do this you could
read "join_name.xf" into a text editor and substitute lines from
"join_name_midas.xf" for the sections that have a better alignment from 
<A href="midas.man">Midas</A>.
</OL>

<P>
<A NAME = "AutoParameters"><H4>
3.3. Parameters for Automatic Alignment
</H4></A>
By default, the automatic alignment will search for a full linear
transformation, including translation, rotation, size change, and
stretching.  If the images do not contain enough information to indicate
all of these aspects of a transformation, the search may be more successful
if you restrict the transformation.  You can select either
<B>Rotation/Translation/Magnification</B> to omit stretch from the search,
or <B>Rotation/Translation</B> to find an alignment that includes only 
rotation and translation.  These are options to try before giving up on
automatic alignment.
<P>
The filtering parameters control the degree of filtering that is applied to
the images.  <A href="xfalign.man">Xfalign</A> passes the filtered images
to <A href="xfsimplex.man">Xfsimplex</A>, which
searches for a transformation that minimizes a pixel-to-pixel difference
between the images, summed over all pixels.  This minimization is sensitive
to noise, so some high-frequency filtering is appropriate.  You might want
to reduce the <B>Cutoff for high-frequency filter</B> below 0.25 for
particularly noisy images.

<P>
<A NAME = "Joining"><H3>
4. Making the Final Joined Volume
</H3></A>
The <B>Join</B> panel shows another variant on the data table in which you
can adjust the starting and ending slices for the final volume.  The panel
also provides the ability to set
the size and centering of the volume, to generate a trial
volume quickly, and to adjust the size and centering with a rubber band in the
trial volume.

<P>
At the top of the panel is an option to 
specify one of the sections as the reference to
which the others will be aligned.  By default, all tomograms will be
transformed into alignment to a single average position.
If you turn on <B>Reference section for alignment</B> and select a section,
that section will
not be transformed and the others will be.  In addition to the case of large
rotations mentioned above, this could also be useful if you have already
modeled on one section, or if you are adding another section to an existing
set of serial sections.  
<P>
When you first enter the panel, it will show an output size that equals
the maximum size of the input sections.  If you have an appreciable shift
between the sections, this size may not be sufficient.  The following
procedure is recommended:
<OL>
<LI>Press <B>Get Max Size and Shift</B> to replace the current entries in
the <B>Size</B> and <B>Offset</B> text boxes with values that will produce
a volume that contains all of the original image data.  This volume will
likely be somewhat larger than you need.  Note that these values depend on
whether a section is selected as a reference, so if you change that setting
you may need to reiterate these steps.
<LI>Depending on the size of your data set, adjust the <B>Binning in X and 
Y</B> for the trial join to 2 to 4 to generate moderate-sized images.  For
very large data sets, you can also increase the interval between slices
(<B>Use every N slices</B>) to save time.  However big you make this
number, the your chosen starting and ending slice will be included for each
section.
<LI> Press <B>Trial Join</B> to generate a trial volume named
"rootname_trial.join".  Press <B>Open Trial in 3dmod</B> to see the
volume.
<LI> Turn on the rubber band in the Zap window.  Scroll through the volume 
and adjust the rubber band size and position to enclose the area that you
want to include in the final volume.
<LI> In eTomo, press <B>Get Subarea Size and Shift</B>.  The proper size
and shift will be calculated and placed in the text boxes.
<LI> The trial volume may also reveal whether you should change the
starting and ending slices.  If so, make an appropriate change and generate
a new trial volume to see if these limits work better.
<LI> Press <B>Finish Join</B> to generate the full joined volume
"rootname.join".
<LI>Examine the joined volume ("join_name.join") to see whether you want fewer or
more slices at any of the section boundaries.  If so, change the slices
numbers in the table repeat <B>Finish Join</B>.
</OL>
Once you are done, you should be able to delete all of the intermediate
image files that have been created (...flip, ...rot, rootname_trial.join,
rootname.sample, rootname.sampavg).  The other
files should be kept for future reference.
</body></html>
