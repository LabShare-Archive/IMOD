<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <meta content="text/html; charset=ISO-8859-1"
 http-equiv="content-type">
  <title>ctfguide.html</title>
</head>
<body>
<h2>The CTF Graph</h2>
<OL>
<LI> The X coordinate is normalized frequency.
1.0 equals the Nyquist frequency determined by the pixel size.<br>
In our case, the pixel size is in nanometers, and the Nyquist frequency in
1/nm would be 0.5/pixel_size.</li>
<li> The text field marked
with "Z" on the top line reports the found normalized frequency of the
first zero.  The absolute frequency of the first
zero in 1/nm is (normalized frequency)*(Nyquist frequency).<br>
The text field marked with "D" on the top line
reports the found defocus in microns.<br>
If you double-click on the position of the
second zero with the middle or right mouse button, the text field marked "D2"
shows the defocus implied by that second zero position, and the text field
marked "D-avg" shows the average of the defocus from the first and second
zeros.</li>
<li> The red curve is the logarithm of the CTF
curve of the selected views after subtracting the noise floor. <br>
If you use a fitting method that fits just one curve, the green curve fits the 
red curve from "X1_starts" to "X2_ends", which can be set in the fitting range
dialog.<br>
If you use a method that fits two curves, the green curve will is fit to the
red curve from "X1_starts" to "X1_ends" and the blue curve
fits the red curve from "X2_starts" to" X2_ends", all of which can be set in
the fitting range dialog.<br>
In either case, the curves are drawn over the whole frequency range.</li>
<li> To zoom in an area, hold down the left mouse button down and
draw a rubber band around that area. <br>
To go back to the previous zoom level, push the Zoom-out icon.<br>
Successive zooms are kept in a list, and you can go forward or backward
through the zooms using either the Zoom-in and Zoom-out icons or the standard
hot keys for zooming in 3dmod, "-" or "+/=". </li>
<li>
Use arrow keys to scroll vertically and horizontally.  You can also use the
mouse scroll wheel to scroll vertically.</li>
<li> Double clicking at a point in the plot with the left mouse button will set
the found frequency of the first zero to the frequency at point.<br>
The found defocus field will
change accordingly. This is useful for manually locating the first zero
and finding its corresponding defocus.<br>
Once a first zero position is set either by fitting or manually clicking,
double-clicking with the middle or right mouse button can be used to indicate
the second zero position.  The text fields based on the second zero will be
set back to "NA" whenever a new first zero is set.</li>
</ol>
<h2>Tool Button Usage<br>
</h2>
<TABLE BORDER COLS=2>
<COLGROUP SPAN=1 WIDTH="*0">
<TBODY>
<TR><TD><img alt="zoominButton" src="zoomin.png"
 style="width: 22px; height: 22px;">
<TD>Zoom in again after zooming back out.
<TR><TD><img alt="zoomoutButton" src="zoomout.png"
 style="width: 22px; height: 22px;">
<TD>Zoom out after zooming in.
<TR><TD><img alt="rangButton" src="range.png"
 style="width: 48px; height: 48px;">
<TD> Open the fitting range and
 method dialog.
<TR><TD><img alt="angleButton" src="angle.png"
 style="width: 48px; height: 48px;">
<TD> Open the tilt angle
range dialog.
<TR><TD><img alt="moretileButton"
 src="moreTile.png" style="width: 32px; height: 32px;">
<TD>Adding Non-center Tiles button. If
this button is enabled, the current estimation is based only on center
tiles; 
push this button to add non-center tiles to the current estimation.
<TR><TD><img alt="saveButton" src="save.png"
 style="width: 32px; height: 32px;">
<TD>Save
the defocus found for
the selected views in the output file.&nbsp; The defocus indicated by "D" is
saved unless a second zero has been clicked, in which case the average defocus
indicated by "D-avg" is saved.  A line is added to the
output file each time this button is pressed.
<TR><TD><img alt="printerButton" src="printer.png"
 style="width: 48px; height: 48px;">
<TD>Print the plotted curves.
<TR><TD><img alt="helpButton" src="ctfhelp.png"
 style="width: 22px; height: 22px;">
<TD>Bring up Qt assistant to display this page.
</TBODY>
</TABLE>
<br>
<br>
<h2>Fitting Range & Method Dialog
</h2>
This dialog allows three different kinds of fitting, which can be selected by 
the radio buttons at the top.  After changing parameters, either press
<B>Apply</B> or type the "Enter" key in one of the text boxes to have the fit
recomputed with the current parameters.
<p>
<img alt="rangeDialog" src="rangeCTF-like.png">
<br>
Fitting to a CTF-like curve involves finding four parameters, or five if the
option <B>Vary exponent of CTF function</B> is selected.  Varying the exponent
can allow the curve to fit better to the width of the dip around the first
zero, but since it adds a parameter, it can destabilize the fitting and
produce bad results in some cases.  One of the parameters of the curve is the
defocus.
</P>
<p>
The range of the curve is set from the entries <B>X1 Starts</B> and 
<B>X2 Ends</B>.  When the program first starts, it sets these values to be
about 0.1 frequency unit before the first zero, and close to the second zero,
respectively, based on the expected defocus.  If necessary, you should adjust
the starting value so that it is to the right of where the fitted curve
strongly deviates from the actual.  If the red curve become noisy and falls
off before a second zero, you should also reduce the ending point of the fit
to exclude that region.  See the example below.
</P>
<p>
<img src="rangePolynomial.png">
<br>
You can also fit a polynomial to the region around the first zero.
The <B>Order of polynomial</B> spin button allows you to select an order
between 2 and 6, which involves finding 3 to 7 parameters.  The goal here is
to get a smooth curve through the dip; the minimum
of the curve is taken as the location of the first zero.
</P>
<p>
As for CTF-like fitting, the range of the curve is set from the entries 
<B>X1 Starts</B> and <B>X2 Ends</B>.  Since you are just trying to localize
the dip at the first zero, you should restrict the range as necessary to get a
good fit there.
</P>

<p>
<img src="rangeIntersect.png">
<br>
Finding the zero at the intersection of two curves involves fitting two
separate curves, before and after the first zero.  Each can be fit to either a
straight line or a Gaussian over the selected range.  The program finds the
intersection of the two curves, if possible, and assigns that as the first
zero.
</P>
<P>
X1 sets the fitting range for the curve before the first
zero, drawn in green. Use the <B>X1 fitting method</B> radio
button to select whether to fit to a straight line or to a Gaussian.
</P>
<P>
X2 sets the fitting range for the
curve after the first zero, drawn in blue. Use the <B>X2 fitting method</B>
radio button to
fit to a straight line or to a Gaussian.
</P>

<h2>Tilt Angle Range Dialog<br>
</h2>
This dialog presents the various parameters that control how the CTF curve is
computed.  After changing parameters, either press
<B>Apply</B> or type the "Enter" key in one of the text boxes to have the curve
recomputed with the current parameters.
<P>
<img alt="angleDialog" src="angleDialog.png"><br>
<B>Expected defocus</B>: <br>
The first time this dialog is brought up, the expected defocus value
specified in the parameter file is shown.  Initially, this value is used to
compute the expected frequency of the first zero of the CTF curve and to set
the initial values of the X1 and X2 ranges which determine what segments of
the CTF curve are fitted.
When non-center tiles are being included, ctfplotter uses a defocus to
compute shifts needed to align the CTF curves of non-center
tiles with the CTF curve of center tiles. With the radio button group
<B>Which defocus to use</B>, the user can specify 
whether to use the expected defocus shown in the <B>Expected defocus
(um)</B> Edit field or the defocus previously found by the
program as the defocus for computing the shifts.
</P><P>
<B>Tilt angle starts</B><br>
<B>Tilt angle ends</B>: <br>
The views with tilt angle
greater than or equal to the starting angle but less than or equal to the
ending angle will be included in the estimation.
</P><P>
<B>Center defocus tol</B>: <br>
The image region with defocus difference less than this tolerance is
defined as the center region.
</P><P>
<B>Left defocus tol:</B> <br>
<B>Right defocus tol</B>: <br>
These two entries set the maximum defocus difference for adding in
tiles from image regions to the left and right of the center region,
respectively,
after the "Adding Noncenter Tiles" button is pushed,
or if the <B>All tiles</B> radio
button is selected.
You can set one to be small and the other large in order to 
assess the results of
adding in tiles from only one side of the image, but this will mix tiles at
lower and higher defocuses unless the tilt angles are all positive or all
negative. 
</P><P>
<B>Tile size</B>: <br>
The tile size in pixels.
</P><P>
<B>Tilt axis angle</B>:<br>
The amount in degrees that the tilt axis deviates from being vertical
(Y axis).
</P><P>
<B>Initial tiles to include</B> radio
button group:<br>
Choose whether or not to include the noncenter tiles in the estimation
when computing the CTF curve.<br>
If <B>Only central tiles</B> is checked, only the center region defined by
<B>Center defocus tol</B> will be
included in the next computation, and the "Adding Non-center Tiles" button
will be enabled. The user needs to push that button to add the left region
defined by <B>Left defocus tol</B> and the right region
defined by <B>Right defocus tol</B>
to the estimation.<br>
If <B>All tiles</B>&nbsp; is checked,
all regions (center, left, right) will be included whenthe curve is
recomputed,
and the "Adding Non-center Tiles" button will be disabled.<br>
</P><P>
Push the <B>Store current defocus</B> button to write the defocus found to the
output file, just as when pressing the Save tool button.
</P>
<h2>Example</h2>
This example shows the appearance of the plotting window with a tilt series
from bovine papilloma virus, taken at a nominal defocus of 3 microns and a
pixel size of 0.76 nm.  When the program is started with the default
angular range in the command file, the window looks like this:
</P><P>
<img src="plotStartup.png"><br>
The range of the display in Y is dominated by the power at low frequencies, so
it is essential to zoom the display.  This graph was zoomed by pressing the
left mouse button with the cursor just at the place where the green and red
curves diverge (at ~0.25 in X), then dragging the mouse to just below the 
curves and just to the left of 0.8 to set the lower right corner of the rubber
band.  Then the window looks like this:
</P><P>
<img src="plotCenterZoom.png"><br>
Now we can see more clearly that the background subtraction is giving a
reasonable CTF curve that is close to flat at high frequencies.
The next step is to add in all of tiles, either by pushing the "Adding
Non-center Tiles" button or by opening the Angle range dialog and switching to
the <B>All tiles</B> option.  These two methods will give slightly different
results, and the latter is actually preferable.
</P><P>
<img src="plotAllTiles.png"><br>
The CTF curve is much smoother and it is now easier to see that it has a
discernable dip, but that the green
curve does not fit very well. If we open the Fitting Range & Method dialog, we
see that it is fitting from 0.43 to 0.78, a range that was determined from the
nominal defocus but is not quite appropriate for the actual defocus.  The
range was changed to what was shown above in the dialog: the left side was
moved to 0.38 to include more of the falling phase of the CTF curve, and the
right side was reduced to 0.58 because the CTF curve drops off after that
point, well before its second zero.  At this point it is also clear that the
actual defocus is different from 3 microns, so we select the <B>Current
defocus estimate</B> radio button in the Angle Range dialog so that the
shifting from non-centered tiles will be more accurate.
If the fitting were unstable, a better way to do this would be to
change the <B>Expected defocus</B> entry.
After recomputing the curves and zooming the display again, it looks
like this:
</P><P>
<img src="plotFixRange.png"><br>
Here we see that the
CTF-like fitting works fairly well near the bottom of the dip, and that it
leads to a defocus estimate significantly different from the nominal defocus.
Turning on the <B>Vary exponent of CTF function</B> gives a slightly better
fit:
</P><P>
<img src="plotPower.png"><br>
This fitting method can now be used over different angular ranges, and the
results can be stored from each range.  Although there is no need to try the
different fitting methods with this data set, they are illustrated next.
</P><P>
<img src="plotPolynomial.png"><br>
This panel shows the CTF curve for a different angular range with a
fourth-order polynomial fit to the frequency range shown in the dialog above.
As is typical of polynomials, the green curves goes off wildly outside the
fitting range.
</P><P>
<img src="plotIntersect.png"><br>
This panel shows the CTF curve for the original angular range with
determination of the zero from the intersection of two curves, with the
frequency range as shown in the dialog above.
</P>
<br>
<a href="../man/ctfplotter.html">Refer to ctfplotter man page</a><br>
<br>

</body>
</html>
