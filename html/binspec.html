<html><head><title>
IMOD Binary Model File Format.
</title>

<body>
<H1>Imod Binary File Format. Version 1,  Revision 2</H1>

The imod binary file format is similar to the IFF format standard in
that is uses chunk id's for data headings. Each chunk id is 4 bytes
long and is defined as a string of 4 characters.
This is the format used by IMOD Version 2.0 available from the
Boulder Laboratory for Three-Dimensional Fine Structure.
The format is backwards compatible with IMOD 1.2.
All numbers are stored in big-endian format regardless of 
machine architecture.


<H3>The File Header</H3>

All binary model files begin with a 8 byte ID followed by a 184 byte header.
The ID format begins with the imod file id, (IMOD = 0x494d4f44)
followed by the 4 byte version id, (V1.2 =  0x56312e32).
The end of the file is marked by an end of data marker, (IEOF = 0x49454f46).

<HR>
<H3>The Model Data Structure</H3>
<p>
The Model structure data is 184 bytes long and contains the following data.
A lot of this data is used by the imod program to retain user settings.
<pre>
Length Type Name          Description
-----------------------------------------------------------------------------
128    char  name          Name of model file.

4      int   xmax          Maximum values for x,y and z. These are usually 
4      int   ymax          set to the image dimensions.
4      int   zmax

4      long  objsize       Number of objects in model.

4      long  flags         Model flags  (IMODF_FLAG...)
                           Bit 14 on : otrans has image origin values
                           Bit 15 on : current tilt angles are stored correctly
                           Bit 16 on : model last viewed on Y/Z flipped image
4      int   drawmode      1 to draw model, -1 not to
4      int   mousemode     Mouse editing mode. (0=movie,1=model)

4      int   blacklevel    Contrast adjustment. (0-256) Default = 0.
4      int   whitelevel    Contrast adjustment. (0-256) Default = 255.

4      float xoffset       Offsets used for display & conversion,
4      float yoffset       should be set to 0.
4      float zoffset       (unused, superceded by IMNX information)

4      float xscale        Scaling for pixel size. xscale and yscale should
4      float yscale        be 1.0 and zscale should be adjusted to account
4      float zscale        for the image thickness.

4      int   object        Current object, contour and point, used for
4      int   contour       model editing.
4      int   point 

4      int   res           Number of pixels between points for drag drawing.
4      int   thresh        Threshold level for auto contour generator.

4      float pixsize       Size of unit 1.0 pixel
4      int   units         Units of given size.

4      long  csum          Checksum storage. Used for autosave only.

4      float alpha         Angles used for orientation of the model with
4      float beta          image. Should be set to 0.0
4      float gamma         (unused, superceded by IMNX information)
</pre>

<HR>
<H3>The Object Data Structure</H3>
Each object in the model will have an object data structure.
The id value is (OBJT = 0x4f424a54) The data structure is 176 bytes long
with the following format.
<pre>
Length Type  Name       Description
------------------------------------------------------------------------------
64     char  name       Name of Object. Null terminated string.
64     int              Extra data reserved for future use.

4      long  contsize   Number of Contours in object.
4      long  flags      bit flags for object (IMOD_OBJFLAG...).
                        Bit 1 on : Off - turns off display
                        Bit 3 on : Open - contours are not closed
                        Bit 4 on : Wild - contours not constrained in Z
                        Bit 5 on : Inside-out  - light inside surface
                        Bit 8 on : Fill - draw filled polygons
                        Bit 9 on : Scattered - contours have scattered points
                        Bit 10 on : Mesh - draw mesh data in 3D
                        Bit 11 on : Lines - draw contours in 3D
                        Bit 14 on : Fill color - use instead of regular color
                        Bit 15 on : Anti-aliasing on
                        Bit 16 on : Normals have magnitudes
                        Bit 17 on : Draw normal maginitudes with false color
                        Bit 18 on : Time - contours have time indexes
                        Bit 19 on : Light both sides of surface

4      int   axis       Z = 0, X = 1, Y = 2.
4      int   drawmode   Tells type of points to draw.

4      float red        Color values, range is (0.0 - 1.0)
4      float green      
4      float blue       

4      int   pdrawsize    Size to draw points in 3D.

1      uchar symbol       Point Draw symbol, default is 0.
                             0 = circle, 1 = none, 2 = square, 3 = triangle,
	                     4 = star.
1      uchar symsize      Size of symbol; radius.
1      uchar linewidth2   Linewidth in 2-D view.
1      uchar linewidth    Linewidth in 3-D view.
1      uchar linesty      Line draw style default is 0 = solid. 1 = dashed.
1      uchar symflags     Bit 0 on : Fill the symbol.
                          Bit 1 on : Draw begining and end symbols.
1      uchar sympad       Set to 0, for future use.
1      uchar trans        Transparency

4      int   meshsize     Number of meshes in object.
4      int   surfsize     Max surfaces in object.
</pre>

<HR>
<H3>The Contour Data Structure</H3>
The contour ID is (CONT = 0x434f4e54) and the basic structure is
16 bytes long. Point data follows the contour header.
All point coordinates are put in the last declared object.  Empty 
contours are allowed.
<pre>
Length    Type         Name      Description.
------------------------------------------------------------------------------
4         long         psize   Number of points in contour.
4         long         flags   Bit 3 on : open, do not connect endpoints
                               Bit 4 on : wild, not in one Z plane
                               Bit 15 on : type variable contains time index
4         int          type    The time index used by this contour.
4         int          surf    The surface index used by this contour.
12*psize  float * 3    pt      Array of point triplets.
</pre>

<HR>
<H3>The Mesh Data Structure</H3>
The mesh ID is (MESH = 0x4d455348) and the basic structure is
20 bytes long.  Vertex data and index data follow the mesh header.

<pre>
Length    Type         Name    Description
------------------------------------------------------------------------------
4         int          vsize   Size of vertex array (# of triple floats).
4         int          lsize   Size of index array.
4         long         flag    Bit 16 on  : normals have magnitudes.
                	       Bits 20-23 are resolution : 0 for high, 
                                  1 for lower resolution, etc.
2         short        type    Contains a time index or 0
2         short        pad     Contains a surace number or 0
                                type and pad are stored as ints in the
                                internal data structure but shorts in the file
12*vsize  float * 3    vert    Array of points.
4*lsize   int          index   Array of ints.
</pre>
<p>
A point can be either a vertex position or a normal vector at a vertex.
In current model files, <code>vert</code> consists of a sequence of 
vertex/normal pairs; i.e. vertex, normal, vertex, normal...  The 
<code>index</code> array has a list of indices into the <code>vert</code>
array plus negative index values with following meanings:
<pre>
	-1   end of list array                
	-20  next item on list is normal vector.
	-21  begin concave polygon
        -22  end polygon
	-23  begin vertex,normal polygon pairs.
	-24  begin large convex polygon with normals.

</pre>
Currently, meshes in model files consist only of polygons with vertex, normal
pairs, starting with -23 and ending with -22.  In these polygons, each set
of 6 indices describes a triangle as follows:
<pre>
<i>index to normal 1</i>
<i>index to vertex 1</i>
<i>index to normal 2</i>
<i>index to vertex 2</i>
<i>index to normal 3</i>
<i>index to vertex 3</i>
</pre>

<HR>
<H3>
Optional extra data chunks.
</H3>

Optional chunks can be put at the end of any data structure that the
information is intended for, or at the end of the file.
Unknown data chunks can be skipped since the size is included after
the ID.

<pre>
Length Type Description
-----------------------------------------------
4      int  (Chunk ID)
4      int  (Chunk Size)
size   (Chunk Data) length of (Chunk Size) bytes.
</pre>

<p>
<b>List of reserved optional chunks.
</b>
<br>
VOXL  List of voxels.
<br>
DRAW  Model Draw structure.

<H4>
Description of current optional data chunks.
</H4>
<HR>
IMNX  Model to image transformation information.  (72 bytes data)
<p>
Coordinates are stored in an IMOD model file as image index coordinates 
relative to the last subset of image file that the model was displayed on.
The information here has two main uses.  1) It is used by Imod to display
the model
correctly when going between having a subset or the full image file loaded,
or when displaying on an image file with different origin, scaling, or rotation
angles in its header.  2) It is used by other programs to get back to the
index coordinates of the full image file.  These data consist
9 floats for old transformation values
followed by 9 floats for current transformation values.

<pre>
Length Type         Name     Description
------------------------------------------------------------------------------
12     float * 3    oscale   Old scale values (unused in file) 
12     float * 3    otrans   Old translations (file stores image origin values)
12     float * 3    orot     Old rotations around X, Y, Z axes (unused in file)
12     float * 3    cscale   New scale values in X, Y, Z
12     float * 3    ctrans   New translations in X, Y, Z
12     float * 3    crot     New rotations around X, Y, Z axes
</pre>

These values are based on the header information in the last image that
the model was displayed on: <code>cscale</code> is pixel spacing 
(cell size over grid size, <code>xlen/mx</code>); 
<code>crot</code> is taken from the current tilt angles; 
<code>ctrans</code> is based on
the origin minus the scale times the starting index coordinate of the image
loaded into Imod; <code>otrans</code> has the origin values.
<p>
To get from coordinates in a model file to an image file coordinate system,
first Y and Z are exchanged if the FLIPYZ flag is set, then coordinates
are multiplied by the scale values, translation values are subtracted, then
points are rotated by the negative of the rotation angles around X, 
then Y then Z.

<HR>
LABL  Label contour and point data. (Variable data)
<br>      Each contour has a pointer to a label structure.
<pre>
Length Type  Description
-------------------------------------------------------------------
4     int    # of label items for points in contour.
4     int    size of contour label
size  char   contour label string padded to 4 byte chunks.

for each point label item:
4     int    point index.
4     int    size of label string.
size  char   point label string padded to 4 byte chunks.
</pre>

<HR>
CLIP  Clipping planes for object. (28 bytes data)
<pre>
Length Type      Description
-------------------------------------------------------------------
1     byte       Number of additional clip planes. maximum is 8.
1     byte       Which clip planes are on.
1     byte       Transparency for clipped area. (future)
1     byte       Current clip plane.
12    float * 3  normal
12    float * 3  point
</pre>


<HR>
IMAT  material definition for object.        (16 bytes data)
<pre>
Length Type      Description
-------------------------------------------------------------------
1  UBYTE ambient 
1  UBYTE diffuse 
1  UBYTE specular   /* specular IS shininess   */
1  UBYTE shininess  /* shininess used as flags */
4  UINT  mat1  /* set to 0, use as material color future. ABGR */
4  UINT  mat2  /* set to 0, use as flags. */
4  UINT  mat3  /* used  byte0 = bright, byte1 = contrast */
</pre>

<HR>
SIZE  Sizes for each point in a contour.    (4 bytes per point)
<pre>
Length   Type       Description
-------------------------------------------------------------------
4*psize  float      Size value for each point
</pre>

<HR>
VIEW  Stored model and object view data structures.   (Variable size)
<BR>
This chunk can be as short as 4 bytes, in which case it contains just
the value of the INT cview.  Various versions of imod have stored 56, 156, or
176 bytes; after stored views began to contain properties for each object,
this chunk became larger than that and variable-sized.
<pre>
Length Type     Name    Description
-------------------------------------------------------------------
4     float     fovy    field of view of camera, perspective in degrees.  
4     float     rad     viewing radius of sphere encloseing bounding box. 
4     float     aspect  aspect ratio 
4     float     cnear   clip near: range 0.0 to 1.0, default 0.0. 
4     float     cfar    clip far: range 0.0 to 1.0 
12    float * 3 rot     Model transformation values for model view: rotation
12    float * 3 trans   translation
12    float * 3 scale   scale
-------------------------------------------------------------------
64    float * 16 mat    World OpenGL transformation matrix
4     int       world   flags for lighting and transformation properties
                        Bit 1 on : Light - draw with lighting
                        Bit 2 on : Depth cue - draw with depth cue
                        Bit 3 on : Wireframe - draw wireframes, not surfaces
                        Bit 7 on : Draw lower resolution meshes
32    char      label   ??
-------------------------------------------------------------------
4     float     dcstart Fog starting distance
4     float     dcend   Fog ending distance
4     float     lightx  X coordinate of light
4     float     lighty  Y coordinate of light
4     float     plax    Parallax angle for stereo
-------------------------------------------------------------------
4     int       objvsize  Number of Iobjview structures following
4     int       bytesObjv Bytes per Iobjview structure

</pre>
Currently there are 67 bytes per object view, as follows:
<pre>
4     UINT      flags        bit flags IMOD_OBJFLAG... (see above)
4     float     red          Red (0 - 1.0)                 
4     float     green        Green (0 - 1.0)               
4     float     blue         Blue (0 - 1.0)                
4     INT       pdrawsize    size to draw scattered objs   
1     UBYTE     linewidth    linewidth in 3-D              
1     UBYTE     linesty      line draw style               
1     UBYTE     trans        transparency                 
1     UBYTE     clip         number of additional clip planes. 
1     UBYTE     clip_flags   Which clip planes are on.         
1     UBYTE     clip_trans   Transparency for clipped area    
1     UBYTE     clip_plane   Current clip plane
12    float * 3 clip_normal  Normal for clipping plane
12    float * 3 clip_point   Point value for clipping plane
1     UBYTE     ambient      Ambient lighting value
1     UBYTE     diffuse      Diffuse lighting value
1     UBYTE     specular     specular IS shininess   
1     UBYTE     shininess    shininess used as flags 
4     UINT      mat1         set to 0, use as material color future. ABGR 
4     UINT      mat2         set to 0, use as flags. 
4     UINT      mat3         used  byte0 = bright, byte1 = contrast 
</pre>

</body></html>
