<html><head> <title>IMOD Tomography Guide</title> </head>
<body>
<H2 ALIGN=center>Tomography Guide for IMOD Version 3.11<BR>
</H2>
<H3 ALIGN=center>Boulder Laboratory for 3-D Electron Microscopy of Cells</H3>
<HR>
<H3>Table of Contents</H3>

<UL>
<BR><A HREF = "#WHATSNEW">0. WHAT'S NEW IN IMOD 3.11</A>
<BR><A HREF = "#BACKGROUND">1. BACKGROUND</A>
<BR><A HREF = "#Program Names">1.1. Program Names</A>
<BR><A HREF = "#Command Files">1.2. Command Files</A>
<BR><A HREF = "#Numbering System">1.3. Numbering System</A>
<BR><A HREF = "#Backup Files">1.4. Backup Files</A>
<BR><A HREF = "#Using Insecure Storage">1.5. Using Temporary or Insecure Storage</A>
<BR><A HREF = "#Intensity Problems">1.6. Problems with Intensities in 3dmod</A>
<BR><A HREF = "#NON-BOULDER NOTES">2. NOTES FOR NON-BOULDER USERS</A>
<BR><A HREF = "#File Naming Conventions">2.1. File Naming Conventions</A>
<BR><A HREF = "#Film versus CCD Images">2.2. Film versus CCD Images</A>
<BR><A HREF = "#Image Scaling">2.3. Image Scaling and Contrast Polarity</A>
<BR><A HREF = "#Bidirectional Series">2.4. Tilt Series Taken in Two Directions from Zero Tilt</A>
<BR><A HREF = "#INITIAL STEPS">3. SETUP</A>
<BR><A HREF = "#Montage Coms">3.1. Command Files when Montaging</A>
<BR><A HREF = "#PRE-PROCESSING">4. PRE-PROCESSING: REMOVING X-RAYS</A>
<BR><A HREF = "#COARSE ALIGNMENT">5. COARSE ALIGNMENT BY CROSS-CORRELATION</A>
<BR><A HREF = "#Fiducialless Quick">5.1 Making a Quick Tomogram with Correlation Alignment</A>
<BR><A HREF = "#Fixing Montage Edges">5.2. Fixing Montage Edges</A>
<BR><A HREF = "#GETTING FIDUCIAL">6. FIDUCIAL MODEL GENERATION</A>
<BR><A HREF = "#Reseeding Model">6.1. Using Beadtrack to Extend a Model</A>
<BR><A HREF = "#Transferring Fiducial">6.2. Getting Fiducials for a Second Axis</A>
<BR><A HREF = "#FINAL ALIGNMENT">7. FINE ALIGNMENT</A>
<BR><A HREF = "#Running Tiltalign">7.1. Running Tiltalign</A>
<BR><A HREF = "#Background Grouping">7.2. Background on Grouping Variables and Solving for Distortion</A>
<BR><A HREF = "#Distortion Two">7.3. Solving for Distortion - Fiducials on Both Surfaces</A>
<BR><A HREF = "#Distortion One">7.4. Solving for Distortion - Fiducials on Only One Surface</A>
<BR><A HREF = "#Projection Stretch">7.5. Solving for Projection Stretch</A>
<BR><A HREF = "#Beam Tilt">7.6. Solving for Beam Tilt</A>
<BR><A HREF = "#Using Local Alignments">7.7. Using Local Alignments</A>
<BR><A HREF = "#Excluding Views">7.8. Excluding Views</A>
<BR><A HREF = "#Residual Model Output">7.9. Residual Model Output</A>
<BR><A HREF = "#TOMOGRAM POSITIONING">8. TOMOGRAM POSITIONING </A>
<BR><A HREF = "#Doing Tilted Samples">8.1. Redoing Samples to Refine the Positioning</A>
<BR><A HREF = "#Whole Tomogram Positioning">8.2. Positioning with a Whole Tomogram</A>
<BR><A HREF = "#TOMOGRAM GENERATION">9. TOMOGRAM GENERATION</A>
<BR><A HREF = "#Radial filter">9.1. Tomogram Resolution and the Need for Filtering</A>
<BR><A HREF = "#Filtering Options">9.2. Filtering Options</A>
<BR><A HREF = "#Filtering Guidelines">9.3. Filtering Guidelines</A>
<BR><A HREF = "#Making Aligned">9.4. Making and Processing the Aligned Stack</A>
<BR><A HREF = "#Building Tomogram">9.5. Building the Tomogram</A>
<BR><A HREF = "#Making Trial Tomograms">9.6. Making Trial Tomograms</A>
<BR><A HREF = "#Z factors">9.7. Using Z Factors in the Backprojection</A>
<BR><A HREF = "#TOMOGRAM COMBINATION">10. COMBINING TWO TOMOGRAMS</A>
<BR><A HREF = "#Setting Up">10.1. Setting Up</A>
<BR><A HREF = "#Temporary Combining Storage">10.2. Using Temporary Storage for Combining</A>
<BR><A HREF = "#Proceeding">10.3. Proceeding</A>
<BR><A HREF = "#Initial Problems in Combining">10.4. Initial Registration Problems in Combining</A>
<BR><A HREF = "#Patch Problems in Combining">10.5. Patch Correlation Problems in Combining</A>
<BR><A HREF = "#Linen Pattern">10.6. Linen Patterns in the Combined Tomogram</A>
<BR><A HREF = "#Block Artifacts">10.7. Block Artifacts in the Combined Tomogram</A>
<BR><A HREF = "#POST-PROCESSING">11. POST-PROCESSING</A>
<BR><A HREF = "#Scaling and Trimming">11.1. Scaling and Trimming a Tomogram</A>
<BR><A HREF = "#Reorienting">11.2. Reorienting the Volume</A>
<BR><A HREF = "#Squeezing">11.3. Squeezing a Tomogram</A>
<BR><A HREF = "#Cleaning Up">12. CLEAN UP</A>
</UL>
<HR>
<P><A NAME = "WHATSNEW"><H3>
0. WHAT'S NEW IN IMOD 3.11
</H3></A>
This section lists significant changes or additions to this guide from the
3.9 version.
<UL>
<LI>More explicit instructions on handling bidirectional tilt series, in
<A HREF = "#Bidirectional Series">Tilt Series Taken in Two Directions from
Zero Tilt</A>
<LI>Modified advice on solving for linear distortion with fiducials on only
one surface (just don't do it) in 
<A HREF = "#Distortion One">Solving for Distortion - Fiducials on Only One
Surface</A>
<LI>Instructions on solving for nonperpendicularity between beam and tilt
axes, in 
<A HREF = "#Beam Tilt">Solving for Beam Tilt</A>
<LI>Using a target patch size instead of number of patches for local
alignments, in
<A HREF = "#Using Local Alignments">Using Local Alignments</A>
<LI>Running CTF correction and fiducial erasure procedures in the aligned
stack, at the command line, in
<A HREF = "#Making Aligned">Making and Processing the Aligned Stack</A>
<LI>Description of a problem with the initial transform collapsing in Z, in
<A HREF = "#Initial Problems in Combining">Initial Registration Problems
in Combining</A>

</UL>


<P>
<A NAME = "BACKGROUND"><H3>
1. BACKGROUND
</H3></A>
This is a guide to building single and dual axis tomograms with IMOD using
the eTomo interface.  It contains sufficient detail to serve as a reference
guide, which makes it less suitable when starting out.  The recommended
approach is to work through our <A HREF = "etomoTutorial.html">tutorial</A>
with a sample data set before trying
to use this guide to process your own data.

<P>
<A NAME = "Program Names"><H4>
1.1. Program Names
</H4></A>
In this document, program names are capitalized.  However, their true
names are all lower case, and they must be run by entering these names in
lower case because UNIX is case-sensitive.

<P>
<A NAME = "Command Files"><H4>
1.2. Command Files
</H4></A>
eTomo works with the same set of command files that used to be edited and
run on the command line in earlier versions of IMOD.  These files have
the extension <CODE>.com</CODE>, and when a command file is run,
program output is
recorded in a log file with the extension <CODE>.log</CODE>.  When you
open the panel for a particular step, eTomo
reads the existing contents of a command file to set the parameters
and settings that appear in the panel.
When you run an operation,
it writes the current parameters into the command file.  eTomo also
makes sure that the command file matches your entries when you leave a
panel by pressing <B>Done</B> or <B>Postpone</B> or simply by selecting
another panel with a button on the left.
<P>
You can run a command file at the command line with the "subm" alias,
which is defined in the IMOD startup files.
For example, if you enter "subm track", a file named
track.com will be executed in the background, a log file will be created
called track.log, and a message will appear when the command file is completed.
For more information on the format of command files and how to run
them, see <A HREF = "tomoExtra.html#Command Files">Command Files</A> in
the Extra Topics section.  If you want to make or edit command files, or if
you want to run programs at the command line, see also the section on 
<A HREF = "tomoExtra.html#Entries to Programs">Entries to Programs</A>.

<P>
<A NAME = "Numbering System"><H4>
1.3. Numbering System
</H4></A>
Sections or views in the image files are consistently numbered from 1
within
the graphical interface programs,
eTomo,
3dmod, and Midas.
However, many other programs in the IMOD package number coordinates
from 0, which was the original convention for MRC files.
If you work exclusively within eTomo, you need not be concerned
about this; but if you run other programs in the package you need to
be aware of this problem.
When a program refers to "view numbers", these are always numbered from
1; but when a program refers to "section numbers" or "Z values", there
is a good chance that they are numbered from 0.  The most important
example is the program <A HREF = "man/newstack.html">Newstack</A>, which is
often used for rearranging or extracting sections from a stack.

<P>
<A NAME = "Backup Files"><H4>
1.4. Backup Files
</H4></A>
     Nearly every program that you run will create a backup file if an output
file already exists, rather than simply deleting the old version of the output
file.  The existing file is renamed by adding a "~" at the end.
This can lead to some large
unneeded files if commands are run more than once.  It is helpful to have an
alias for purging backup files in your .cshrc: <BR><CODE> alias purge '\rm *~'
<BR></CODE>
 With this alias, "purge" will delete all backup files without asking for 
confirmation.

<P>
<A NAME = "Using Insecure Storage"><H4>
1.5. Using Temporary or Insecure Storage
</H4></A>
     It is possible to have your small working files automatically saved to
another directory every time that you run a command file.  This will provide
backup protection if you build tomograms in a disk area that is not regularly
backed up.  To use this feature, first be sure that the directory where you
will do your work and the directory where files should be saved both exist.
If you choose to copy your raw stacks to the working directory, which
you might want to do 
if this gives significantly
faster access, then you can proceed as described below.  If you want
to leave the raw stacks in the backed up location, then eTomo can
create links to them for you, but this will work best if you
start eTomo from the directory where you will build the tomogram.
<P>
     After every command file is run, the script "savework" will be run
automatically, copying files over to the source directory.  You can also run
"savework" yourself at any time (for example, after working on a fiducial
model for a while).

<P>
<A NAME = "Intensity Problems"><H4>
1.6. Problems with Intensities in 3dmod
</H4></A>
X-rays and other artifacts from the CCD camera can produce extreme intensity
values in the raw tilt series.  These effects can result in the images
looking terrible when loaded into
<A HREF = "man/3dmod.html">3dmod</A>, because the data are stored 
internally as bytes and the image features of interest occupy a very small
fraction of the whole dynamic range of the data.  Successful removal of
these artifacts will solve this problem (see <A HREF =
"#PRE-PROCESSING">PRE-PROCESSING: REMOVING X-RAYS</A>), but there are
also several remedies until that point is reached.
<P>
Once the data are opened in <A HREF = "man/3dmod.html">3dmod</A>, adjust the
Black and White sliders until the image features are visible in an
appropriate
contrast range.  Then use the menu entry <B>Edit-Image-Reload</B> to open a
dialog for rescaling the data.  Press <B>Apply</B> and the data will be
reloaded with the scaling indicated in the <B>Lower limit</B> and <B>Upper
limit</b> text boxes, and the Black and White sliders will be set to values
that allow the contrast to be decreased as well as increased.  Now that you
can see the images better, you can repeat this process if necessary - adjust
the contrast again, then press <B>Calc</B> then <B>Apply</B>.  Make a note
of the final values for the lower and upper limits.
<P>
Next time you need to load the data, press the relevant 3dmod-opening button
with the right instead of the left mouse button and select <B>Open with
Startup Window</B>.  In the Startup window, enter the lower and upper limits
from the rescaling dialog
in the <B>Scale intensities</B> text boxes.
<P>
If you cannot visualize the data at all in <A HREF =
"man/3dmod.html">3dmod</A>, then you need to look at the intensities in the
individual images with
<BR><CODE>
clip stat -2d setname.st
<BR></CODE>
Look at the minimum and maximum values for the sections.  You should see that 
some of them have extreme minima or maxima, while others have more
reasonable values.  Use the typical or reasonable minimum and maximum values
as the lower and upper scaling limits when loading the data into 
<A HREF = "man/3dmod.html">3dmod</A>.  If all sections show extreme minima
and maxima, possibly due to a bad column or row near the edge, use
<BR><CODE>
clip stat -2d -ix nx -iy ny setname.st
<BR></CODE>
where "nx" and "ny" are smaller than the full X and Y dimensions of the
data.  This will provide statistics over a subarea of the images.
<P>
Finally, if you can not get good dynamic range even after removing X-rays,
you should prevent the coarse aligned stack from being converted to bytes.
Go to Advanced mode in the <B>Newstack</B> section of the
<B>Coarse Alignment</B> panel in eTomo and uncheck <B>Convert to bytes</B>.

<P>
<A NAME = "NON-BOULDER NOTES"><H3>
2. NOTES FOR NON-BOULDER USERS
</H3></A>

<P>
<A NAME = "File Naming Conventions"><H4>
2.1. File Naming Conventions
</H4></A>
In order for the processing sequence to work, the names of your starting files
must follow several conventions.
The raw image stacks must have the extension ".st"; so for a single axis
tilt series the name should be dataSetName.st.  For a dual axis data set,
the two files must end in "a.st" and "b.st", i.e. dataSetNamea.st and
dataSetNameb.st.  The data set name can contain ".", "-", and "_" as
separators but must not contain spaces or other characters that could
confuse a Unix shell.
<P>
If you are supplying your own file of raw tilt angles, they must be named with
the data set name followed by ".rawtlt" (or "a.rawtlt" and "b.rawtlt" for a
dual axis tilt series.

<P>
<A NAME = "Film versus CCD Images"><H4>
2.2. Film versus CCD Images
</H4></A>
     Some of the programs make a distinction between images from film and ones
acquired on a CCD camera.  This is based on an obsolete method of
digitizing from film, in which tilt images were already in good translational
and rotational alignment after being digitized.  eTomo does not
currently handle the command files tailored to
data from film.  
If your data 
are already in very good alignment, the only disadvantage to
processing it in eTomo is that you will have to run the prealignment
step.  This is worth it to avoid editing and running command files by hand.

<P>
<A NAME = "Image Scaling"><H4>
2.3. Image Scaling and Contrast Polarity
</H4></A>
     The default parameters for reconstruction assume that the numbers in your
images are linearly related to the number of transmitted electrons caught
by the detector.  This is the case if images are recorded directly by CCD
camera or if film is digitized in optical density units.  The logarithm of
such values should then be proportional to projected mass density for imaging
dominated by amplitude (aperture) contrast.  Because of this, the
backprojection program, <A HREF = "man/tilt.html">Tilt</A>,
has an option to take the log
of the numbers after adding a base value (which might correspond to the
fog level of film).  The default is to take logs with a zero base
value.
If your images are already mass-normalized, you should
remove the zero entry in the <B>Log offset</B> box in the <B>Tomogram
Generation Panel</B>; if your images are in arbitrarily scaled
units, you may need to remove that entry or at least adjust the offset value
that is added so that all values will be positive before taking the log.
If you remove the log entry, you also need to change the <B>Output density
scaling factor</B> to 1; the default value is a large number that is needed to
scale the logs up again after backprojection.
<P>
If your data were derived from unsigned 16-bit integers and have had 32768
subtracted from them for storage as signed integers in the MRC file, the
programs will try to detect this and set the base to 32768.
<P>
     If electron density appears as white in your images, 
<A HREF = "man/beadtrack.html">Beadtrack</A> will
fail to track your fiducials properly with the default settings.
Simply change the 0 to a 1 in the <B>Fiducial marker size & polarity</B>
box in the <B>Fiducial Model Generation Panel</B>.
<P>
<A NAME = "Bidirectional Series"><H4>
2.4. Tilt Series Taken in Two Directions from Zero Tilt
</H4></A>
A tilt series taken by tilting in two directions from zero tilt often shows a
discontinuity in the aligned stack at the transition between the two halves of
the series.  Usually this reflects either an irregular tilt increment due to 
backlash in the goniometer, or changes in the specimen during the first half
of the series.  Because of these effects, you should always identify one half
of such a tilt series as a separate group in the 
<B>Separate view groups</B> fields on the 
<B>Fiducial Model Generation</B> and <B>Fine Alignment</B> panels.  These
entries will prevent the programs from assigning the same or similar values
for alignment variables to views that are not in the same half of the tilt
series.  
For
example, if the discontinuity occurs between views 71 and 72, enter "1-71" in
the <B>Separate view groups</B> fields.  
<P>
In some cases there appears to be a change in the
X-axis tilt of the specimen between the two directions of tilting.  It is
possible to correct for this effect by solving for a single change in X-axis
tilt in <A HREF = "man/tiltalign.html">Tiltalign</A>; see
<A HREF = "tomoExtra.html#Bidirectional X Tilt">
Correcting for X-axis Tilt in Bidirectional Tilt Series</A> in the Extra 
Topics section.

<P>
<A NAME = "INITIAL STEPS"><H3>
3. SETUP
</H3></A>
To work on a new data set, start eTomo and fill in the entries in the
<B>Setup Panel</B> that appears.
You need not start eTomo from the directory where the files are located.

<UL>
<LI><B>Dataset Name:</B> eTomo can work with either the full name of one of
the data files or the name of the data set, excluding "a", "b", and
".st".  The easiest way to specify the name is to push the browse
button and select one of the data stacks.

<LI><B>Backup Directory:</B> This field can remain blank, but see the
section above on 
<A HREF = "#Using Insecure Storage">Using Temporary or Insecure
Storage</A>
for an explanation of this option.

<LI><B> Axis Type:</B> Here, you select
whether the data are single or dual axis.

<LI><B> Frame Type:</B> These buttons are used to indicate whether only a
single image or a montage of overlapping frames was taken at each tilt.

<LI><B> Scan Header:</B> Push this button to attempt to retrieve the pixel
size and image rotation from the image file header.  This will work
with data from SerialEM on the Tecnai as well as with files using David
Agard's extended header format, which is also used in the FEI
tomography acquisition software.

<LI><B> Pixel size and Fiducial diameter:</B> These values are used only by
<A HREF = "man/beadtrack.html">Beadtrack</A>.  If you do not know the
pixel size, you can enter 1, and the measured diameter of the gold
particles in pixels.

<LI><B> Initial rotation:</B>
This is
the angle from vertical to the tilt axis in the raw images (e.g., if the axis
runs from top left to bottom right, the angle would be 45 degrees).
If the tilt axis is already vertical,
enter a 0.  If the tilt axis is horizontal, enter 90 to have the aligned
images be rotated clockwise from their current orientation, or -90 to have
them rotated counterclockwise.  This will determine the orientation of the
resulting tomogram as well as the handedness of structures within it.

<LI><B> Parallel processing:</B> This option sets the default for whether
parallel processing is enabled when you reach a panel where it can be used.

<LI><B> Image distortion field file:</B> Use this to select a distortion field 
file for correction of imaging distortion, if appropriate.  If the environment
variable IMOD_CALIB_DIR is defined, eTomo will open the file chooser at
$IMOD_CALIB_DIR/Distortion.  (Note that if this directory does not exist,
this field and the next two will appear only in Advanced mode.)  Once a
distortion field has been defined, it will be used when generating the coarse
aligned and final aligned stacks.

<LI><B> Binning:</B> This entry is relevant only if using distortion field
corrections and is needed to specify the binning at which
images were acquired on the CCD camera.

<LI><B> Mag gradients correction:</B> Use this to select a
magnification gradient table for correction of distortions due to
magnification gradients at high tilts.  To use this option, your raw
image stack must have
intensity values stored in its header.  If the environment
variable IMOD_CALIB_DIR is defined, eTomo will open the file chooser at
$IMOD_CALIB_DIR/Distortion.  When a gradient table has been defined, it will
be used to generate a list of the mag gradients for this particular
dataset, which is stored in "setname.maggrad".  These gradients will
be used when generating the coarse aligned and final aligned stacks.

<LI><B> Tilt angles:</B> eTomo provides three choices for getting the initial
tilt angles that are needed by <A HREF = "man/beadtrack.html">Beadtrack</A>,
<A HREF = "man/tiltalign.html">Tiltalign</A>, and
<A HREF = "man/tiltxcorr.html">Tiltxcorr</A>.  First, the angles can be
extracted from the extended header in the image file.  This will
work with files produced by SerialEM, as well as with files using the
Agard extended header format.
Second, you can specify the starting and increment tilt angles.
Third, you can supply a file with the tilt angles, one per line.
A file
with raw tilt values should be named "setname.rawtlt".  If you have 
regular angles with some variations, you may find a 
nearly correct file in $IMOD_DIR/com.

<LI><B>Exclude views:</B> If you know in advance that you want to exclude
some views from the reconstruction, you can enter the list of views in
this text box.  However, this is not essential; you will have a chance
to enter or add to such a list at later stages in the process.

<LI><B>Focus was adjusted between montage frames:</B>
When processing montaged images with correction for mag gradients,
this checkbox can be used to indicate that the montages were acquired
with the option to adjust focus for changes in Z height.
</UL>

Once you have made all of these entries, push the button to <B>Create
Com Scripts</B>.  eTomo will run the Copytomocoms script to produce
command files for processing the
data.  For a data set consisting of single frames, the files are as follows:

<UL>
<LI><B>Preprocessing</B>: uses eraser.com to run
<A HREF = "man/ccderaser.html">Ccderaser</A> to erase X-rays from images
<LI><B>Coarse Alignment</B>: uses xcorr.com to run
<A HREF = "man/tiltxcorr.html">Tiltxcorr</A> to get an initial
alignment by correlation
<BR>
  uses prenewst.com to run <A HREF = "man/xftoxg.html">Xftoxg</A> and 
<A HREF = "man/newstack.html">Newstack</A> to get a temporary pre-aligned stack
<LI><B>Fiducial Model Generation</B>: uses track.com to run
<A HREF = "man/beadtrack.html">Beadtrack</A> to generate a fiducial model
<LI><B>Fine Alignment</B>: uses align.com to run
<A HREF = "man/tiltalign.html">Tiltalign</A> to get the alignment
<LI><B>Tomogram Positioning</B>: uses sample.com to run
<A HREF = "man/newstack.html">Newstack</A> and the
<A HREF = "man/tilt.html">Tilt</A> command file on three regions 
<BR>
 uses tomopitch.com to run <A HREF = "man/tomopitch.html">Tomopitch</A>
to find the pitch of the section from a model on the three regions
<LI><B>Tomogram Generation</B>: uses newst.com to run 
<A HREF = "man/newstack.html">Newstack</A> to make an aligned stack
<BR>
 optionally uses mtffilter.com to run <A HREF =
"man/mtffilter.html">Mtffilter</A> to filter the aligned stack.
<BR>
 uses tilt.com to run <A HREF = "man/tilt.html">Tilt</A> to generate a tomogram
</UL>

<P>
Each ".com" file generates a corresponding ".log" file when it is
run.  In eTomo, you can examine a log file by clicking the
right mouse button over free space within a panel; the menu that pops up will
show the relevant log files for that panel.
<P>
     If you have a two-axis tilt series, you will get one copy for each
series, with names "...a.com" and "...b.com".
For convenience, most command files will be referred to
below by a name without an "a" or "b" (e.g., track.com), but in practice you
will always be running an "a" or "b" version when you have a dual tilt series.
<P>
     The man pages for the programs run by these command files give full
details on their operation and on the meaning of the entries to each.  Consult
them for any questions on the options available in these programs.
<P>
If you find that you need to run Copytomocoms by hand, see
<A HREF = "tomoExtra.html#Getting Files">Getting Command Files</A> in
the Extra Topics section for more details.
<P>
<A NAME = "Montage Coms"><H4>
3.1. Command Files when Montaging
</H4></A>
For a montaged data set, some command files and programs are
different, as follows:
<UL>
<LI><B>Coarse Alignment</B>: uses a different version of xcorr.com
that first runs
<A HREF = "man/blendmont.html">Blendmont</A> to generate a blended
stack that contains a subarea of the montage, up to 2K by 2K pixels.
This file, "setname.bl", will be used to get the
initial alignment by correlation
<BR>
  uses preblend.com to run <A HREF = "man/xftoxg.html">Xftoxg</A> and 
<A HREF = "man/blendmont.html">Blendmont</A>
to get the pre-aligned stack.
<LI><B>Tomogram Positioning</B>: uses a different version of sample.com to run
<A HREF = "man/blendmont.html">Blendmont</A>
and the
<A HREF = "man/tilt.html">Tilt</A> command file on three regions 
<LI><B>Tomogram Generation</B>: uses blend.com to run 
<A HREF = "man/blendmont.html">Blendmont</A>
to make an aligned stack
</UL>
<P>
<A NAME = "PRE-PROCESSING"><H3>
4. PRE-PROCESSING: REMOVING X-RAYS
</H3></A>
<P>
As mentioned above, X-rays and other flaws in CCD camera images can produce
extreme low or high values that ruin the contrast when you view the images
in <A HREF = "man/3dmod.html">3dmod</A>,
and they can also give undesirable artifacts in the reconstruction.  These
defects can be wiped out with <A HREF = "man/ccderaser.html">Ccderaser</A>,
which finds X-rays in two ways.  It looks for "peaks", or pixels whose
intensity deviate from the surrounding pixels
by a certain number of standard deviations, which is
specified in the <B>Peak criterion</B> text box.  It also looks for
pixel-to-pixel differences that exceed background by a certain number
of SDs, specified in the <B>Difference criterion</B> text box.
<P>
When <A HREF = "man/ccderaser.html">Ccderaser</A> runs, it produces an 
IMOD model marking the pixels that
were found.  Press the <B>View X-ray Model</B> button to see this
model.  Points are sorted into different objects based on how much they
exceeded a criterion (less than 1 SD for object 1, 1-2 SDs for object
2, etc.).  You will probably be surprised at how many points are
marked, possibly on the order of 100 points per image for a 2K by 2K
camera.  In our experience, the default criteria are conservative for
unbinned images and
all of these points are indeed X-rays.  However, in binned images, the
difference criterion may pick up some pixels on the edge of gold
particles used as fiducials.  If you see this happen, you can prevent it by
raising the difference criterion to 10 or more.
<P> 
If you want see the effects of changing criteria, you can save time by
running in trial mode, using the <B>Find X-rays</B> button.  The
program will analyze images and produce a model without writing an
output image stack.
<P>
When you press the <B>Create Fixed Stack</B> button, 
<A HREF = "man/ccderaser.html">Ccderaser</A> writes the corrected
images into a file named "setname_fixed.st".  If you are satisfied
with the result, press the <B>Use Fixed Stack</B> button to rename
the original file to "setname_orig.st" and replace it with the fixed stack.
<P>
If you find that some X-rays are too large to be removed with the default
parameters, increase the <B>Maximum radius</B> to encompass these large
X-rays and try again.  If the larger radius causes inappropriate points to be
corrected, then do the removal in two stages.  First create a fixed stack with
the smaller radius, and press <B>Use Fixed Stack</B>.  Then increase both the
radius and the criterion so that only the large X-rays are removed, and
rerun the removal.  Press <B>Use Fixed Stack</B> again if you are satisfied
with the result.
<P>
If your images have other features that do not get corrected by the
automatic X-ray removal, you can specify the pixels to erase in a
model file.  Press the <B>Advanced</B> button to reveal the controls
for this option, and see the man page for 
<A HREF = "man/ccderaser.html">Ccderaser</A> for
details on how to construct the model file.
<P>
With a montaged data set, when you view the X-ray model, the images
will be loaded into <A HREF = "man/3dmod.html">3dmod</A> as single
frames instead of as a montage, so that all parts every frame can be
viewed.  However, this feature does make it difficult to page through
the images.
<P>
<A NAME = "COARSE ALIGNMENT"><H3>
5. COARSE ALIGNMENT BY CROSS-CORRELATION
</H3></A>
The main purpose of this step is to get the images aligned well enough for
the automatic tracking of fiducials to work.  There are generally no
parameters to adjust, so you proceed by pushing the top three buttons
in sequence.  
<UL>
<LI><B>Calculate cross-correlation</B> uses <A HREF =
"man/tiltxcorr.html">Tiltxcorr</A> to determine the X and Y
translations needed to align each image with the previous one.
<LI><B>Generate coarse aligned stack</B> converts these translations
from one view to the next into translations that will bring all of the
images into alignment.  It then applies the latter translations to
produce the aligned stack.
<LI><B>View aligned stack in 3dmod</B> to check whether images are
adequately aligned.  If you see sudden jumps in feature positions, you
need to adjust the alignment by hand.  If there are only gradual
shifts in alignment, such as a drift in apparent tilt axis location at
high tilt, you do not need to adjust for this.
</UL>
<P>
Press <B>Fix Alignment with Midas</B> only if you need to adjust some
of the alignments.  This will start <A HREF =
"man/midas.html">Midas</A> on the raw image stack, with the alignment
transformations determined on the first step.  Go to the pairs of
views that showed problems, and use the left mouse button to translate
each pair of images into alignment.  When you toggle between a pair of
images, you should see the section appear to tilt around an axis in
the middle.  The tilt axis should appear to be vertical because 
<A HREF = "man/midas.html">Midas</A> applies a global rotation to the images,
starting with the value in the <B>Tilt axis rotation</B> text box on 
the <B>Coarse Alignment</B> panel.
If you have a big magnification change, you could also
correct for this using the right mouse button while holding the Shift
key down.
<P>
After fixing and saving transformations, you must generate a new coarse 
aligned stack.
<P>
The coarse aligned stack will be used for tracking the fiducial model, and
there might be cases where you want to work with binned images for this
procedure.  You can set a binning for this stack by pressing the
<B>Advanced</B> button then adjusting the entry for 
<B>Coarse aligned image stack binning</B> before generating the stack.
If you change your mind after starting to work on a fiducial model, you can go
back to this panel, change the binning, and generate a new prealigned stack.
The existing model will load correctly onto the stack with the new binning;
just be sure to save the model after doing this and eventually run the fine
alignment, which will synchronize
all information about the pixel size.
<P>
<A Name = "Fiducialless Quick"><H4>
5.1 Making a Quick Tomogram with Correlation Alignment
</A></H4>
It is possible to generate a tomogram using only the coarse alignment from
cross-correlation.  This could be used to get a tomogram quickly to see
whether it is worth doing the fiducial alignment, or if the tilt series was
just for scanning purposes, or if there are no fiducials.  This section
describes a
simple procedure for getting a tomogram quickly; for more detail on how to get
as good a tomogram as possible from this procedure, see
<A HREF = "tomoExtra.html#Fiducialless Tomogram">Making a Tomogram with 
Correlation Alignment</A> in the Extra Topics section.
<OL>
<LI>Press <B>Calculate cross-correlation</B>.
<LI>Check <B>Fiducialless alignment</B>
<LI>Press <B>Done</B>.  There is no need to make a coarse aligned stack in
this panel because its tilt axis is not vertical.
<LI>Press <B>Done</B> on the <B>Tomogram Positioning</B> panel to get to the
<B>Tomogram Generation</B> panel.
<LI>Adjust the <B>Tilt axis rotation</B> if it does not match the values that
you usually get for rotation angle in a fiducial alignment solution at this
magnification.
<LI>Select an appropriate binning, then press <B>Generate Full Aligned
Stack</B>.  The speed of tomogram computation is roughly proportional to the 
cube of the binning.
<LI>Press <B>View Full Aligned Stack</B> and check the alignment.  If
something needs to be fixed, press <B>Coarse
Alignment</B>, then <B>Fix Alignment with Midas</B>.  After fixing the
alignment, come back to the <B>Tomogram Generation</B> panel.
<LI>Set an appropriate <B>Tomogram thickness in Z</B>.  Thickness is specified
in unbinned pixels so that its value is independent of the selected binning.
<LI>Press <B>Generate Tomogram</B>.
</OL>
<P>
If you need to set the position of a tomogram built with fiducialless
alignment, see the <A HREF = "tomoExtra.html#Fiducialless Tomogram">Extra
Topics</A> section.  It is recommended that you NOT do this if you plan to go
back and do the fiducial alignment procedure.
<P>
<A NAME = "Fixing Montage Edges"><H4>
5.2. Fixing Montage Edges
</A></H4>
For a montaged data set, the <B>Coarse Alignment</B> panel also
provides controls for fixing errors in the displacements between
frames.  <A HREF = "man/blendmont.html">Blendmont</A> analyzes the overlap
regions between adjacent pieces and determines how to shift the pieces into
registration.  Sometimes this analysis fails and a few of the shifts are
wrong.  It is important to fix these errors before going on to build the
fiducial model, because when the displacements are
changed, image positions in the blended image change as well.
There are two ways to tell if there are shifts that need fixing.
<OL>
<LI>For a montage with more than one piece in each direction, you can
examine the registration errors in the xcorr.log file.  The beginning part
of this file shows the output from 
<A HREF = "man/blendmont.html">Blendmont</A>.  For each section
in the file, you will see a line giving the "mean, max error before ... after
...".  These errors are the amounts of image displacement that 
<A HREF = "man/blendmont.html">Blendmont</A> thinks
are present in the overlap zones between adjacent pieces of the montage.  The
error before shifting the pieces around will generally be large (a few to
many pixels).  The error
after pieces have been shifted into optimal registration should be small and
smoothly varying with tilt angle.  If magnification gradients are not large
or have been
corrected for, the error is usually less
than 0.5 pixels.  Otherwise, the error may increase gradually from a
fraction of a pixel at low tilt to several pixels at high tilt.  Look
through the list of errors for sections where the error is abnormally high
relative to the nearby sections.  These are the sections where
<A HREF = "man/blendmont.html">Blendmont</A> was probably not able to
measure one or more image displacements accurately enough.  Note which
sections need to be fixed and add 1, since
sections are numbered from 0 in this output but from 1 in 
<A HREF = "man/midas.html">Midas</A>.
<LI> You can also see edge displacement errors by building a coarse aligned 
stack and looking at it carefully while riffling through the views.
If there is an error, you should see one frame of a picture shift out of
alignment with the corresponding frame in the adjacent views.  This is the
only way to detect errors when your montage consists of a single row or a
single column.
</OL>
<P>
To fix displacements, press <B>Fix Edges With Midas</B>.  If you are
correcting for magnification gradients or image distortion fields,
you will first have to press <B>Make Distortion Corrected Stack</B>.  
This step is necessary because you need to
visualize overlaps in the same images that 
<A HREF = "man/blendmont.html">Blendmont</A> is analyzing, namely
distortion-corrected images.
<P>
When <A HREF = "man/midas.html">Midas</A> starts,
enter the view number of a section with a large error in the Current
Section text box.  The control panel has push-buttons for the four edges with
the worst errors; use these to select the edge with the worst error.  Toggle
between the two pieces to visualize the registration in the overlap zone.  If
it looks bad, shift the Current piece into alignment (the Apply Leave-out
Error button can be a useful shortcut if this is the only piece with an error
-- see the 
<A HREF = "man/midas.html">Midas</A>
 man page for explanation.)  If the overlap looks fine, simply
go on to another edge; you will probably find the error there.  This
potentially confusing situation may be quite frequent, because whenever a bad
edge involves a corner piece of the montage, its error is spread equally
between the two edges of that piece.  It will thus look like there are two
equally bad edges when only one is bad.
<P>
After you correct the displacement at an edge, the push-buttons will
rearrange and show new maximum errors.  Once the maximum error is down to 0.3,
you can go on to another section.  When you are done, save the edge
correlation displacement file and exit.  Your corrected displacements will
automatically be used when 
<A HREF = "man/blendmont.html">Blendmont</A> is run again, and 
<A HREF = "man/blendmont.html">Blendmont</A> will 
build new edge functions on its next run, because the edge functions depend
partly on the displacements that you just modified.

<P>
<A NAME = "GETTING FIDUCIAL"><H3>
6. FIDUCIAL MODEL GENERATION
</A></H3>
     The first step is to set up a seed model.  Press
<B>Seed Fiducial Model Using 3dmod</B> to open the prealigned stack and
an empty model in <A HREF = "man/3dmod.html">3dmod</A>.
The <A HREF = "3dmodHelp/beadfix.html">Bead Fixer</A> module will also open 
in a mode that has features to help with
the seeding process.  These features are:
<OL>
<LI><B>Autocenter</B>, which is turned on by
default in this mode.  This will allow you to position the cursor near a bead
and add a point; the program will place the point on the center of gravity of
the bead.  For beads lighter than background, select <B>Light</B>.
<LI> <B>Automatic new contour</B>, which makes a new contour
when you pick a new bead.  This is helpful because each bead must be in a
separate contour; 
<A HREF = "man/beadtrack.html">Beadtrack</A>
will try to extend each contour through the tilt series.  
Once you turn this option on, it will stay on between
Bead Fixer sessions.
<LI><B>Overlay</B>, which displays the view
being seeded and a nearby view in magenta-green overlay.  This feature is
intended to help you pick a good distribution of beads when they are on two
surfaces.  In the overlay, each bead will show up in magenta on the view being
seeded and in green on the nearby view; the green will appear to the left or
the right depending on which surface the bead is on.  Click near the bead in
magenta to add it.  If you use reversed contrast to make the beads show up
more clearly, the bead on the current view will still appear in magenta.
</OL>
<P>
Pick a view near zero tilt that has good images of the
beads.  Put one point in the center of each desired bead.
Beads too
close to the edges are not trackable by 
<A HREF = "man/beadtrack.html">Beadtrack</A> but could be tracked by hand
if necessary.  Try to have at least 8 beads well distributed over the area,
and well distributed between the two sides if they are on two surfaces.
The more beads you have, the better the alignment will be, up to a point, but
the more work it may take for you to complete the model.
If the beads are all on one surface, there is
not much point in having more than 12 or so; if they are on both surfaces, 20
or more may be useful.  However, for areas larger than 1000x1000 pixels,
you will probably need to use local alignments, in which case you should have 
at least 
8-12 fiducials per 1000 by 1000 pixel area 
acquired with a CCD camera, or
6-8 fiducials per 500 by 500 pixel area digitized from film.  (See
<A HREF = "#Using Local Alignments">Using Local Alignments</A>.)
Save the seed model when you are done.
<P>
<A HREF = "man/beadtrack.html">Beadtrack</A>
proceeds from one view to the next, tracking as many beads as
possible on the new view.  Once it has bead positions on enough views, it runs
a simplified tilt alignment to get improved predictions of where beads should
be and to reject erroneous positions.  This procedure usually works well on 
small data sets, but may perform poorly when the data included in the tilt
alignment do not give a good fit.  The data can fit poorly when they are
from a large area or when the tilt series includes very high angles.  To
address this problem, 
<A HREF = "man/beadtrack.html">Beadtrack</A> provides two ways to restrict
the data so it fits the alignment better:
1) the tracking can be done over a series of overlapping subareas, so that
the fit to the data is similar to that available when using local
alignments; and 2) the 
number of views included in the tilt alignment can be restricted, so that
high angle data from both ends of the tilt series are not included in the
same fits.  For particularly difficult data, both methods can be used.
<P>
Most standard entries to <A HREF = "man/beadtrack.html">Beadtrack</A>
should work well, so in Basic mode eTomo shows only a few of the many
parameters.
<OL>
<LI>  <B>View skip list</B> Enter or adjust the list of views to be
skipped over.  If you put entries into the <B>Exclude views</B> field in the
eTomo Setup window, these values will be carried over to this box.
Skip over a view if
there is a big mag change for that view only, or a particularly poor image for
that view.
Typically you would leave this entry blank on a first run and enter a
view number
here for a second run if the program fails to track accurately through that
view.
<LI> <B>Separate view groups</B> Specify one or more lists of views
that should be kept out of groupings with adjacent
views.  There are two reasons to do this.  Your data might have a
sudden
lurch in magnification or tilt angle, and you want to avoid having
views on both sides of this discontinuity assigned the same value
for such variables.  Taking a tilt
series in two directions from zero degrees instead of all in one direction
introduces such a discontinuity; you should always define a separate view
group for tilt series taken this way (see the section on
<A HREF="#Bidirectional Series">bidirectional tilt series</A>).
In cases of discontinuity, you would list all the views up to
the discontinuity (or all of the views after it).  Secondly, there
might be views that don't match the surrounding ones for
some other reason, such as having been taken on a second pass through
the tilt series.  Enter a list with no embedded spaces, and use a
space to separate multiple lists, e.g., if there is a discontinuity
between views 30 and 31, and 62, 72, and 81 were taken separately,
enter "1-30 66,72,81".
<LI> If you have partially tracked a bead in the seed model and left a gap
because of ambiguity, you should uncheck <B>Fill seed model gaps</B>.
<LI> <B>Local tracking</B>  Select this option if you want to do tracking in
overlapping, local subareas.  Once it is selected, you can change the value
in the <B>Local area size</B> text box, which specifies a target size for
the local areas.  The default size is rather large and smaller values may
give better results in some cases.
<LI><B>Max # of views to include in align</B>  Put a value in this text box
to make the tilt alignments fit to data from a restricted range of views.
Try a value equal to half the number of views in the series.
<LI> If you have finer than 1 degree tilts, you may need to increase the
<B>Minimum # of views for tilt alignment</B> (in Advanced).
</OL>
<P>
Press <B>Track Seed Model</B>.  Open the track.log file and
skip to the end to see a summary of which beads
could not be tracked completely.
If several beads fail to track past a particular view, you might want to
add that view to the list of views to be skipped and rerun the tracking.
<P>
Next press <B>Fix Fiducial Model</B> to read the new
fiducial model into <A HREF = "man/3dmod.html">3dmod</A>.  The Bead Fixer
dialog box will appear in the gap-filling mode.
It will allow you to jump from one gap in
the data to the next and fill in missing points if appropriate.  It is
acceptable for some of the points to be missing on some of the views.  If too
few of the points can be extended all the way to the first or last views, you
can add some fiducials that are present only in higher tilt views.  Just be
sure to add them on a substantial number of views, not just on a few, so that
their 3-D positions can be solved for accurately.  If you do need to add
several fiducials, you could put some "seeds" into your edited fiducial model
and allow Beadtrack to track those beads as far as possible.

<P>
<A NAME = "Reseeding Model"><H4>
6.1. Using Beadtrack to Extend a Model
</A></H4>
Sometimes you will want to have <A HREF =
"man/beadtrack.html">Beadtrack</A>
start with an existing
fiducial model instead of a seed model.  This is especially helpful when there
are a large number of beads that failed to track.  For example, you might
extend some fiducials past a view where they failed to track then try to get
<A HREF = "man/beadtrack.html">Beadtrack</A> to track them the rest
of the way,
or you might want to add fiducials when you realize that you
need to use local alignments.  To use the existing fiducial model as a seed for
another run, press <B>Track with Fiducial Model as Seed</B>.
Your original seed model will be renamed to setname_orig.seed the first time
that you do this.  Then press <B>Fix Fiducial Model</B> to read the retracked
model into <A HREF = "man/3dmod.html">3dmod</A>.  You can repeat this
operation as many times as needed. This procedure will tend to fill in gaps in
the model, which is usually
appropriate.  However, if you have already left some gaps in the model
because of ambiguities, you should uncheck <B>Fill seed model gaps</B>.

<P>
<A NAME = "Transferring Fiducial"><H4>
6.2. Getting Fiducials for a Second Axis
</A></H4>
If you are doing a double-tilt series, at least some (8-10) of the beads
that you track must be the same in the two series.  The shell script 
<A HREF = "man/transferfid.html">Transferfid</A> will help ensure this
by making a seed model for the second axis based on the fiducial model
for the first axis.  To use this tool, complete your fiducial model
for the
first axis.  
Proceed through the coarse
alignment steps for the second axis until you reach the 
<B>Fiducial Model Generation</B> panel.
If your
tilt angles are not in ".rawtlt" files, you also must fill in the view
numbers of the zero-tilt views in the <B>Center view</B> text boxes
(visible in Advanced mode).
Press <B>Transfer Fiducials from Other Axis</B> to begin the operation.
<A HREF = "man/transferfid.html">Transferfid</A>
will search for the pair of views in the two series
that correspond the best, then transfer the fiducials from the first
series to make the seed model for the second series.  At the end, the
program indicates the number of fiducials that failed to transfer and how
the contour numbers correspond between the first fiducial model and the new
seed model.  This information is saved in a 
transferfid.log file.  
<A HREF = "man/transferfid.html">Transferfid</A> also creates a file called
"transferfid.coord" with the information needed for the first stage of the
tomogram combining procedure to determine how fiducials correspond between the
two tilt series.  As long as this information is available, you can add and
delete fiducials from either tilt series after doing the transfer, and
the combining procedure will still be able to tell which fiducials correspond.
<P>
If <A HREF = "man/transferfid.html">Transferfid</A> fails to work
on the first attempt (as indicated by an unusually large number of fiducials
that failed to transfer or a seed model that contains incorrect model
points), you may need to set the translational and
rotational alignment between the two series manually with 
<A HREF = "man/midas.html">Midas</A>.  To do this, just check 
<B>Run midas</B> and run the transfer again.  
<A HREF = "man/midas.html">Midas</A> will start up with the center
views from the two tilt series.  Adjust the alignment with translation
and
rotation (left and middle mouse buttons).  Do not be alarmed if you
have to rotate the image by 180 degrees, just select <B>Interpolate</B> to
get a good rotated image.  You will find that the images cannot be aligned 
if the sample
was turned upside-down between the two tilt series; if so, select "Mirror
around X-axis" from the Edit menu and then align the images.
Save the transformation and
exit.  The search for the best corresponding pair of views will
proceed using this starting alignment.
<P>
The Advanced mode allows you to indicate that mirroring is needed, so if you
know that the sample was inverted, you can select just this option and run the
operation without having to run <A HREF = "man/midas.html">Midas</A>.
In Advanced, you can also specify the views to search around 
and limit or expand the number of views in the search.  As a last
resort, you could set the <B>Number of views in the search</B> to 1
and set the alignment as well as possible in <A HREF =
"man/midas.html">Midas</A>, including a magnification change and stretch.
<P>
If the transfer operation still fails, you
can run <A HREF = "man/3dmod.html">3dmod</A>
on both stacks at once and add some initial points to the second seed
model in the same order that they occur in the first fiducial model.  It
is helpful to open one of the images in the Slicer window and rotate
it by 90 degrees with the Z slider.  You
only need to make the first 5 beads correspond, or however many are
needed to sample beads on both surfaces, if beads are on two surfaces.
After that, you can add the rest in any order.
If
you do this, then when you prepare to combine the two tomograms, you would
specify that only the first 5 beads correspond.

<P>
<A NAME = "FINAL ALIGNMENT"><H3>
7. FINE ALIGNMENT
</H3></A>
The goal of the final alignment is to transform the images so that they
represent projections of a solid body tilted around the Y axis, as well as to
refine the projection angles.  In order to transform the images, one needs to
determine the rotation, translation, and scaling (magnification) to be applied
to each image.  It is also possible to solve for variables which will correct
for linear distortions of the specimen.
<P>
<A NAME = "Running Tiltalign"><H4>
7.1. Running Tiltalign
</A></H4>
     Whether you have fiducials on one surface or two determines what
variables can be solved for.  If there are beads on only one surface, you can
solve for either tilt angles or stretch in the X direction but not both.  If
there are beads distributed through the
depth of the sample (typically but not necessarily on two surfaces), 
you can solve both for tilt angles and for
distortion, or for tilt angles and compression, but not for all three kinds of
variables.
<P>
Before computing an alignment for the first time, check the following
settings in the <B>General</B> parameter page:
<OL>
<LI> <B>Separate view groups</B>.  Specify one or more lists of views
that should be kept out of groupings with adjacent
views.  See the discussion of the corresponding entry to 
<A HREF = "man/beadtrack.html">Beadtrack</A> under
<A HREF = "#Getting Fiducial"> Fiducial Model Generation </A>.
<LI> <B>List of views to exclude</B>.  Add to or adjust the views to be
excluded, if necessary, in this text box.  Again, if you entered 
<B>Views to exclude</B> in the eTomo Setup
window, they will be carried over to this box.
<LI> <B>Assume beads on 1 or 2 surfaces for surface analysis</B>.  Change this
to 1 if the beads are not located on two distinct surfaces.  Note that
this setting does not affect the actual alignment solution, just the
analysis of the orientation of the section surface in space, which is done
after the alignment solution is obtained.
</OL>
<P>
Press <B>Compute Alignment</B> and examine the results in the log file after
the process is done.  The lengthy log file has been split into useful
sections under different tabs.  The first page that you see, <B>Errors</B>,
shows two useful summary values.  One is the ratio of measured values to
unknowns, which provides an indication of how robust the solution is against
random errors and of whether there might be too many independent variables
being solved for.  The other is the residual error mean, a global measure of
the quality of the fit.  A residual error is the distance in pixels between the
measured position of a fiducial on a view and the position predicted by the
alignment solution.  You can view a model of the residuals at every point,
exaggerated by a factor of 10, by pressing the <B>View Residual Vectors</B>
button (see <A HREF = "#Residual Model Output">Residual Model Output</A>).
This feature is particularly useful for assessing whether you need
to use local alignments.
<P>
The <B>Solution</B> page shows the value of some of the alignment variables
for each view.
Examine the tilt angles, looking for places where
they change by unusual amounts.  The column labeled "deltilt" shows the
difference between the solved
tilt angle and the original, nominal tilt angle.  This column should change
gradually when tilt angles are grouped.  Tilt angles are grouped by default
because low tilt angles cannot be solved for accurately without grouping (see
below).  The
"mag" column shows the effect of overall shrinkage and slight magnification
changes due to changes in focus.  If the "mag"
column shows a sudden
change that is much larger than surrounding changes, consider making
all of the views after this change be a separate view group,
as described above.  For the variables that are grouped, this
will keep views on the two sides of the transition from being constrained
to having the same or similar values.
<P>
The last column on the <B>Solution</B> page, "mean resid", shows the mean
error (residual) in pixels for all
of the points on each particular view.  This information will reveal whether
some views give a poorer fit than others.
<P>
The <B>Surface Angles</B> page shows the results of an analysis of the
solved bead positions in 3D and recommends a 
change in tilt angles that would make the beads lie in a
horizontal plane. 
Make the recommended
change at least after the first run of 
<A HREF = "man/tiltalign.html">Tiltalign</A> by taking the value
shown for "Total tilt angle change" on the last line and using it in the 
<B>Total tilt angle offset</B> text box.
It is not necessary to do
this repeatedly because the final tilt angle offset will be determined
in a later processing step.
<P>
You can open the <B>Large Residual</B> page to see the list of
fiducials with the largest errors, but it is easier to deal with this
information from the Bead Fixer dialog in
<A HREF = "man/3dmod.html">3dmod</A>, which is opened in big residual mode 
when you press
<B>View/Edit Fiducial Model</B>.  The Bead Fixer is told what log file to
read, so you can proceed without pressing
<B>Open Tiltalign Log File</B>.
Examine the points in turn by pressing the <B>Go to Next Big Residual</B>
button (or the apostrophe hot key), paying particular attention to ones with
errors greater than 2 pixels.  Adjust point positions in the
model, if appropriate.  When you want to recompute the alignment after fixing
some points, you can press <B>Save & Run Tiltalign</B>, which will save the
model, rerun <A HREF = "man/tiltalign.html">Tiltalign</A>, and read in the new
log file.  There is one trap to this convenience button: Bead Fixer has no way
of knowing if you have changed parameters in eTomo, so when you do change
alignment parameters, you must compute the alignment through the button in
eTomo instead.  The Bead Fixer will be told to reread the log file after the
alignment is done.
<P>
You could also open the <B>Fiducial Coordinates</B> page to see the 3D
coordinates that have been solved for the fiducials, but it is easier to
visualize these points in 3dmodv by pressing the <B>View 3D Model</B>
button on the <B>Fine Alignment</B> panel.  If you indicated that points are
on two surfaces, then the points will be sorted into two objects based on
which surface <A HREF = "man/tiltalign.html">Tiltalign</A> thought they were
on.  This is a good way to assess whether the points are well enough
distributed on both surfaces to support solving for distortion, particularly
when local alignments are to be used.

<P>
<A NAME = "Background Grouping"><H4>
7.2. Background on Grouping Variables and Solving for Linear Distortion
</A></H4>
Before you get into trying to solve for linear distortion and grouping
variables, you should be aware of several points.  First, variables are
grouped in order to reduce the number of variables being solved for.
Instead of solving for a different tilt angle for each view, with grouping
by 5 the program will solve for a tilt angle for every fifth view and determine
the angle for the rest of the views from the ones that it is solving for.
This reduces the number of tilt variables being solved for by a factor of 5,
and also averages over a larger number of measurements when solving for
each individual value.  Because of this averaging out of random errors, 
grouping will actually give a more reliable solution for variables that are
hard to solve for, such as tilt angle near zero degrees.  It is for this
reason that you should always use grouping of tilt angles even when
you are not solving for distortion.  The reduction in number of variables by
grouping becomes particularly important when you have a large number of
fiducials (e.g., more than 150) or a large number of views (e.g., more than
140).  In these cases, the program may have trouble finding a solution
unless you also group some variables that are not grouped by default, namely
rotation angle and magnification.
<P>
The grouping of variables can be done in two different ways.  In one way,
the particular parameter will change linearly from the first view in one
group to the first view in the next group, and will appear to change
smoothly over the whole tilt series.  This is referred to as linear grouping
or linear mapping.  This method is used for every variable except stretch
along the X-axis.  For that variable, all of the views in a group will have
exactly the same value.
<P>
     The next point concerns the nature of the distortion solution, a
strange beast.  Even if the only thing happening to the section is a stretch
along the X-axis, solving for distortion will successfully account for these
changes, but the resulting solution will not numerically reproduce the
amount of stretch.  The problem is that there is an infinity of equivalent
solutions, which all account for the distortion equally well, but differ in
the geometry of the resulting reconstruction.  This geometric difference is a
"strain", a shifting in Z proportional to the X value of a column of
pixels.  Without additional information about the section, there is no way to
recover its true structure, and the actual amount of stretching that occurred.
The program needs to pick one solution out of the equivalent ones, and it does
so by eliminating one variable; thus you will notice a variable listed as
"dummy" in the <B>Mappings</B> page of the log file.
Typically, this arbitrarily selected
solution will change the most at high tilt angles, sometimes dramatically so,
even though the actual changes in the section happen at a nearly constant rate
through the series.
<P>
     The distortion solution will also account for thinning when tilt angle is
allowed to vary as well.  The equations governing this situation dictate that
the X-axis stretch change rapidly at the highest tilts, even if thinning
occurs at a regular rate through the series.  Thus, regardless of whether
there is section distortion or thinning, or both, it is almost inevitable that
the X-axis stretch will change most rapidly at high tilt.
<P>
The last point to be aware of is that some group sizes will vary with
tilt angle.  Group size for tilt angle will be
proportional to the cosine of the angle, and will be set so that the average
size equals the value that you specify for grouping.  Because of the peculiar
behavior of the X-axis stretch, its group size will change even more with tilt
angle.
<P>
     Finally, be aware that including distortion can lead the program into
inappropriate solutions, in which the tilt angle and the X-axis stretch covary
excessively.  This can occur when there are too few fiducials, too great an
imbalance between the number of fiducials on the two surfaces, substantial
random errors in the locations of the model points, or a ratio of measurements
to unknowns that is too low.  The potential remedies are to increase group
sizes or to give up on solving for distortion.

<P>
<A NAME = "Distortion Two"><H4>
7.3. Solving for Distortion - Fiducials on Both Surfaces
</A></H4>
To solve for distortion, open the <B>Global Variables</B> page of the
<B>Fine Alignment</B> panel and select <B>Full solution</B> in the 
<B>Distortion Solution Type</B> section.  This will automatically switch
to some good default values 
if you have fiducials on both surfaces, namely a grouping of 5 for tilt
angles (if they are not already grouped), 7 for the stretch variable, and 11
for the skew variable.
Grouping is important when solving for distortion because it dramatically
reduces the number of variables to be solved for, averages out random errors
better, and gives a more robust solution.  The typical range for group sizes
would be:
<UL>
<LI> 3 - 10 for tilt angles.
<LI> 5 - 10 for X-stretch.
<LI> 7 - 15 for skew angle.
</UL>
<P>
     You would want to pick the low end of these ranges of group sizes if an
alignment run reveals that one of the distortion variables changes especially
quickly (but don't be fooled by big changes for pictures taken out of
sequence).  Conversely, if the ratio of measurements to unknowns is lower
than 4-5, you would want to make
the default group sizes large.  In this case, you could also switch to grouping
rotation and magnification variables as well, provided that the solutions
for these variables already looks fairly smooth.
<P>
The stretch variable ("dmag" in the <B>Solution</B> page of the log file)
will typically range from 0.001 to 0.02 but
can easily reach 0.05 at high tilts.  If you get values larger than 0.05, or
if you get changes in tilt angle ("deltilt") more than 2 degrees,  you
should increase the group size and see if the range of values decreases,
particularly if you have only 3-5 fiducials on the surface with fewer
fiducials.  If the range decreases substantially, stick with the larger group
size.  You can also increase the grouping for skew and tilt angles to try
to get a better-behaved solution.  If a solution seems unreasonable, either
abandon the attempt to solve for distortion, or solve for skew angle only, as
described in a few paragraphs.
<P>
     The skew is an angle in degrees and will typically range from 0 to 1
degrees.  Values greater than about 0.2 degrees are worth correcting for, and
a change of more than about 0.3 degrees from one group to the next would be a
big change.
<P>
If you have discovered that there is some sudden change in alignment such
that two views should not be grouped together, then the simplest thing to 
do is to specify a <B>Separate view group</B> on the <B>General</B>
parameters page.  For example, if there is sudden change between views 30
and 31, enter 1-30 in this text box; more than one separate group can be
entered
if they are separated by spaces. 
<P>
A finer degree of control over grouping
of an individual variable can be achieved by making an entry in the
<B>Non-default groupings</B> text box that appears in Advanced mode for each
variable.  To use a non-default grouping, enter the starting and ending
view number and the group size, separated by commas.  For example,
if the default grouping for X-stretch is 10, but you
want smaller groups for the first and last 20 views of a 121-view tilt
series, then enter "1,20,5 102,121,5".  Separate different non-default
groupings with spaces, as in the example.
<P>
     A good alignment has a mean residual error of 0.25 to 0.5 pixels, or more
for larger gold particles or images acquired at smaller pixel sizes (less
than 1-1.5 nm).

<P>
<A NAME = "Distortion One"><H4>
7.4. Solving for Distortion - Fiducials on Only One Surface
</A></H4>
If you have fiducials on only one surface, or only a few fiducials on one
surface, you can't properly solve for
both tilt angle and distortion.  If the section has thinned but not distorted,
then allowing the tilt angles to vary will correct for the thinning.  If the
section has distorted but not thinned, then solving for distortion with fixed
tilt angles is appropriate.  In reality, both phenomena occur, and section sag
can also make the tilt angles inaccurate, so that fixing them
completely is likely to be problematic.  The simplest and safest thing to do
in this situation is not to solve for distortion, but here is a procedure if
you want to explore including the distortion solution.
<OL>
<LI> Select the full distortion solution, and set the grouping for tilt angles
to a large number (~30).  Compute an alignment and check the behavior of
the solution for "dmag" and "deltilt".  It 
is possible for tilt angle and stretch to
compensate for each other and give an artifactual solution, so if you see
relatively large values for both of these (e.g., greater than 2-3 degree tilt
angle change and x-stretch greater than 0.05-0.1),
don't trust the result.  Instead, do one of
the following:
<LI> If skew is not significant (say, less than 0.25 degrees), then don't
solve for distortion, and set the group size for tilt angles at 5 to
provide a better solution at low tilt angles.
<LI> If skew is significant, then
select <B>Fixed tilt angles</B>
and continue to solve for distortion, perhaps reducing the group size
accordingly.  If skew is no longer significant in this solution, abandon
solving for distortion as in the previous step; i.e., return to solving for
tilt angles with a group size of 5.
</OL>

<P>
<A NAME = "Projection Stretch"><H4>
7.5. Solving for Projection Stretch
</A></H4>
In some cases, distortions may occur because of stretching
along an axis during the projection of the images, instead of from
changes in the specimen.  To accommodate this situation, 
<A HREF = "man/tiltalign.html">Tiltalign</A> can solve for a skew between
the axes that occurs in all images.  This is much easier than solving
for a specimen distortion that changes through the tilt series, and does not
require fiducials distributed in Z.  In Advanced mode, check <B>Solve for
single stretch during projection</B> on the <B>Global Variables</B> page.
If you have fiducials on only one surface or only a few fiducials, disable
the distortion solution since it could be redundant to the projection
stretch solution.

<P>
<A NAME = "Beam Tilt"><H4>
7.6. Solving for Beam Tilt
</A></H4>
The ordinary alignment assumes that the tilt axis is perpendicular to the beam
axis.  A non-perpendicularity between these axes is referred to as beam tilt.
If beam tilt is more than a few tenths of a degree, it can impair the
alignment.  However, including linear distortion in an alignment
solution has been found to adequately correct for the effects of beam tilt on
the alignment and the reconstruction.  Thus, if you are able to solve for
distortion, beam tilt is not a concern.  Even when distortion is not included,
solving for beam tilt will probably not make a significant difference as long
as you have enough data to solve for rotation for every view, unless the beam
tilt is large.  If you have very few fiducials and cannot solve for more than
a single rotation angle, then including beam tilt becomes more important.
<P>
To include beam tilt in the solution, open the <B>Beam Tilt</B> box on the
<B>Global Variables</B> page by pushing the <B>A</B> button.  Select <B>Solve
for beam tilt</B>.  If the option is grayed out, you need to either solve for
only one rotation angle or disable the distortion solution.  When you run the
alignment, the beam tilt is found by a secondary search, in which the standard
minimization procedure is run with a series of fixed beam tilt values in order
to find the beam tilt that gives the minimum error.
After running the alignment, open the log.  The value for beam tilt will
appear at the top of both the <B>Errors</B> tab and the <B>Solution</B> tab.
In addition, there is a <B>Beam Tilt</B> tab which shows the progress of the
search by listing the normalized error measure (F value) for each value of
beam tilt.  This listing will show you how much the error is reduced by adding
the beam tilt variable.
<P>
There are indications that the beam tilt angle is characteristic of a
particular microscope.  An alternate strategy, when there are very fiducials,
is thus to insert the characteristic beam tilt angle instead of trying to
solve for it.  You would need to have obtained the beam tilt angle from
alignment of other data sets from that microscope.

<P>
<A NAME = "Using Local Alignments"><H4>
7.7. Using Local Alignments
</A></H4>

     If you are reconstructing a large area, particularly if you are
montaging, then you may need to solve for local tilt alignments to get the
same quality of alignment and resulting resolution as you would with a smaller
area.
<A HREF = "man/tiltalign.html">Tiltalign</A>
first finds a global solution with all of the fiducials, then it adjusts the
solution to fit the fiducials in each of a series of overlapping subareas,
referred to as local patches.  A target size for the patches is specified as
an entry to the program, and 
the number of patches in each dimension is determined from this size and from
the amount of overlap required between adjacent patches (50%, by default).
However, patches are
also required to contain a minimum number of fiducials, and each patch will
be automatically expanded from the default size until it contains that
number.  In fact,
there are two minimum requirements: one for the total number in an area, and
one for the number on each fiducial surface.  The latter requirement is
needed to ensure that there is enough information to 
obtain a valid local solution for distortion.
The typical result has been that a global mean residual of 0.75-1 is reduced
to about 0.5 in the local alignments.
<P>
To use local alignments, you should have at least 
8-12 fiducials per 1000 by 1000 pixel area 
acquired with a CCD camera, or
6-8 fiducials per 500 by 500 pixel area digitized from film.  Proceed as
follows: 
<OL>
<LI> Find a global solution using all of the fiducials, as described above.
Because you have many fiducials, you can make the grouping of variables for
tilt angles and distortion smaller than usual.  Reduce group sizes accordingly
but keep the ratio of measurements to unknowns fairly high (~15).
<LI> Check the <B>Enable local alignments</B> box on the <B>General</B>
parameters page.
<LI> The default <B>Target patch size</B>, 700x700, is appropriate
for unbinned data from a CCD camera.  Note that there is an option to enter
the number of patches instead of a target size; this entry is present for
compatibility with old command files but the direct entry of patch size is
preferable.
<LI> If you have fiducials on only one surface, or if you already know that
fiducials are not well enough distributed on both surfaces to provide for
local solutions for distortions, then set the <B>minimum number of 
fiducials</B> on each surface to 0 (the second of the two numbers in the
text box.)  In addition, go to the <B>Local Variables</B> page and make 
that local distortions is disabled there.
<LI> Compute the alignment and examine the log file.  Go to the end of the
<B>Errors</B> page to see the mean residuals; the first value is the global
mean, and the rest are means for the local areas, with a summary at the end.
In addition, note the value for <B>Ratio of total measured values to all
unknowns</B> for each local area; this ratio should be at least 3-4 for a
robust solution.
<LI> Examine the <B>Locals</B> page,
which shows a summary of the size of each
area, the total number of fiducials, and the number on each surface (unless
the surface analysis did not sort the fiducials into two surfaces.)  
If many of your local
patches needed to be much larger than the desired patch size to contain the
required number of fiducials, then you are probably not getting the full
benefit from local alignments.
One sign of this is a tendency for the larger areas to have bigger errors.
You need either to reduce the number of
fiducials required or to track more fiducials.  First try reducing the
<B>Minimum number of fiducials</B> to "6,2".  If this still gives relatively
large areas, and if the areas are getting too big just to get enough
fiducials on the minority surface, then you should reduce the number
required on each
surface to 0 and disable the local distortion solution.
<LI> When doing local alignments, you should examine
the points with the largest residuals in the local solutions and ignore the
global residuals.  The Bead
Fixer in <A HREF = "man/3dmod.html">3dmod</A> will allow you to step from one
local area to the next and bring up each point with a large residual.  With
the <B>Examine points once</B> feature turned on, a point will be seen only
once, even if it appears in the large residual list for several overlapping
patches.
<LI> In the Bead Fixer, there is a button to <B>Move All in Local Area</B>
which will move all points in an area in the direction of their residuals.
A recommended practice is to go through the local areas once without using
this feature, in order to become confident that it would be appropriate to
move points without looking at them.  The points that should not
be moved are likely to come up on this first pass.  On successive passes one
can then move all points if desired.
</OL>

<P>
<A NAME = "Excluding Views"><H4>
7.8. Excluding Views
</A></H4>
Sometimes there are images in the original data that do not align well or
that have poor image quality, and that you want to exclude 
from the alignment and reconstruction.  This can be done by inserting a list
(comma-separated ranges) of view numbers into the <B>List of views to
exclude</B> text box on the <B>General</B> page.  The alignment solution
will then be based only on the rest of the views.  Although the excluded
views will still be included in the
final aligned stack, they will be automatically excluded from the
reconstruction.

<P>
<A NAME = "Residual Model Output"><H4>
7.9. Residual Model Output
</A></H4>
<A HREF = "man/tiltalign.html">Tiltalign</A> produces a text file
with the residuals for each point, and <A HREF =
"man/patch2imod.html">Patch2imod</A> converts this into
a model of the residual vectors in a file named setname.resmod.  Press
the <B>View Residual Vectors</B> button to 
load this model into <A HREF = "man/3dmod.html">3dmod</A> on top
of the images, in place of the fiducial model, to look for patterns in
the direction of the vectors.  The vectors are exaggerated in length
by a factor of 10.  The start and end of a vector is marked by a green
and a red cross, respectively.


<P>
<A NAME = "TOMOGRAM POSITIONING"><H3>
8. TOMOGRAM POSITIONING 
</H3></A>
     The goal of the next step is to shift and rotate your reconstruction so
that it is as flat as possible and will fit into the smallest volume.  This is
done by sampling three regions of the tomogram, ones computed from near the
top, middle, and bottom of the tilt images.  There are two rotations which can
be adjusted: the rotation about the tilt axis, to make the section level when
viewed in the X-Z plane; and a rotation about the X axis, to make the section
come out at the same Z height throughout the length of the tomogram.  The
latter adjustment is optional for small rotations since it involves slightly
more computation time and
requires more interpolations in the back-projection, which could conceivably
reduce resolution.  The steps to follow are:
<OL>
<LI> Set the <B>Sample tomogram thickness</B> to a number at least 50%
bigger than the expected thickness of the section in the tomogram, so that
both the top and bottom boundaries of the section will show up in the
samples.  If you have fiducials
entirely or almost all on one surface, or if the surface analysis in the
alignment log file indicated a big tilt around the X-axis (e.g., more than 2
degrees), you may need double the expected section thickness.
<LI> Press <B>Create Sample Tomograms</B>.  Three samples will be generated,
named top.rec, mid.rec, and bot.rec (or topa.rec, etc.)
<LI> Press <B>Create Boundary Models</B>.  This will 
load all 3 sample tomograms into <A HREF = "man/3dmod.html">3dmod</A> and set 
up the proper filename for the boundary model.
Model each edge of the section by drawing a line along
the boundary in one of the slices for a tomogram sample.
Just use two points, one on the left and one on the right side
of the tomogram.  You do not need to go all the way to the left and right 
edges since <A HREF = "man/tomopitch.html">Tomopitch</A> will extrapolate
from the line segment that you draw.  
Put the lines for the top and bottom edges in separate
contours.  Use the "1" and "2" keys to switch between samples, and model
two contours in each sample in the same way.  When you are done, the model 
should have one object with six contours (two per sample), and two
points per contour.  Save the model.  
<LI> Note the text box for <B>Added border thickness</B>, where you can
specify the thickness of an additional border on the top and bottom.  
This capability means that you can model right along the surface of
the section instead of allowing for a border in the model.
<LI> Press <B>Compute Pitch Angles & Z Shift</B> to run 
<A HREF = "man/tomopitch.html">Tomopitch</A>.  The screen will morph so that
it shows the <B>original</B> positioning parameters that were in effect when
the samples were made, the <B>added</B> values implied by the boundary model,
and
the resulting <B>total</B> values that need to be applied to produce the flat,
centered tomogram.  The latter values can be changed if desired.  In
particular, if you do not want to apply a small X-axis tilt, you can zero out
that value.  In this case, you should open the Tomopitch log file and check
whether you need a little more thickness; see the "thickness... set to" value
on the line above the "Pitch between samples can be corrected..." line.
<LI> Next press
<B>Create Final Alignment</B>, which will run <A HREF =
"man/tiltalign.html">Tiltalign</A> with these parameters.  The remaining
parameters shown on this screen are used in making the reconstruction and 
will be carried forward to the <B>Tomogram Generation</B> panel.
</OL>

<P>
<A NAME = "Doing Tilted Samples"><H4>
8.1. Redoing Samples to Refine the Positioning
</A></H4>
The Positioning panel makes it easy to refine the positioning with a second
round of samples.  You might want to do this
if your initial samples do not contain the entire section, which can easily
happen when fiducials are on only one surface or there is a large X-axis tilt.
In such a case, you can draw a model with estimated lines and press 
<B>Compute Pitch Angles & Z Shift</B>.  Then use <B>Create Sample
Tomograms</B> to make new samples at the estimated position.  Make sure that
the <A HREF = "man/3dmod.html">3dmod</A> with the previous samples is closed,
and press <B>Create Boundary Models</B>.  Delete the existing contours
(e.g., press "Shift-D" 6 times) and make new ones.  This time, when you
press <B>Compute Pitch Angles & Z Shift</B>, new positioning values will be 
added to the previous ones.

<P>
<A NAME = "Whole Tomogram Positioning"><H4>
8.2. Positioning with a Whole Tomogram
</A></H4>
For situations where the 3 samples at fixed positions are unsuitable, there is
an option to draw lines in a whole tomogram instead.  A whole tomogram can be
generated quite quickly with binning of 3 or 4.  To use this option, check
<B>Use whole tomogram</B> and select the desired binning, then press
<B>Create Whole Tomogram</B>.  When it is done and you press <B>Create
Boundary Model</B>, the tomogram will be presented in the top-down, X/Y view.
You now need to create pairs of lines delineating
the top and bottom of the specimen in at least 2 (preferably 3) locations in
Y.  The lines do not need to be perfectly horizontal (i.e., confined to one
plane in Y) and the two lines of a pair do not need to be at identical
locations.  See the man page for <A HREF = "man/tomopitch.html">Tomopitch</A>
for more details on acceptable boundary lines.
You have 3 options:
<OL>
<LI>The simplest method is to flip the tomogram to show the X/Z planes that
ordinarily appear with 3 samples (use the menu entry Edit-Image-Flip).  Pick
slices where the lines can be drawn and draw them as usual.
Be sure to start a new contour for each line, since this will not happen
automatically in this situation as it does with 3 samples.
<LI>Scroll through the X/Y planes in the Zap window and draw each line
by depositing points on the left and right sides of the tomogram at
appropriate Z levels.  Specifically, first pick a promising region in
Y.  Scroll through until you see the top of the section on the left
side, and deposit the first point of a contour there.  Then find the
slice that shows the comparable view of the top of the section on the
right, at about the same Y level, and add a point there.  Start a new
contour and repeat this procedure on the bottom of the section.  The
pick another two levels in Y and repeat the provedure of drawing top
and bottom lines at each.
<LI>Open a Slicer window, scroll in Z to one surface of the specimen,
and adjust X and Y rotation angles until the surface is flat.  Change Z
until you are just outside the surface.  Draw a horizontal line by adding
a point on the left then a point on the right side.
Draw two more lines at different Y levels (starting a new contour for each).
Go to the other surface and repeat.
</OL>
In each of these cases it is helpful to open the model view window before
starting to monitor the location of the lines.

<P>
<A NAME = "TOMOGRAM GENERATION"><H3>
9. TOMOGRAM GENERATION
</A></H3>
The tomogram generation process involves several steps at which
filtering can be applied to the data, and the appearance and interpretability
of the resulting tomogram depends on the choice of filtering.
All of this filtering involves the preferential attenuation of high spatial
frequencies, i.e., low pass filtering.  This kind of filtering reduces the 
noise in the reconstruction because noise becomes increasingly important at
higher spatial frequencies.  
Spatial frequencies are expressed in cycles
per pixel, ranging from 0 to 0.5, the highest spatial frequency that can be
represented in a digital image.

<A NAME = "Radial filter"><H4>
9.1. Tomogram Resolution and the Need for Filtering
</A></H4>
The noise or graininess in a reconstruction from
well-aligned data arises from two main sources:
noise 
in the projection images because they are not taken at very high dose; and 
artifacts in the back-projection because the tilt increment was too large
for the thickness of volume being reconstructed.  The angular increment is
one of the major factors governing the resolution of a tomogram.  The
classic resolution formula of Crowther,
DeRosier, and Klug (1970) can provide a rough guide for how to adjust
the radial filter, even though it is strictly applicable only to the case of a
full 180&ordm; range of angles.  The formula is:
<p>
&nbsp;&nbsp;&nbsp; d = D * &#916;&#946;
<p>
where: 
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; d is the resolution in real-space units (nm or pixels), 
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; D is the diameter of volume reconstructed, 
<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &#916;&#946; is the angular increment in radians.  
<br>
Alternatively, if &#916;&#946; is in degrees, the resolution f in 
reciprocal-space (frequency) units is
<p>
&nbsp;&nbsp;&nbsp; f = 57.3 / (D * &#916;&#946;)
<p>
Or, the equation can be expressed in terms of n, the number of views, and
the maximum tilt angle &#946;<sub>max</sub>:
<p>
&nbsp;&nbsp;&nbsp; f = (28.5 * n) / (D * &#946;<sub>max</sub>)
<p>
which for the case of a tilt range of &plusmn;60&ordm;, reduces to:
<p>
&nbsp;&nbsp;&nbsp; f = 0.48 * n / D
<p>
One of the uncertainties in these formulas is the meaning of the diameter D.
In rough terms it corresponds to the thickness of the section; but if
electron-dense material in the section is relatively sparse, it may
correspond more closely to the size of clusters of material within the
section, implying a higher resolution.  It has been argued that in extended
slabs of material, D corresponds to the maximum thickness of the section
when tilted, but a formula based on this assumption
gives resolutions much too low to be a guide for filtering the reconstruction.
The last version of the formula implies that the angular increment does not
limit the resolution when the number
of views is comparable to the section thickness in pixels.  This makes
intuitive sense if one thinks of the projections as providing information
needed to solve for densities in the volume, since then the number of
measurements will match the number of unknowns.

<A NAME = "Filtering Options"><H4>
9.2. Filtering Options
</A></H4>
The first step with a choice that affects filtering of the data is the
generation of the aligned stack, which can be done with either cubic or
linear interpolation.  Although the default cubic interpolation does
attenuate the highest frequencies to some extent, linear interpolation has a
noticeably greater filtering effect.  The effect is broad-band and mild: it
becomes significant at frequencies as low as 0.2 cycle/pixel but even the
highest frequencies are attenuated by only a factor of about 2-3, rather than
eliminated as in most filtering.  Linear interpolation is a good first stage
for filtering when the data are particularly noisy, such as in cryotomography.
<P>
After the aligned stack is made, it can be filtered explicitly with a
two-dimensional Gaussian filter in Fourier space.  Spatial frequencies up to a
specified cutoff radius are unaffected, and beyond that radius they are
attenuated by multiplying with a Gaussian curve that starts at 1.0 at the
cutoff radius and falls off with a specified sigma value (standard deviation).
The Gaussian falls to 0.61, 0.14, and 0.01 at 1, 2, and 3 sigmas, respectively.
The advantage of filtering the aligned stack is that it will reduce noise in
both dimensions; the disadvantage is that it requires an extra computational
step.
<P>
The third stage at which filtering can be applied is during the
backprojection.  
In R-weighted backprojection,
each horizontal line of input data is filtered to weight each spatial
frequency proportional to its radius in Fourier space.  This is radial
weighting, and the filter is referred to as a radial filter.  When graphed,
it is simply a straight line through the origin.  In order to
filter out high frequencies in the reconstruction, a cutoff frequency is
defined at which the filter changes from a rising line to a falling Gaussian
curve.  The rate of the falloff is again determined by the sigma
of the Gaussian.  The advantage of filtering at this stage is that it adds no
extra steps because it is incorporated in the R-weighting.  However, it is only
a one-dimensional filter.  This makes it well suited for reducing the
artifacts and noise due to the limitations on angular sampling, but less
well-suited for dealing with other noise because it fails to filter noise in
the Y direction.  Indeed, experiments with noisy model data indicate that 
optimal 2D filtering of the aligned stack gives a more faithful reproduction
of the original structure than does radial filtering in the backprojection
with the same cutoff and sigma values.

<A NAME = "Filtering Guidelines"><H4>
9.3. Filtering Guidelines
</A></H4>
These various considerations motivate the following guidelines:
<UL>
<LI> The default filter for both the 2D and radial filtering, with a cutoff of
0.35 and a rolloff of 0.05 cycle/pixel, is generally adequate when the section
thickness in pixels is
up to 2 times the number of views and the input data are not very noisy.
With the default filter, it will not make much difference whether you use 2D
filtering or the radial filter.
<LI> The cutoff can be made higher, such as 0.4 or 0.45, if the ratio of
thickness to projections is close to 1, and if the input data are not very
noisy.  This may not make much difference for unbinned data from a CCD
camera but could be worthwhile for higher resolution binned CCD images or
data from film. 
<LI> If the ratio of thickness to number of views is higher than two, the
data should probably be filtered more than the default.  Do this filtering
in 2D instead of with the radial filter.  Reduce the cutoff
frequency to values like 0.3 and 0.25.  Do not reduce the rolloff as this will
produce more ringing and ripples; in fact, it may be advantageous to increase
the rolloff value so that 3 sigmas are still reached at 0.5 cycle/pixel (e.g.,
to 0.065 for a cutoff of 0.3, or 0.08 for a cutoff of 0.25).
<LI> If the input data are particularly noisy, linear interpolation should be
used, and the filter cutoff may need to 
be set lower than the previous points would suggest.
<LI>If you decide to bin the aligned stack to deal with excessive noise and
limited resolution, the filtering requirements will be
much reduced. 
</UL>
For dual-axis tomograpy, Brad Marsh's group at the University of Queensland
has had success with an alternative approach, applying a 2D filter close to
the default settings and a much stronger radial filter.  Apparently the strong
radial filter does a good job of reducing the effects of limited angular
sampling, while the useful information that it filters out along the direction
perpendicular to the tilt axis is adequately restored by data from the other 
axis.
<P>
These guidelines are just a starting point, and the best approach may be to
experiment with different filter settings to find the best balance between
reduced graininess and sharpness of features in the tomogram.

<A NAME = "Making Aligned"><H4>
9.4. Making and Processing the Aligned Stack
</A></H4>
The first step when you get to the <B>Tomogram Generation</B> page is to
generate the aligned stack.
First select linear interpolation if desired for this step.
Notice that you can also select a binning of the aligned stack at this stage.
Press <B>Create Full Aligned Stack</B>.
<P>
Before the optional 2D filtering, there are two other operations that you
might want to perform, and for which there is not yet an interface in eTomo:
correction for microscope CTF and erasure of fiducial markers.
<OL>
<LI><I>CTF Correction</I>.  You can use
<A HREF = "man/ctfplotter.html">Ctfplotter</A> to estimate the defocus of the
tilt series; this program requires a set of noise image files for the camera
being used.  To run this program, get a copy of a parameter file:
<pre>
   cp $IMOD_DIR/com/ctfplotter.param .
</pre>
Edit the file to specify your file name and other parameters.  Run the
program with:
<pre>
   ctfplotter -param ctfplotter.param
</pre>
This program allows you to estimate a single value of defocus for the whole
tilt series or several defocus values that apply over different ranges of tilt
angles.  At the end, you 
store these defocus estimates in a file "setname.defocus".
If you do not run <A HREF = "man/ctfplotter.html">Ctfplotter</A> and have a
defocus to use, you need to make a file "setname.defocus" with a single
line, "20 20 0. 0. defocus_value", specifying the defocus value.
<P>
To correct the aligned stack for the CTF, get a copy of the command file:
<pre>
   cp $IMOD_DIR/com/ctfcorrection.com .
</pre>
Edit the file to specify your file name and other parameters.  Run the
program with:
<pre>
   subm ctfcorrection 
</pre>
After the computation is finished, replace the aligned stack.
<pre>
   mv setnameCorrected.ali setname.ali
</pre>
<LI><I>Erasing Fiducial Markers</I>. 
<A HREF = "man/ccderaser.html">Ccderaser</A> can now erase a circular region
around every point in an object.  This allows the fiducial gold markers to be
removed from images, which will reduce the artifacts cast by these markers in
the reconstruction but might produce other artifacts.  You can use the
fiducial model to erase the beads that were used for alignment, or a more
complete model if you have prepared one.
The first step below transforms the model into alignment with the
aligned stack, so if you have a model that already fits the positions in the
aligned stack, that step should be omitted.  Here are the steps to follow for
a model "setname.fid":
<PRE>
   xfmodel -xf setname.tltxf setname.fid setname.fidali
   ccderaser -cir 1 -bet radius -mer -exc -mod setname.fidali setname.ali setname_erase.ali
   3dmod setname_erase.ali
</PRE>
In the Ccderaser command, "radius" is the radius around each point to erase,
in pixels; this value can be floating point rather than integer.  The entry
"-cir 1" specifies that object 1 contains the points to be erased as circles;
if your points are in more that one object, enter a list of object numbers
instead of 1.
If the erasure appears acceptable, replace the aligned stack:
<PRE>
   mv setname_erase.ali setname.ali
</PRE>
<LI><I>2D Filtering</I>. If you decide to use 2D filtering, set the cutoff
radius and sigma values and press <B>Filter</B>.  You can press 
<B>View Filtered Stack</B> to see the result.  You can change parameters and
filter again, or press <B>Use Filtered Stack</B> to replace the aligned stack
with the filtered version.
</OL>
<P>
<A NAME = "Building Tomogram"><H4>
9.5. Building the Tomogram
</A></H4>
In the <B>Tilt Parameters</B> section, the values for 
<B>Tomogram thickness</B> and <B>X-axis tilt</B> were inserted when you ran  
<A HREF = "man/tomopitch.html">Tomopitch</A>; correct them if necessary.
Adjust the radial filter parameters as appropriate.  If you did 2D filtering,
you can set the cutoff higher (e.g., 0.45) to avoid double-filtering the 
data.  
Press <B>Generate Tomogram</B>.
<P>
<A NAME = "Making Trial Tomograms"><H4>
9.6. Making Trial Tomograms
</A></H4>

In Advanced mode, the <B>Tomogram Generation</B> panel has a set of
controls for making and examining trial tomograms.  You might want to
do this to see the effects of varying the radial filter, or to see the
results with different alignment parameters.  These assessments can
usually be done on a subset of the data.  You can make a subset by
reducing the thickness, entering a <B>Tomogram width in X</B> that is
less than that of the
projection images, specifying a <B>First slice in Y</B> and a 
<B>Last slice in Y</B>, or some combination of these three changes.
You can even enter an <B>X offset</B> to shift
the subset away from the center in X.
<P>  
In any case, to make a
trial tomogram, enter a name in the <B>Trial tomogram filename</B>
drop-down box,
then press <B>Generate Trial Tomogram</B>.  To make another one,
change parameters as desired, edit the trial tomogram name, and press
<B>Generate Trial Tomogram</B> again.  Once there is more than one
trial tomogram, you can select the name that appears in the drop-down
box, and press <B>View Trial in 3dmod</B> to see whichever tomogram is
currently listed in the filename box.  When you are done looking at
trial tomograms, be sure to reset the thickness and remove unwanted
entries from the width and slice boxes before pressing <B>Generate
Tomogram</B>.  If you made the full tomogram in one of your trial runs,
you can press <B>Use Current Trial Tomogram</B> to rename the trial
tomogram to be the final output of the tomogram generation step.
<P>
There is also an entry for <B>Tilt angle offset</B> in Advanced mode,
which will rotate the reconstruction about the Y axis just as the
angle offset will in the Fine Alignment step.  In addition, there is
an entry for <B>Z shift</B> that has the same effect as the 
<B>Z shift</B> specified earlier.  These entries are useful when
doing an alignment without fiducials.  
<P>
<A NAME = "Z factors"><H4>
9.7. Using Z Factors in the Backprojection
</A></H4>
When a specimen shrinks along an oblique axis during a tilt series, it is
actually not possible to transform the 2D images to correct fully for this
shrinkage.  That is, the aligned images will not represent projections of
an unchanging rotated object.  The result is that features such as gold
fiducials do not stay at one Y level in the aligned images, producing
characteristic artifacts in the reconstruction.  This effect can be
corrected by varying the
location that voxels in the reconstruction backproject from systematically
as a function of their Z-height.  Since IMOD 3.4.17, 
<A HREF = "man/tiltalign.html">Tiltalign</A>
can output the factors needed to adjust the backprojection position when
distortion is solved for, and
<A HREF = "man/tilt.html">Tilt</A> can use them when computing the
reconstruction.  These factors will be used if present when the
<B>Use Z factors</B> box is checked in the <B>Tilt Parameters</B> section
of the <B>Tomogram Generation</B> panel.  The box is checked by default,
under the assumption that the distortion solution in the fine alignment will 
usually reflect changes in the specimen rather than stretches during
imaging.  However, in situations where imaging is a more likely source of
stretch, the option should be turned off.  

<P>
<A NAME = "TOMOGRAM COMBINATION"><H3>
10. COMBINING TWO TOMOGRAMS
</A></H3>

To combine two tomograms, eTomo uses a series of command
files to perform a sequence of operations.  Just as for building the
single-axis tomogram, you first adjust entries on a setup page, then you
create the command files.  At that point you can start the
combine operation, and if all goes well it will run to completion.  However,
the <B>Tomogram Combination</B> panel provides two other pages with options
to deal with the problems when things do not go well.
<P>
The main programs or shell scripts being run, and the essential
steps in combining are:
<UL>
<LI> <A HREF = "man/solvematch.html">Solvematch</A>:
Use the coordinates of the fiducials from tilt alignment
to determine the 3-D rotation, distortion, and shift between the two tomograms.
This operation is run by solvematch.com.
<LI> <A HREF = "man/matchvol.html">Matchvol</A>:
 Using this initial alignment, generate an initial matching
volume from one of the tomograms.  This operation is run by matchvol1.com
<LI> <A HREF = "man/corrsearch3d.html">Corrsearch3d</A>:
 Extract small patches from a regular 3-D array of
positions in the two volumes (one original, one transformed to match), and
use 3-D cross-correlation to determine the error (displacement) between the
two volumes at each position.  This operation is run by patchcorr.com.
<LI> <A HREF = "man/matchorwarp.html">Matchorwarp</A>:
 Analyze the displacements with 
<A HREF = "man/refinematch.html">Refinematch</A>, and if they
fit well enough to a single linear transformation, use 
<A HREF = "man/matchvol.html">Matchvol</A> with this
refining transformation to produce the final matching volume.  If they do
not, run <A HREF = "man/findwarp.html">Findwarp</A>
 to find the best warping between the volumes automatically,
then run <A HREF = "man/warpvol.html">Warpvol</A>
 to produce a final matching volume with a series of linear
transformations.  Warping is done by solving for a series of local 3-D
transformations and making a gradual transition from one to another in the
plane of the section.  All of these operations are run by matchorwarp.com.
<LI> Match the density between the two volumes 
(<A HREF = "man/densmatch.html">Densmatch</A>), then take
Fourier transforms of each (<A HREF = "man/fftrans.html">Fftrans</A>),
 combine the Fourier transforms
(<A HREF = "man/combinefft.html">Combinefft</A>),
 and back-transform.  Larger volumes are broken into pieces
(<A HREF = "man/taperoutvol.html">Taperoutvol</A>)
and recombined (<A HREF = "man/assemblevol.html">Assemblevol</A>),
because it is much faster to take Fourier transforms of these pieces.
All of these operations are run by volcombine.com.
</UL>

<P>
<A NAME = "Setting Up"><H4>
10.1. Setting Up
</A></H4>
<P>
Go through the following steps to set up the combination:
<OL>
<LI> Decide which tomogram will be transformed to match the other.
Typically, the "b" set is matched to the "a" set.
However, if the section is appreciably flatter in one tomogram, then
the other one should be matched to that one.
<LI> If you have fiducials on only one surface,
select the appropriate radio
button to indicate that fiducials are on one side.
There is an option to indicate that one tomogram is inverted relative to the
other; this refers to an inversion in handedness as distinct from a tomogram
appearing upside-down due to a rotation and should not be possible with data
from CCD cameras.  Notice that there are also
options for using models of corresponding points either alone or together with
fiducials; for details on using these options see
<A HREF = "tomoExtra.html#Fiducialless Combine">
Combining Tomograms with Few or No Fiducials</A> in the Extra Topics section.
<LI> 
If you used <A HREF = "man/transferfid.html">Transferfid</A> successfully
to make a second seed model, then the coordinate file
produced by this operation will be used to determine corresponding points, and
you do not need to enter anything for <B>Starting points to use from A</B>.
Otherwise, you need to enter lists of corresponding fiducial points in the 
<B>Corresponding fiducial list</B> text boxes.  Specifically, enter a list of
points from "a" which have are known to have corresponding points in "b", and
the list of corresponding points in "b".  
<A HREF = "man/solvematch.html">Solvematch</A>
can be given a small list of fiducials that are known to
correspond and it will find the remaining correspondences.  There are two
restrictions on this ability: you must give it at least 4 correspondences to
start with (5 is recommended); and if you have fiducials on both surfaces, you
must include at least one from each surface.
<LI>
Decide what size patches to use in Patchcrawl3D.  Ideally, this
decision would be based on how much high frequency information is in the
tomograms and on how well the two volumes seem to agree with each other, but
these features are difficult to assess.  In the initial creation of the
command files, there are three built-in sizes available, small, medium, and
large.  Small patches should be adequate for
relatively high-resolution tomograms from film, while the medium patches are
more appropriate for data from a CCD camera.  If the tomograms seem
particularly fuzzy, go up one size in either case.  Once you have created
the command files, you can adjust these sizes in the <B>Final Match</B> page
if necessary.
<LI> Try to determine if there are regions within the section that should
not be used for correlating the tomograms because they are either empty of
material or contain reconstruction of poor quality.  You can exclude such
areas from consideration in two ways.  One way is to set more restrictive
lower and upper limits in X and Y on the region from which patches will be
extracted by <A HREF = "man/patchcrawl3d.html">Patchcrawl3d</A>.
Take note of the coordinates in X and Y beyond
which the image is unreliable in the tomogram being matched TO, and adjust
the entries in the X or Y axis min or max text boxes.
The other way is to draw one or more model contours completely enclosing the
patches that you want included in the analysis.  Select <B>Use patch region
model</B> and press the <B>Create/Edit Patch Region Model</B> button.  This
will open the tomogram being matched to and define an appropriate file name
for the patch region model.
See the man page for
<A HREF = "man/refinematch.html">Refinematch</A>
for details.  Do not worry about identifying regions in this
tomogram that are outside the bounds of the other tomogram; 
<A HREF = "man/patchcrawl3d.html">Patchcrawl3d</A> will
take care of this limitation.
<LI> Examine the tomogram being matched TO and determine the first and last
slices that contain useful information for cross-correlating the tomograms
(i.e., are inside the section over at least half of the area).
Ignore the gold particles; there is
too much empty space around them.  Enter these slice numbers in the <B>Z
axis min</B> and <B>Z axis max</B> text boxes.
</OL>
<P>
If you have a relatively thin sample, you should be aware that Setupcombine
may decide to compute only one layer of patches, in which case the second
stage of alignment will not stretch the data in the thickness dimension.
This is generally appropriate, because the error from failing to
correct for thinning for a very thin specimen would be negligible.  For
example, the thinning correction determined in the refinement phase is
typically less than 1%, so for a 40-pixel thick specimen the error in Z at the
surfaces would be 0.2%.  However, if you wish to solve for two layers, 
go to
the <B>Final Match</B> page, switch to Advanced mode, and specify two
layers of patches in Z.  Adjust the size of the patches in Z if necessary so
that it is at least 40% smaller than the range allowed for the patches in Z.
This will provide sufficient spacing between the layers to give an accurate
estimate of the realtionships in Z.
<P>
If you have noisy tomograms, you should probably use linear interpolation
(instead of the default quadratic) for making the final matching volume with
<A HREF = "man/matchorwarp.html">Matchorwarp</A>.  To do this, go to Advanced
mode on the <B>Final Match</B> page and select <B>Use linear interpolation</B>.
<P>
<A NAME = "Temporary Combining Storage"><H4>
10.2. Using Temporary Storage for Combining
</A></H4>
It is possible to use temporary disk space when combining two tomograms;
this is useful if you want to run the combine operation on a machine different
from the one where the two tomograms are located.  Combining creates a large
number of temporary files, and considerable time can be saved by placing these
files on a local disk instead of writing and reading them across a network.
To use this feature, make an entry in the <B>Temporary directory</B> text
box (/tmp, /usr/tmp,
or other appropriate scratch directory).  If you may need to access this
directory from other machines, do not use /tmp or /usr/tmp, and specify the
scratch directory in a way that will be recognized from another machine.
(In the BL3DEMC, that means using /scratch/machine_name instead of
/localscratch).  
Whatever directory you specify must exist already and you must
have permission to write to it.  By default,
the command files will build the final
sum.rec into the current directory and remove all temporary files at the end.
Select <B>Manual cleanup</B> if you want the fastest possible access to
sum.rec or if you want to examine the setname.mat file.  With this option,
sum.rec is built in the temporary directory and a link is provided to it
from the current directory.
<P>
The temporary directory is created when matchvol1.com is run.  If the
combine operation crashes and has to be restarted, it will use the same
directory.  However, if you recreate the command files, a new
temporary directory will be used.


<P>
<A NAME = "Proceeding"><H4>
10.3. Proceeding
</A></H4>

Press <B>Create Combine Scripts</B> to generate the command files based on
the parameters in the <B>Setup</B> page.  After this, the <B>Initial
Match</B> and <B>Final Match</B> pages will be accessible, and you can go to
them to adjust parameters if
you have special needs based on prior experience.  Some parameters can also
be changed from the setup page, but some parameter changes there
will not have any effect unless you recreate the command files.
<P>
Check free disk space (df -k). Typically, you need 3 times as much free
space as one tomogram occupies.  You may need to delete the aligned tilt
series, which you can do with the <B>Delete Aligned Image Stack</B>
button on the <B>Tomogram Generation</B> panel.  (Deleting the pre-aligned 
stacks will also help, but this currently must be done from the command line.)
You may even need to 
archive and delete raw tilt series before proceeding.
<P>
Press <B>Start Combine</B> to start the operation.  Once the matchorwarp
operation has been running for a minute, 
check the matchorwarp.log file to see how good the registration between the two
volumes is.
You
will see <A HREF = "man/refinematch.html">Refinematch</A>'s
report on the mean and maximum deviation at the various
locations after applying a single linear transformation.  Then there will be
either a message that <A HREF = "man/matchvol.html">Matchvol</A>
 is being run, or a message that warping is
needed.  Just above a
message that <A HREF = "man/warpvol.html">Warpvol</A>
 is being run next will be a report on the mean and
maximum of the mean residuals.  If the mean is reasonable but the maximum is
quite high (1 or more), 
you should look at the patch vector model
and consider whether to take any of the remedial
actions described below.

<P>
<A NAME = "Initial Problems in Combining"><H4>
10.4. Initial Registration Problems in Combining
</A></H4>
The first step of the combine operation can fail for two reasons: 
the linear fit between corresponding fiducial positions gives a maximum
residual above the specified limit; or there is a 
large local shift between the centers of the volumes after
they have been optimally aligned.  There are three different situations to be
considered:
<OL>
<LI> <I>A bad fit when corresponding fiducial coordinates are available from
<A HREF = "man/transferfid.html">Transferfid</A>.</I>  Here, an incorrect
correspondence between points is ruled out and the bad fit must arise from
nonlinear distortions between the volumes.  Only very large distortions should
cause <A HREF = "man/solvematch.html">Solvematch</A> to stop with an error,
because in addition to the fit to all the data points, it does
a series of local fits to subsets of the data.  If a very high proportion of
those fits give residuals less than the limit, then the overall solution is
deemed acceptable.  If the program does stop because the local fits are not
good enough, then examine the log file to determine the maximum residual
from the local fits.  The remedy is to enter a number higher than the maximum
residual
in the <B>Residual threshold</B> text box on the <B>Initial Match</B> page and
press the <B>Restart Combine</B> button to start over from the beginning.

<LI> <I>A bad fit when corresponding fiducial coordinates are <B>not</B>
available.</I>   Here the bad fit could arise either 
from a bad
correspondence between fiducial points or
from nonlinear distortion between the two tomograms.
To distinguish these two situations, examine the solvematch log file, which 
will usually offer some advice based on the mean and maximum
residuals of the fit between points.
If the mean is fairly large
(around 4 as opposed to 1), and the maximum is not very large (less than
20), and if the local fits also have relatively small maximum residuals,
this is a sign that the fiducial positions do not fit a linear
transformation very well because of
distortions.  In this case, enter a number higher than the maximum residual
in the <B>Residual threshold</B> text box on the <B>Initial Match</B> page.
Then press the <B>Restart Combine</B> button to start over from the beginning.
In contrast, if the maximum residual is very high (say, higher than 20), and
if some of the local fits are good while others are much worse,
this is a sign that there is a bad correspondence between points.  Usually
the mean residual will be relatively low, but if there are many points out
of correspondence, it could be very large.
<A HREF = "man/solvematch.html">Solvematch</A> can eliminate some bad
pairs of points, but not more than 10% of the points.
When this happens, 
you should change the <B>Corresponding fiducial lists</B> 
so that they specify only a few points which you are sure correspond.

<LI> <I>Large center shift between aligned volumes.</I>  <A HREF =
"man/solvematch.html">Solvematch</A> uses local fitting to estimate the
displacement at the center of the volumes after the second one
is transformed to match using the transformation determined from a global fit.
When this shift is large there are two risks: 1) that the initial transformed
volume will not have all the material needed for patch correlations if it is
made as thin as the first volume; and 2) that the patch correlations will not
work because they
start at the center of the volume and require the volumes to be well-enough
aligned there.  The processing stops when there is a large shift to allow you
to eliminate these risks.  Check the solvematch log file for advice.  1) If
the volume being transformed is larger than the one being matched to, you will
see a message advising that you make the initial match volume a certain size.
On the <B>Initial Match</B> page, go to Advanced mode in the <B>Matchvol1</B>
section and set the indicated number in the <B>Initial match size</B> text
box.  2) You will see a message 
"In eTomo, set patchcorr X, Y, Z initial shifts to".  On the 
<B>Final Match</B> page, go to Advanced mode in the <B>Patchcorr
Parameters</B> section and transfer the numbers in this message into the
<B>Initial shift</B> text boxes.  After making these parameter changes, you
can either resume the processing with <B>Restart at Matchvol1</B> or you can
increase the <B>Limit on center shift</B> (again, in Advanced mode on the 
<B>Initial Match</B> page) and use <B>Restart Combine</B>.
</OL>
<P>
There is another problem that can occur in the initial matching step.  If
there is significant warping between the two volumes and not a good enough
distribution of points in Z, then the best fit between the points may occur
with a transform that collapses the Z dimension.  This can happen if there are
very few fidicuals on one surface relative to the other.  <A HREF =
"man/solvematch.html">Solvematch</A> will try to detect this situation and
issue a warning if the scaling along the Z axis is more than 10% different
from the scaling along the other two axes.  (In the log file, the smaller
scaling factor will appear for the Y axis, since the tomogram is still
oriented with Y as the thickness dimension.)  The program will probably also
advise that you switch to specifying that fiducials are on only one surface.
This is indeed the solution to this problem.
<P>
If you have a data set where the alignment was run on an older version
of IMOD (before 3.2.21), solvematch.com will run a script,
<A HREF = "man/matchshifts.html">Matchshifts</A>
to find the shift
between the two tomograms.  This operation can fail.  If so, the easiest thing
to do is to rerun the fine alignment for both axes, so that
the fiducial coordinate files will contain the information that 
<A HREF = "man/solvematch.html">Solvematch</A> needs to find the shifts
directly.

<P>
<A NAME = "Patch Problems in Combining"><H4>
10.5. Patch Correlation Problems in Combining
</A></H4>
If combine.com exits because neither 
<A HREF = "man/refinematch.html">Refinematch</A>
 nor <A HREF = "man/findwarp.html">Findwarp</A> could find
a fit to the patch displacements with a sufficiently low mean residual, then
there are several possible reasons.  The patches could be too
small or noisy, leading to widespread random errors.  There could be local
regions in the volume where a relatively high proportion of patches have large
errors, a
situation that the outlier elimination algorithm in 
<A HREF = "man/findwarp.html">Findwarp</A> cannot handle.
Finally, there could be inaccurate displacements only along one or more edges
of the volume.  To assess this situation, the first step is to 
examine the model of the patch displacements by pressing 
<B>Examine Patch Vector Model</B>.
This model shows each displacement as a line whose
length is 10
times the actual length of the displacement.
Spin the model slowly and zoom as
needed to see the pattern of displacement vectors.  
You will notice that the Model View Object Edit window is also opened to
provide access to some advanced tools for examining and editing the vectors.
<P>
One tool is the ability to display the residuals in the fitting procedures and
select vectors with high residuals.  Select the <B>Values</B> panel
to see the controls for this display.  You can turn on <B>Show stored
values</B> to see the residual value for each vector displayed in false color.
Move the <B>Black</B> slider to give all the residuals below a certain value
the color at the low end of the scale (red), and turn on <B>Turn off Low</B>
to see just the residuals above that value.  By looking at the distribution of
vectors with high residuals, as well as the degree of consistency in length
and direction between adjacent vectors, you can get a sense of where the fits
give the worst results.
<P>
The second tool is a set of clipping planes that provide a window on a 600x600
pixel area.  This could be useful for examining or editing a region of patches
when the model is tilted so that adjacent patches interfere.  To activate the
clipping planes, select the <B>Clip</B> panel in the 
Object Edit dialog and toggle <B>Clip plane ON</B>.  Use Ctrl and the first
mouse button to move the window by shifting the planes around in unison.
<P>
To deal with a bad patch fit, consider the following steps in sequence:
<OL>
<LI> <I>Make bigger patches.</I>  If there are many lines that do not fit
the pattern of surrounding lines, scattered around the whole volume, then
you should rerun the patch correlation with larger patches and possibly with
filtering.
On the <B>Final Match</B> page, you can either 
enter new sizes in the <B>Patch size</B> text boxes or press 
<B>Patch Size +20%</B> to increase each dimension by 20%.
This will increase the 
volume of the patches by a factor of 1.73 and substantially improve
accuracy, although in some cases two increases may be needed.  You can also
add filtering by going to Advanced mode, selecting
<B>Kernel filtering with sigma</B>
and putting a value in the text box.  This is a real space filter based on a
Gaussian with the given sigma; values in the range of 1 to 3 will be most
useful, with larger values filtering more.  When data are noisy, filtering
will be complementary to increasing patch size in reducing residuals; its 
effect is often equivalent to roughly a 10% increase in patch size.  However,
filtering can give a worse fit in some cases, so this option should be used
with caution.  After adjusting patch correlation parameters, 
press <B>Restart at Patchcorr</B> to continue.

<LI> <I>Exclude regions of patches with a model.</I>  If displacements generally look fairly regular but there are a large 
number of bad patches in well-defined regions, it may be easiest to make a
model with contours enclosing the regions with good patches, or to modify
such a model if you have already made one.  To do this while looking at the
patch vector model, press <B>Create/Edit Patch Region Model</B>, which
will load the tomogram being matched to into
a separate <A HREF = "man/3dmod.html">3dmod</A>,
and try to correlate positions between the tomogram and the patch vector model.
Be sure to check <B>Use Patch Region Model</B>, then press 
<B>Restart at Matchorwarp</B>.  If <A HREF =
"man/findwarp.html">Findwarp</A> still fails, you probably need to edit
patches as described next.  Note that if you have just added a patch
region model, the patch vector model will still show bad patches outside of
the region contours (and thus not a problem) unless you rerun patchcorr to
generate new patches that are constrained to be within the region.

<LI> <I>Edit out scattered bad patches.</I>  If bad patches are fairly 
scattered and not too numerous, it is most appropriate to edit them out.  To
do this, press the <B>Examine Patch Vector Model</B> button.
Position the mouse on an aberrant
vector in the model
view window and press the third mouse button to make this vector be
the current contour for editing.  It should display as a thicker line; if a
different vector shows up as thick, reposition and click again.  (If no vector
shows up as thick, open the Edit-Objects dialog, select Lines, and turn on
<B>Thicken current contour</B>.)
Delete the contour with the "D" hot key.  You can also select multiple contours
by clicking additional ones with Ctrl-third mouse button, then delete them all
at once.  In addition, "Ctrl-A" will select all visible contours; this could
be useful when viewing only ones with the highest residuals in an area.
When finished, save the model and exit.  
Then press <B>Replace Patch Vectors</B> and <B>Restart at Matchorwarp</B>.

<LI> <I>Eliminate rows or columns.</I>  If the patch vector model indicates that bad patches are numerous near
edges of the volume, next explore whether omitting
a whole column or row of patches will give an acceptable fit to
the remaining patches.  To do this, make entries in the 
<B>Number of columns to exclude on ...</B> text boxes, press
<B>Matchorwarp Trial Run</B>, then examine the matchorwarp log file.
Do this repeatedly to assess different row or column exclusions.
If you find an exclusion that gives a good fit, and the excluded area is not
a critical area where you would expect a better fit, then proceed with this
exclusion.  Just press <B>Restart at Matchorwarp</B> to finish combining.

<LI> <I>Just go on.</I>  Sometimes the lowest mean residual that
Findwarp is able to achieve (the last message in matchorwarp.log saying
 "Findward failed to find
a warping with a mean residual below") is actually an acceptable value, just a
bit higher than the highest acceptable mean residual specified in
matchorwarp.com.  If
this is the case, just change the highest value in the <B>Warp limit</B>
text box to be higher than the value shown in this message.  Press
<B>Restart at Matchorwarp</B> and the combine should run to completion.

<LI> <I>Run Findwarp interactively.</I>  If all else fails, it may help to run 
<A HREF = "man/findwarp.html">Findwarp</A>
interactively.  This will allow you to explore omitting
columns or rows of patches as well as select the number of patches that will
be used in each local fit.
See the man page for 
<A HREF = "man/findwarp.html">Findwarp</A>.
When running the program, examine results with
transformations based on various subsets of patches, but no fewer than 3 by 3
by 2 or 4 by 2 by 2.  Try to retain all of the rows and columns if possible.
Use the largest subset of patches that will give a mean residual error under
about 0.3 pixels.  Save the transformations in a file named warp.xf.
Once you have done this, you can finish the combine operation by entering
<CODE><BR>
   subm warpvol volcombine
</CODE><BR>
</OL>

<P>
<A NAME = "Linen Pattern"><H4>
10.6. Linen Patterns in the Combined Tomogram
</A></H4>
Some combined tomograms show a pattern of vertically
and horizontally oriented lines that we refer to as "linen".  This pattern
can appear when the reconstructions are particularly noisy or when the
registration between them is not very good.  In a 2D Fourier transform, it
shows up as greater power near the X and Y axes than between the axes.
In the 3D Fourier transform, the pattern shows up as greater power in 
locations where
data were taken from only one tomogram (locations in the missing wedge of the
other tomogram) than in locations where data were averaged from the two
tomograms.  Apparently, when data from the
two tomograms do not agree very well, because of either noise or misalignment,
the averaging reduces the Fourier amplitude significantly.  The solution to
this problem is to reduce the amplitudes of data taken from only one tomogram
to match the amplitudes of data averaged from both.  Since this is a filtering
operation, it does not happen by default.
<P>
To reduce amplitudes, go to Advanced mode on the <B>Final Match</B> page
and enter 1 in the text box for <B>Reduction factor for matching amplitudes
in combined FFT</B>.  A value of 1 should improve the linen pattern;
smaller
or larger values will give less or more reduction.
See the man page for 
<A HREF = "man/combinefft.html">Combinefft</A> for more details.
Press <B>Restart at Volcombine</B> to recompute the combined volume.
<P>
If the text box is disabled, you have an older version of
volcombine.com.  To use the reduction, return to the <B>Setup</B>
page, recreate the combine
scripts, then restart at volcombine.com.
<P>
<A NAME = "Block Artifacts"><H4>
10.7. Block Artifacts in the Combined Tomogram
</A></H4>
Sometimes tomograms with large empty spaces will show borders between the
separately combined pieces in the light areas.  This happens because of a
mismatch between the very low frequency components in the adjacent pieces.
The problem can be solved by averaging very low frequency components from both
tomograms regardless of whether some of them are in the missing wedge of one
tomogram.  To enable this averaging, go to Advanced mode on the 
<B>Final Match</B> page and enter a value in the text box
for <B>Radius below which to average components from both tomograms</B>.
Values in the range of 0.01 to 0.015 have been effective in limited testing;
try them first then use a higher value if necessary.
<P>
<A NAME = "POST-PROCESSING"><H3>
11. POST-PROCESSING
</H3></A>

<P>
<A NAME = "Scaling and Trimming"><H4>
11.1. Scaling and Trimming a Tomogram
</A></H4>
The <B>Volume Trimming</B> section of the <B>Post-processing</B> panel
uses <A HREF = "man/trimvol.html">Trimvol</A> to
trim a volume and convert it to
bytes.  This shell script can run 
<A HREF = "man/findcontrast.html">Findcontrast</A>
to find optimal contrast settings for
converting it to bytes, runs Newstack to make the final byte file, and can
also use "clip flipyz" or "clip rotx" to reorient the data, which
will make the final volume easier to work with in <A HREF = "man/3dmod.html">3dmod</A>.  All of these
operations are performed with the default settings when you open the panel.
<P>
If you want to trim the volume in X and Y, you can use the rubberband feature
in the Zap window to draw a box around the region of interest and then have
eTomo collect this information.  
Press <B>3dmod Full Volume</B> to load the tomogram into <A HREF = 
"man/3dmod.html">3dmod</A>.  In <A HREF = "man/3dmod.html">3dmod</A>, 
press the
dotted rectangle in the Zap toolbar to turn on the rubberband.  Press the
first mouse button at the upper left corner of the desired area, and hold it
down while dragging to the lower right corner.  After the rubberband is set,
press <B>Get XY Volume Range from 3dmod</B> in the eTomo
<B>Post-processing</B> panel to fill in the <B>X min</B>, <B>X max</B>, 
<B>Y min</B>, and <B>Y max</B> text boxes in the <B>Volume Range</B> section.
If you want to trim the volume in
Z as well, fill in the <B>Z min</B> and <B>Z max</B> text boxes with the first
and last section that you want to keep.
<P>
The scaling of the tomogram to bytes requires some attention.  If you
simply convert a tomogram to bytes without a contrast setting, then the
contrast range for features of interest can be quite compressed and it can be
difficult to adjust contrast for viewing in <A HREF =
"man/3dmod.html">3dmod</A>.  You can avoid this problem
by saturating the intensities of gold particles (and other irrelevant features
like stain precipitate) when converting to bytes.  There are two different
methods for determining a good contrast scaling.
<P>
First, load the tomogram into <A HREF = "man/3dmod.html">3dmod</A> to
determine the starting and ending slices of a range that excludes features
whose intensity can be saturated.  
Select the <B>Find scaling from sections</B> radio button and 
enter these slice numbers into the associated <B>Z min</B> and <B>Z max</B>
text boxes in the <B>Scaling</B> section.  <A HREF =
"man/findcontrast.html">Findcontrast</A> will ignore areas
within 10% of the edges of these slices.  Sometimes this is not good enough to
exclude all the features that can be saturated.  If this is the case, then use
the rubberband to enclose an area that excludes all the extra-dense material
through the range of selected slices.  Then press 
<B>Get XY Sub-Area From 3dmod</B> to fill in the B>X min</B>, <B>X max</B>,
<B>Y min</B>, and <B>Y max</B> text boxes in the <B>Scaling from sub-area</B>
section.

<P>
Do not be satisfied if the trimmed volume does not have a good dynamic range
for specimen features, e.g., if it
requires Black and White sliders settings less than 100 units apart to get good
contrast in <A HREF = "man/3dmod.html">3dmod</A>.  This can happen if there
is gold or stain precipitate in the sampled slices.  When this happens, first
go back and set up a sub-area for scaling, as just described, or check the
area and make it smaller if you have already used one.  This should work, but
if not, there is an alternative approach: select
the <B>Scale to match contrast</B> radio button instead and find the
appropriate settings in <A HREF = "man/3dmod.html">3dmod</A>.
The simplest
way to do this is to adjust the Black and White sliders in <A HREF = "man/3dmod.html">3dmod</A> to
give the desired brightness and contrast
and enter the values in the <B>black</B> and <B>white</B> text boxes.  
However, this could truncate intensities inappropriately.  
For full control over the truncation of intensities, use the following
procedure.
Move both contrast sliders to
the same position.  While movieing through the data, adjust the positions of
both sliders together until only the gold beads (and other irrelevant
features) show up as black pixels; this slider value is the lower contrast
limit.  Then adjust both sliders so that only the overshoots around the beads
show up as white pixels; this slider value is the upper contrast limit.
Enter these
limits into the <B>black</B> and <B>white</B> text boxes.
<P>
<A NAME = "Reorienting"><H4>
11.2. Reorienting the Volume
</A></H4>
A final choice in the trimming step is how to reorient the volume.  Swapping Y
and Z dimensions will reproduce the flipping that 
<A HREF = "man/3dmod.html">3dmod</A> does
when it loads the untrimmed volumes that you have been looking at so far.
However, it will invert the handedness of structures relative to their
handedness in the untrimmed volume.  Rotating about X will preserve the
handedness.  If you care about handedness, you can use this choice to generate
a geometrically correct final volume.  If the original reconstruction has
correct handedness, choose <B>Rotate around X axis</B> to preserve handedness;
if it is inverted, choose <B>Swap Y and Z dimensions</B> to restore the true
handedness.
<P>
To make the right choice, however, you need to know whether the
original reconstruction is correct or inverted, which depends on 
whether the polarity of the tilt angles recorded from the microscope 
is appropriate given the tilt axis rotation angle used in the tilt series
alignment.  This can be determined by staring at the microscope, but an
empirical approach may be more reliable.  The easiest way is to take a tilt
series of a plastic section on formvar, with gold markers on both sides, so
that the formvar side can be distinguished in the reconstruction.  Place the
grid in the holder with a known orientation (e.g., section up), and note
whether the holder turns the grid upside down when it is inserted in the
microscope.  Now you know the orientation of the section and formvar in the
microscope. 
If the reconstruction has the same features at low Z as are located lower in
the microscope column, then it has correct handedness; otherwise it is
inverted.  This kind of careful assessment needs to be done only once for a
particular scope and acquisition software, or possibly twice if there are
magnification ranges where the images are turned by 90 degrees.
<P>
<A NAME = "Squeezing"><H4>
11.3. Squeezing a Tomogram
</A></H4>
     If your images were acquired on a CCD camera with limited spatial
resolution, you may be able to reduce the size of the final volume
considerably with no perceptible loss of image detail.  
The <B>Squeeze Volume</B> section of the <B>Post-processing</B> panel
provides an easy interface for scaling a volume down by
interpolation using 
<A HREF = "man/matchvol.html">Matchvol</A>.  The squeezing is specified
by two reduction factors, one applied in X and Y, the other applied in Z.
The default values are the same, but
since resolution is worse in the 
Z direction, it could be appropriate to squeeze the volume more in that
dimension.  For example, if the CCD camera provides no useful information
above 0.8 of Nyquist, an overall reduction by 1.2 or 1.25 would be
appropriate, and a reduction 1.3 times higher in the Z dimension would also be
appropriate
given the extra point-spread in that dimension in a tomographic
reconstruction.  Squeezing by 1.25 in X and Y and 1.62 in Z will reduce
the size of the volume by a factor of 2.5.  Squeezing isotropically by 1.2
will reduce the volume by a factor of 1.73.
<P>
Press <B>Squeeze Volume</B> to perform the operation on the trimmed volume.
The output file has the extension .sqz.
<P>
If you choose anistropic squeezing, you need to
increase the Z-scale that you use for viewing models built on that
volume
by the amount of extra squeezing in that dimension.  The Edit-Model-Header
dialog in 3dmod has features to make this easy.
For example, if
you have a Z-scale of 1.6 before squeezing, just check <B>Set incremental
Z-scale</B> and enter 1.6 in the <B>Added Z-scale</B> text box.
If instead you are
computing the Z-scale by comparing the thickness of the section in the
squeezed volume with the original thickness at which the section was cut, then
you need to make an entry in the <B>Total Z-scale</B> based on:
<pre>
   Z-scale = O / (S * P)
   where  O = original section thickness, in nm
          S = thickness of section in squeezed volume, in pixels 
          P = pixel size in X and Y after squeezing, in nm
</pre>
<P>
<A NAME = "Cleaning Up"><H3>
12. CLEAN UP
</A></H3>
Cleaning up your files is very important!  The
<B>Intermediate File Cleanup</B> panel makes cleanup easy.  The philosophy here
is to remove all intermediate image files and volcombine.log, but to
leave model files, command files, other log files, and files with
transformations and other information.  
To make it easier to
see which intermediate files will be deleted, do the cleanup in two
stages by first setting the <B>Files of Type</B> filter to <B>Backup
files</B>,
selecting all files in the window with Ctrl-A, and pressing <B>Delete
Selected</B>.  Next set the filter back to <B>Intermediate files</B>
and delete them, retaining some if desired.
<P>
If you want a copy of one
of the aligned tilt series, then before cleaning up, reduce this stack
to bytes and float the intensities with:
<BR><CODE>
     newstack -mo 0 -fl 2 setname.ali name_of_tilt_series_file
<BR></CODE>
<P>
Finally, archive and delete the raw image stacks.  If you lack the
ability to burn DVDs or your files are too big for a DVD, the shell script
<A HREF = "man/splitmrc.html">Splitmrc</A>
can be used to divide a very 
large MRC file into pieces that will fit
on multiple volumes; <A HREF = "man/recombine.html">Recombine</A>
can be used later to put the pieces back together.
