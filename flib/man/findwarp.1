     BBoouullddeerr LLaabboorraattoorryy ffoorr 33--DDiimmeennsssiioonnaall EElleeccttrroonn MMiiccrroossccooppyy ooff CCeellllss

FINDWARP(1)							   FINDWARP(1)

NNAAMMEE
	findwarp - to find a series of 3-D transformations to warp one volume
                   into alignment with another

SSYYNNOOPPSSIISS
	findwarp

DDEESSCCRRIIPPTTIIOONN
  FINDWARP will solve for a series of general 3-dimensional linear
  transformations that can then be used by WARPVOL to align two
  volumes to each other.  It performs a series of multiple linear
  regression on subsets of the displacements between the volumes
  determined at a matrix of positions (patches).  The displacements
  must be contained in a file with the following form: 

  Number of displacements
  One line for each displacement consisting of the X, Y, and Z
  .  coordinates in the first volume, then the displacements in X, Y
  .  and Z involved in moving from the first to the second volume
  
  If the program is run interactively, it loops on the specification
  of the subsets of displacements to use until the user decides to
  write out a particular subset.  However, it can also be told to find
  the best warping automatically, in which case it does so then exits.

  The program will automatically eliminate "outliers", patch
  displacements that are likely to be incorrect because they are so
  extreme, when compared to the rest of the displacements.  This
  elimination is conservative, but if for some reason it operates
  incorrectly, you can control the parameters of elimination or stop
  the elimination from occurring.  By default, the program will
  eliminate up to 10% of the patches from each local fit.
  
  The program also has two options for fitting to only a subset of the 
  data.  One option is to eliminate whole rows or columns of patches.
  The other is to use a model file to  specify which patches to
  include in the fit.  This model can be quite simple, consisting of
  just a single contour enclosing the region  where patches are
  generally good.  This contour can be drawn in any Z plane of the
  flipped tomogram.  However, if the good region changes through the
  depth of the tomogram, you can draw contours at several Z levels.
  If you have two layers of patches, draw two contours, one near the
  top and one near the bottom of the tomogram; if you have three
  layers, add another contour in the middle, etc.  For a given patch,
  the program will find the contour at the nearest Z level and use
  that one to determine whether to include the patch.

  In addition, the program will work with a patch file from which
  bad patches have been removed by hand.  This may become necessary
  if bad patches are too frequent in some location to be eliminated
  as outliers.  To use this feature, use Patch2imod to convert the
  patch file to a model file where displacements are represented
  by vectors, examine the file in 3dmod, eliminate aberrant contours,
  and convert the model file to a new patch file with Imod2patch.

  If there is only one layer of patches in the Y dimension, there is
  insufficient information to solve for the full transformation, so
  the program will solve for only two of the three columns of each
  local transformation matrix, and set the second column of each
  matrix to 0, 1, 0.  The same procedure is used if a particular
  local area does not have sufficient data on more than one layer in Y.

  Inputs to the program:
  
  Name of file with positions and displacements

  (At this point the program will report the number of patches in X, Y,
     and Z in this file, or complain if the data do not have the
     proper form.)
  
  Either the file name of one of the volumes, or the X, Y, and
     Z dimensions of the volumes.
  
  Name of an Imod model file with contours enclosing the patches to
     be included in the fit, or Return to use all patches.

  0 to proceed interactively, or 1 to find best warping automatically
  
  IF you enter 1, next enter:
  
     The target mean residual to achieve.

     The minimum and maximum ratio of measurements to unknowns to be
       allowed in the local fits, or / to use the default values.

  0 to use all of the data, or 1 to specify a subset of patches to use
  
  IF you enter 1, next enter three lines:
  
     Number of columns of patches to eliminate from the left and right
       sides of the data, 0,0 to use all patches in X, or / to use
       previous values.

     Number of slabs of patches to eliminate from the bottom and top
       of the section, 0,0 to use all patches in Y, or / to use
       previous values.

     Number of rows of patches to eliminate from the bottom and top
       (when viewing the flipped tomogram), 0,0 to use all patches in
       Z, or / to use previous values.

  IF you selected automatic warping, the program now proceeds by
     fitting to the largest possible area in X and Z that does not
     exceed the maximum ratio of measurements to unknowns, and it
     tries progressively smaller areas until the desired mean residual
     is achieved.  It does this using the parameters (e.g., row or
     column elimination) that were set on any previous interactive
     rounds of fitting.  If the target residual is reached, it
     requests the names of the initial transformation file and the
     output file, as described below, and exits.  If the residual is
     not reached, it exits with an error.
  
  IF you are proceeding interactively, continue with the following:

  IF there are more than 2 patches in Y, the program next asks whether
     you always want to do the local fits to all patches in Y.  Just
     enter 0 for the typical situation.
  
  0 to use default parameters for outlier elimination, or 1 to adjust
     any of these parameters.  Just enter 0 unless you know better.
  
  IF you enter 1, then make four entries, or / to take the default:
  
     Maximum fraction of patches to eliminate from each fit.  Set this
       to 0 to stop the outlier elimination from occurring.
  
     The minimum residual for elimination; patches with residuals
       smaller than this value will be retained no matter how extreme
       they are relative to the other patches.
  
     Criterion probability for patches to be considered candidates for
       for elimination.  A smaller value will eliminate fewer patches.
  
     Criterion probability for patches to be eliminated regardless of
       the pattern of outliers.  A higher value may force the
       elimination of more patches.

  Number of local patches in X and Z (or X, Y, and Z) to include in
     each fit. These values must be at least 2 and no larger than the
     total number of patches in the respective direction.
  
  The program will loop on the last entry until the same numbers are
  entered twice in a row (e.g. with a /).  If you enter 0 for the
  number of patches in X, it will loop back to the query about whether
  you want to find warping automatically.  When you do enter a /, 
  it will request:
  
  Name of file with initial 3D transformation that was applied to one
     of the volumes before the patch correlation, or Return if there
     was no such file.  

  Name of output file in which to place the transformations.  These
     will be inverse transformations, ready for use by WARPVOL.
  
  An exception to the above occurs if you specify that all available
  patches are to be used in a single fit.  You would do this if you
  just needed to eliminate a row or column of patches from the fit.
  In this case, when you enter a /, the program will simply ask for
  the name of a file in which to place the single refining
  transformation, just as with REFINEMATCH.

  For a given arrangement of patches, the program finds a mean and
  maximum residual for each of the fits.  It first reports which points
  have been eliminated as outliers, and in how many fits they appeared
  to be outliers.  On one line, it next reports the average and the
  maximum of the mean residuals.  On the next line, it reports the
  average and maximum of the maximum residuals.  The goal is to find
  an arrangement that contains as many patches as possible in each
  direction yet has residuals comparable to those found with a volume
  that does not need warping (typically 0.1 to 0.2).


HHIISSTTOORRYY
  Written by David Mastronarde  1/30/97
  12/24/98: added outlier elimination, integrated complex options.
  6/6/99: added ability to output single refining transformation.
  1/1/00: added model exclusion and automatic finding of best warp
  6/7/01: rewrote data input to handle data with missing patches
  7/20/02: rearranged input to make it easier to run automatically with
        rows or columns removed
